Ext.namespace("Mixky.plugins");Mixky.plugins.UploadButtonPlugin=function(a){Ext.apply(this,a);this.addEvents("swfUploadLoaded","fileDialogStart","startUpload","fileUploadError","fileUploadSuccess","fileUploadComplete","allUploadsComplete");Mixky.plugins.UploadButtonPlugin.superclass.constructor.call(this);this.initComponent()};
Ext.extend(Mixky.plugins.UploadButtonPlugin,Ext.util.Observable,{button:void 0,strings:{text_add:"\u6d4f\u89c8\u6587\u4ef6",text_upload:"\u4e0a\u4f20\u6587\u4ef6",text_cancel:"\u53d6\u6d88\u4e0a\u4f20",text_clear:"\u6e05\u9664\u961f\u5217",text_progressbar:"Progress Bar",text_remove:"\u79fb\u9664\u6587\u4ef6",text_remove_sure:"\u60a8\u786e\u5b9a\u8981\u4ece\u961f\u5217\u4e2d\u79fb\u9664\u6587\u4ef6\u4e48?",text_error:"Error",text_uploading:"\u6b63\u5728\u4e0a\u4f20\u6587\u4ef6: {0} ({1} of {2})",
header_filename:"\u6587\u4ef6\u540d\u79f0",header_size:"\u5927\u5c0f",header_status:"\u72b6\u6001",status:{0:"\u7b49\u5f85\u4e0a\u4f20",1:"\u6b63\u5728\u4e0a\u4f20...",2:"\u5b8c\u6210",3:"\u9519\u8bef",4:"\u5df2\u53d6\u6d88"},error_queue_exceeded:"\u4e00\u6b21\u6700\u591a\u4e0a\u4f20{0}\u4e2a\u6587\u4ef6.",error_queue_slots_0:"There is no slot left",error_queue_slots_1:"There is only one slot left",error_queue_slots_2:"There are only {0} slots left",error_size_exceeded:"\u4e0a\u4f20\u6587\u4ef6\u6700\u5927\u4e0d\u5141\u8bb8\u8d85\u8fc720 MB.",
error_zero_byte_file:"\u9009\u4e2d\u6587\u4ef6\u5927\u5c0f\u662f0\u5b57\u8282.",error_invalid_filetype:"\u9009\u4e2d\u7684\u6587\u4ef6\u7c7b\u578b\u65e0\u6548.",error_file_not_found:"\u6587\u4ef6\u6ca1\u6709\u627e\u5230 404.",error_security_error:"Security Error. Not allowed to post to different url."},file_types:"*.*",file_types_description:"\u6240\u6709\u6587\u4ef6",file_size_limit:"20MB",file_upload_limit:"0",file_queue_limit:"0",file_post_name:"Filedata",flash_url:"dependences/swfupload/swfupload.swf",
debug:!1,upload_cancelled:!1,initComponent:function(){var a=Ext.id(),b=this.button.el.child("em");b.setStyle({position:"relative",display:"block"});b.createChild({tag:"div",id:a});this.suo=new SWFUpload({button_placeholder_id:a,button_width:b.getWidth()+20,button_height:b.getHeight(),button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,upload_url:this.upload_url,post_params:this.post_params,file_post_name:this.file_post_name,file_size_limit:this.file_size_limit,
file_queue_limit:this.file_queue_limit,file_types:this.file_types,file_types_description:this.file_types_description,file_upload_limit:this.file_upload_limit,flash_url:this.flash_url,swfupload_loaded_handler:this.swfUploadLoaded.createDelegate(this),file_dialog_start_handler:this.fileDialogStart.createDelegate(this),file_queued_handler:this.fileQueue.createDelegate(this),file_queue_error_handler:this.fileQueueError.createDelegate(this),file_dialog_complete_handler:this.fileDialogComplete.createDelegate(this),
upload_start_handler:this.uploadStart.createDelegate(this),upload_progress_handler:this.uploadProgress.createDelegate(this),upload_error_handler:this.uploadError.createDelegate(this),upload_success_handler:this.uploadSuccess.createDelegate(this),upload_complete_handler:this.uploadComplete.createDelegate(this),debug:this.debug,debug_handler:this.debug?this.debugHandler:Ext.emptyFn});Ext.get(this.suo.movieName).setStyle({position:"absolute",top:0,left:0});this.rec=Ext.data.Record.create([{name:"name"},
{name:"size"},{name:"id"},{name:"type"},{name:"creationdate",type:"date",dateFormat:"m/d/Y"},{name:"status"}]);this.store=new Ext.data.Store({reader:new Ext.data.JsonReader({id:"id"},this.rec)})},formatProgressBar:function(a,b,c){switch(c.data.fileState){case SWFUpload.FILE_STATUS.COMPLETE:returnValue=Ext.isIE?'<div class="x-progress-wrap" style="height: 18px"><div class="x-progress-inner"><div style="width: 100%;" class="x-progress-bar x-progress-text">100 %':'<div class="x-progress-wrap" style="height: 18px"><div class="x-progress-inner"><div id="progressBar_'+
c.data.id+'" style="width: 100%;" class="x-progress-bar"></div><div id="progressText_'+c.data.id+'" style="width: 100%;" class="x-progress-text x-progress-text-back" />100 %</div>';break;default:returnValue='<div class="x-progress-wrap" style="height: 18px"><div class="x-progress-inner"><div id="progressBar_'+c.data.id+'" style="width: 0%;" class="x-progress-bar"></div><div id="progressText_'+c.data.id+'" style="width: 100%;" class="x-progress-text x-progress-text-back" />0 %</div>'}return returnValue},
formatStatus:function(a){return this.strings.status[a]},formatBytes:function(a){a||(a=0);for(var b=a,a=parseInt(a,10),b=0;a/1024>1;)a/=1024,b++;return b=Math.round(a)+" "+["B","KB","MB","GB"][b]},debugHandler:function(a){console.log(a)},swfUploadLoaded:function(){this.debug&&console.info("SWFUPLOAD LOADED");this.fireEvent("swfUploadLoaded",this)},fileDialogStart:function(){this.debug&&console.info("FILE DIALOG START");this.store.removeAll();this.store.commitChanges();this.fireEvent("fileDialogStart",
this)},fileQueue:function(a){this.debug&&console.info("FILE QUEUE");a.status=0;r=new this.rec(a);r.id=a.id;this.store.add(r);this.fireEvent("fileQueued",this,a)},fileQueueError:function(a,b,c){this.debug&&console.info("FILE QUEUE ERROR");switch(b){case -100:switch(c){case "0":c=this.strings.error_queue_slots_0;break;case "1":c=this.strings.error_queue_slots_1;break;default:c=String.format(this.strings.error_queue_slots_2,c)}Ext.MessageBox.alert(this.strings.text_error,String.format(this.strings.error_queue_exceeded+
" "+c,this.file_queue_limit));break;case -110:Ext.MessageBox.alert(this.strings.text_error,String.format(this.strings.error_size_exceeded,this.formatBytes(this.file_size_limit*1024)));break;case -120:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_zero_byte_file);break;case -130:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_invalid_filetype)}this.fireEvent("fileQueueError",this,a,b)},fileDialogComplete:function(a){this.debug&&console.info("FILE DIALOG COMPLETE");
a>0&&this.startUpload();this.fireEvent("fileDialogComplete",this,a)},uploadStart:function(a){this.debug&&console.info("UPLOAD START");this.fireEvent("uploadStart",this,a);return!0},progressCount:0,uploadProgress:function(a,b,c){var d=Math.ceil(b/c*100);if(d!=this.progressCount)Ext.getDom("progressBar_"+a.id).style.width=d+"%",Ext.getDom("progressText_"+a.id).innerHTML=d+" %",this.progressCount=d;this.store.getById(a.id).set("status",1);this.fireEvent("uploadProgress",this,a,b,c)},uploadError:function(a,
b,c){this.debug&&console.info("UPLOAD ERROR");if(c==500)Ext.MessageBox.alert(this.strings.text_error,"File too big");else switch(b){case -200:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_file_not_found);break;case -230:Ext.MessageBox.alert(this.strings.text_error,this.strings.error_security_error);break;case -290:this.store.getById(a.id).set("status",4),this.store.getById(a.id).commit()}this.fireEvent("fileUploadError",this,a,b,c)},uploadSuccess:function(a,b){this.debug&&console.info("UPLOAD SUCCESS");
var c=Ext.decode(b);c.success?(this.store.getById(a.id).data.fileState=SWFUpload.FILE_STATUS.COMPLETE,this.store.getById(a.id).set("status",2)):(this.store.getById(a.id).set("status",3),this.store.getById(a.id).commit(),c.msg&&Ext.MessageBox.alert(this.strings.text_error,c.msg));this.fireEvent("fileUploadSuccess",this,a,c)},uploadComplete:function(a){this.debug&&console.info("UPLOAD COMPLETE");this.suo.getStats().files_queued&&!this.upload_cancelled?this.suo.startUpload():(this.fireEvent("fileUploadComplete",
this,a),this.allUploadsComplete())},allUploadsComplete:function(){this.uploadDialog.close();this.fireEvent("allUploadsComplete",this)},addPostParam:function(a,b){this.suo?(this.suo.settings.post_params[a]=b,this.suo.setPostParams(this.suo.settings.post_params)):this.post_params[a]=b},startUpload:function(){this.debug&&console.info("START UPLOAD");this.upload_cancelled=!1;this.uploadFileGrid=new Ext.grid.GridPanel({autoExpandColumn:"name",enableColumnResize:!1,enableColumnMove:!1,store:this.store,
columns:[{id:"name",header:this.strings.header_filename,dataIndex:"name"},{id:"size",header:this.strings.header_size,width:80,dataIndex:"size",renderer:this.formatBytes},{id:"status",header:this.strings.header_status,width:100,dataIndex:"status",renderer:this.formatStatus.createDelegate(this)},{id:"progress",header:"",width:150,renderer:this.formatProgressBar}]});var a=void 0;Ext.isDefined(MixkyApp)&&Ext.isDefined(MixkyApp.desktop)&&(a=MixkyApp.desktop.getManager());this.uploadDialog=new Ext.Window({layout:"fit",
width:400,height:300,modal:!0,manager:a,maximizable:!1,minimizable:!1,closable:!1,resizable:!1,iconCls:"icon-sys-upload",title:this.strings.text_upload,items:this.uploadFileGrid,buttons:[{text:this.strings.text_cancel,iconCls:"icon-sys-cancel",handler:this.stopUpload.createDelegate(this),scope:this}]});this.uploadDialog.show();this.fireEvent("startUpload",this);this.suo.startUpload()},stopUpload:function(){this.debug&&console.info("STOP UPLOAD");this.suo.stopUpload();this.upload_cancelled=!0;this.uploadDialog.close();
this.fireEvent("allUploadsComplete",this)},setButtonDisabled:function(a){this.suo.getMovieElement().style.display=a?"none":""},show:function(){this.single_select?this.suo.selectFile():this.suo.selectFiles()}});Mixky.plugins.UploadButton=function(a){Ext.apply(this,a);Mixky.plugins.UploadButton.superclass.constructor.call(this)};
Ext.extend(Mixky.plugins.UploadButton,Ext.Button,{uploadConfig:void 0,initComponent:function(){Mixky.plugins.UploadButton.superclass.initComponent.call(this);this.on("afterrender",function(){var a=Ext.apply({button:this},this.uploadConfig);this.uploadPlugin=new Mixky.plugins.UploadButtonPlugin(a)})},disable:function(){this.uploadPlugin.setButtonDisabled(!0);Mixky.plugins.UploadButton.superclass.disable.call(this)},enable:function(){this.uploadPlugin.setButtonDisabled(!1);Mixky.plugins.UploadButton.superclass.enable.call(this)},
beginUpload:function(){this.uploadPlugin.show()}});Ext.reg("mixkyuploadbutton",Mixky.plugins.UploadButton);Ext.ns("Mixky.wasoft.favorite");Mixky.wasoft.favorite.FavoriteColumn=function(a){Ext.apply(this,a);if(!this.id)this.id=Ext.id();this.renderer=this.renderer.createDelegate(this)};
Mixky.wasoft.favorite.FavoriteColumn.prototype={init:function(a){this.grid=a;this.grid.on("render",function(){this.grid.getView().mainBody.on("mousedown",this.onMouseDown,this)},this)},onMouseDown:function(a,b){if(b.className&&b.className.indexOf("x-grid3-cc-"+this.id)!=-1){a.stopEvent();var c=this.grid.getView().findRowIndex(b),d=this.grid.getStore().getAt(c),e=0;d.data[this.dataIndex]==0&&(e=1);var c=d.data[this.titleFieldName],f=this.documenttypekey,g=d.get("ID");this.documenttypekey=="mkFavorite.dtFavorite"&&
(f=d.get("F_SOURCE_KEY"),g=d.get("F_SOURCE_PARAM"));var h=this;Mixky.wasoft.lib.updateFavorite(this.applicationkey,f,g,c,e,function(){d.set(h.dataIndex,e);d.commit()})}},renderer:function(a,b){b.css+=" x-grid3-check-col-td";return'<div class="x-grid3-check-col'+(a>0?"-on":"")+" x-grid3-cc-"+this.id+" mixky-favorite-"+(a>0?"on":"off")+'">&#160;</div>'}};Ext.ns("Ext.ux.grid");Ext.ux.grid.RowOrderColumn=function(a){Ext.apply(this,a);if(this.rowspan)this.renderer=this.renderer.createDelegate(this)};Ext.ux.grid.RowOrderColumn.prototype={header:"",width:23,sortable:!1,fixed:!0,menuDisabled:!0,dataIndex:"f_order",id:"f_order",rowspan:void 0,renderer:function(a,b,c,d){if(this.rowspan)b.cellAttr='rowspan="'+this.rowspan+'"';c.set("f_order",d+1);return d+1}};Ext.namespace("Mixky.editor");Mixky.editor.RowNumberer=Ext.extend(Object,{header:"",width:35,sortable:!1,constructor:function(a){Ext.apply(this,a);if(this.rowspan)this.renderer=this.renderer.createDelegate(this)},fixed:!0,menuDisabled:!0,dataIndex:"",id:"numberer",rowspan:void 0,renderer:function(a,b,c,d){if(this.rowspan)b.cellAttr='rowspan="'+this.rowspan+'"';a=c.get("rowstate");a==""&&c.dirty&&(a="edit");return String.format("<div class='mixky-editor-rownumberer-{0}'> {1}</div>",a,d+1)}});
