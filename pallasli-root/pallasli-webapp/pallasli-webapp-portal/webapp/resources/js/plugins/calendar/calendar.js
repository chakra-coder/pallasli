Ext.ns("Ext.ux.calendar");Ext.ux.calendar.DataSource=function(a){Ext.apply(this,a);Ext.ux.calendar.DataSource.superclass.constructor.call(this)};
Ext.extend(Ext.ux.calendar.DataSource,Ext.util.Observable,{showAllCalendar:function(a,b){CalendarAppDirect.showAllTag(this.key,function(c,d){c&&c.success?a.call(b||this,c):MixkyApp.showDirectActionFail("\u663e\u793a\u6240\u6709\u5206\u7c7b\u9879",c,d)})},showOnlyCalendar:function(a,b,c){CalendarAppDirect.showOnlyTag(this.key,a,function(a,e){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u4ec5\u663e\u793a\u5206\u7c7b\u9879",a,e)})},createUpdateCalendar:function(a,b,c){a.id===0?MixkyApp.showErrorMessage("\u4e0d\u5141\u8bb8\u4fee\u6539\u7cfb\u7edf\u9ed8\u8ba4\u6807\u7b7e",
"\u9519\u8bef\u63d0\u793a"):(a.hide=a.hide?1:0,CalendarAppDirect.updateTag(this.key,a,function(a,e){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u6dfb\u52a0/\u66f4\u65b0\u5206\u7c7b\u9879",a,e)}))},deleteEventsByCalendar:function(a,b,c){CalendarAppDirect.deleteEventsByTag(this.key,a,function(a,e){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u6e05\u7a7a\u5206\u7c7b\u9879\u65e5\u7a0b\u4fe1\u606f",a,e)})},deleteCalendar:function(a,b,c){a==0?MixkyApp.showErrorMessage("\u4e0d\u5141\u8bb8\u5220\u9664\u7cfb\u7edf\u9ed8\u8ba4\u6807\u7b7e",
"\u9519\u8bef\u63d0\u793a"):CalendarAppDirect.deleteTag(this.key,a,function(a,e){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u5220\u9664\u5206\u7c7b\u9879\u65e5\u7a0b\u4fe1\u606f",a,e)})},loadCalendar:function(a,b){var c=this;CalendarAppDirect.loadTags(this.key,function(a,e){a&&a.success?(c.initCalendarColor(a.results),sucessFn.call(b||this,a)):MixkyApp.showDirectActionFail("\u5220\u9664\u5206\u7c7b\u9879\u65e5\u7a0b\u4fe1\u606f",a,e)})},loadEvent:function(a,b,c,d){a=a||new Date;
b=b||new Date;a=a.format("Y-m-d");b=b.format("Y-m-d");CalendarAppDirect.loadEvents(this.key,a,b,function(a,b){if(a&&a.success){for(var f=a.results,h={whole:[]},i=Ext.ux.calendar.Mask.getRowFromHM,j=0,n=f.length;j<n;j++){var k=f[j],m=i(k.startTime,this.intervalSlot),o=i(k.endTime,this.intervalSlot);if(!this.hideInactiveRow||this.activeStartRow<=m&&o<=this.activeEndRow||0==m&&this.rowCount==o){var l=k.ymd,p=k.eymd;h[l]=h[l]||[];b={eventId:k.id,calendarId:k.calendarId,color:k.color,startRow:m,endRow:o,
subject:k.subject,content:k.description,day:l,eday:p,alertFlag:k.alertFlag,locked:k.locked,repeatType:k.repeatType};l!=p||0==m&&this.rowCount==o?h.whole.push(b):(h[l]=h[l]||[],h[l].push(b))}}c.call(d||this,h)}else MixkyApp.showDirectActionFail("\u88c5\u8f7d\u65e5\u7a0b\u4fe1\u606f",a,b)})},loadRepeatEvent:function(a,b){CalendarAppDirect.loadRepeatEvents(this.key,function(c,d){if(c&&c.success){for(var e=c.results,g={},f=Ext.ux.calendar.Mask.getRowFromHM,h=0,i=e.length;h<i;h++){var j=e[h],n=f(j.startTime,
b.intervalSlot),k=f(j.endTime,b.intervalSlot),j={eventId:j.id,calendarId:j.calendarId,color:j.color,startRow:n,endRow:k,subject:j.subject,content:j.description,repeatType:j.repeatType,alertFlag:j.alertFlag,locked:j.locked};g[j.eventId]=j}a.call(b||this,g)}else MixkyApp.showDirectActionFail("\u88c5\u8f7d\u91cd\u590d\u65e5\u7a0b\u9879\u4fe1\u606f",c,d)})},createEvent:function(a,b,c){var d=a.day||(new Date).format("Y-m-d"),a={id:0,calendarId:a.calendarId,startDay:d,endDay:a.eday||d,startTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,
a.startRow),endTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,a.endRow),repeatType:a.repeatType,alertFlag:a.alertFlag?1:0,locked:a.locked?1:0,subject:a.subject,description:a.content};CalendarAppDirect.updateEvent(this.key,a,function(a,d){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u6dfb\u52a0\u65e5\u7a0b",a,d)})},updateEvent:function(a,b,c){var d=a.day||(new Date).format("Y-m-d"),a={id:a.eventId,calendarId:a.calendarId,startDay:d,endDay:a.eday||d,startTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,
a.startRow),endTime:Ext.ux.calendar.Mask.getIntervalFromRow(c.intervalSlot,a.endRow),repeatType:a.repeatType,oldRepeatType:a.oldRepeatType,alertFlag:a.alertFlag?1:0,locked:a.locked?1:0,subject:a.subject,description:a.content};CalendarAppDirect.updateEvent(this.key,a,function(a,d){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u66f4\u65b0\u65e5\u7a0b",a,d)})},deleteEvent:function(a,b,c){CalendarAppDirect.deleteEvent(this.key,a.eventId,function(a,e){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u5220\u9664\u65e5\u7a0b",
a,e)})},deleteRepeatEvent:function(a,b,c,d){CalendarAppDirect.deleteRepeatEvent(this.key,a.eventId,b,a.repeatType,function(a,b){a&&a.success?c.call(d||this,a):MixkyApp.showDirectActionFail("\u5220\u9664\u53ef\u91cd\u590d\u65e5\u7a0b",a,b)})},changeDay:function(a,b,c,d,e){CalendarAppDirect.changeDay(this.key,a,b,e,function(a,b){a&&a.success?c.call(d||this,a):MixkyApp.showDirectActionFail("\u590d\u5236/\u7c98\u5e16\u65e5\u7a0b",a,b)})},deleteDay:function(a,b,c){Ext.Msg.confirm("\u5371\u9669\u64cd\u4f5c\u63d0\u793a",
"\u5220\u9664"+a+"\u6240\u6709\u65e5\u7a0b\uff0c\u60a8\u786e\u5b9a\u5417\uff1f",function(d){d=="yes"&&CalendarAppDirect.deleteDay(this.key,a,function(a,d){a&&a.success?b.call(c||this,a):MixkyApp.showDirectActionFail("\u5220\u9664\u65e5\u7a0b",a,d)})},this)},createUpdateRepeatEvent:function(a,b,c,d){var e=Ext.ux.calendar.Mask.getIntervalFromRow(d.intervalSlot,a.startRow),g=Ext.ux.calendar.Mask.getIntervalFromRow(d.intervalSlot,a.endRow),e={calendarId:a.calendarId,startDay:a.day,endDay:a.eday,startTime:e,
endTime:g,repeatType:"string"==Ext.type(a.repeatType)?a.repeatType:Ext.encode(a.repeatType),alertFlag:a.alertFlag?1:0,locked:a.locked?1:0,subject:a.subject,description:a.content};if(b)e.oldRepeatType="string"==Ext.type(b.repeatType)?b.repeatType:Ext.encode(b.repeatType);if("prepare"!=a.eventId)e.id=a.eventId;if(b)e.oldRepeatType="string"==Ext.type(b.repeatType)?b.repeatType:Ext.encode(b.repeatType);CalendarAppDirect.updateRepeatEvent(this.key,e,function(a,b){a&&a.success?c.call(d||this,a):MixkyApp.showDirectActionFail("\u521b\u5efa\u66f4\u65b0\u91cd\u590d\u65e5\u7a0b",
a,b)})},initialLoad:function(a,b,c){var d=this;CalendarAppDirect.initialLoad(this.key,function(a,g){if(a&&a.success){var f=a.cs[0],f=Ext.ux.calendar.Mask.calculateActiveRow(f);Ext.apply(this,f);a.cs=f;var f=a.re,h={},i=Ext.ux.calendar.Mask.getRowFromHM;d.initCalendarColor(a.owned);for(var j=0,n=f.length;j<n;j++){var k=f[j],m=i(k.startTime,this.intervalSlot),o=i(k.endTime,this.intervalSlot),g={eventId:k.id,calendarId:k.calendarId,color:k.color,startRow:m,endRow:o,subject:k.subject,content:k.description,
repeatType:k.repeatType,alertFlag:k.alertFlag,locked:k.locked};h[g.eventId]=g}a.re=h;b.call(c||this,a)}else MixkyApp.showDirectActionFail("\u521d\u59cb\u5316\u88c5\u8f7d",a,g)})},getSearchStore:function(){if(!this.searchStore)this.searchStore=new Ext.data.GroupingStore({proxy:new Ext.data.DirectProxy({paramsAsHash:!0,paramOrder:["key","text","start","limit"],directFn:CalendarAppDirect.searchEvents}),baseParams:{key:this.key},reader:new Ext.data.JsonReader({root:"results",id:"id",totalProperty:"totals"},
[{name:"id"},{name:"calendarId"},{name:"startTime"},{name:"endTime"},{name:"subject"},{name:"description"},{name:"ymd"},{name:"eymd"},{name:"color"},{name:"isShared"},{name:"alertFlag"},{name:"locked"},{name:"repeatType"}]),sortInfo:{field:"ymd",direction:"DESC"},groupField:"ymd"});return this.searchStore},initCalendarColor:function(a){for(var b=Ext.ux.calendar.Mask.colorIndex.length,c=0;c<a.length;c++)if(!a[c].color||a[c].color=="")a[c].color=Ext.ux.calendar.Mask.colorIndex[c%b]}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.BackThread=function(a){Ext.apply(this,a);this.runner=new Ext.util.TaskRunner;this.timelineTask={run:function(a){a=a.mainPanel.calendarContainer.getLayout().activeItem;a instanceof Ext.ux.calendar.DayView?(a.setToday(),a.updateTimeline()):a instanceof Ext.ux.calendar.MonthView&&a.setToday()},args:[this.ehandler],interval:6E4};this.expireTask={run:function(a){a=a.mainPanel.calendarContainer.getLayout().activeItem;a instanceof Ext.ux.calendar.ResultView&&a.list.getView().refresh()},args:[this.ehandler],
interval:18E5};Ext.ux.calendar.BackThread.superclass.constructor.call(this);this.runner.start(this.timelineTask)};Ext.extend(Ext.ux.calendar.BackThread,Ext.util.Observable,{destroy:function(){this.runner.stopAll()}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.BasicView=Ext.extend(Ext.Panel,{daySet:[],checkLayout:Ext.emptyFn,renderEvent:Ext.emptyFn,resetSCover:Ext.emptyFn,resizePort:Ext.emptyFn});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CalendarContainer=function(a){Ext.apply(this,a);var b=this.ehandler,a=b.calendarSetting,b=b.lang.CalendarContainer,c=new Date;this.endDate=this.startDate=c;this.dayView=new Ext.ux.calendar.DayView({dayFormat:a.dayFormat,offsetPercent:0.05,shiftDay:1,dayNum:1,startColIndex:0,endColIndex:1,ehandler:this.ehandler});this.weekView=new Ext.ux.calendar.DayView({dayFormat:a.weekFormat,offsetPercent:0.1,shiftDay:7,dayNum:7,startColIndex:0,endColIndex:7,ehandler:this.ehandler});this.weekOnlyView=
new Ext.ux.calendar.DayView({dayFormat:a.weekFormat,offsetPercent:0.1,dayNum:5,shiftDay:7,startColIndex:0,endColIndex:5,ehandler:this.ehandler});this.monthView=new Ext.ux.calendar.MonthView({dayFormat:a.monthFormat,dayNum:7,shiftDay:7,startColIndex:0,endColIndex:7,ehandler:this.ehandler});this.resultView=new Ext.ux.calendar.ResultView({ehandler:this.ehandler});this.detailEditor=new Ext.ux.calendar.DetailEditor({ehandler:this.ehandler});this.backBtn=new Ext.Button({iconCls:"icon-sys-calendar-back",
handler:this.onBackFn,scope:this});this.nextBtn=new Ext.Button({iconCls:"icon-sys-calendar-next",handler:this.onNextFn,scope:this});this.todayBtn=new Ext.Button({text:b["todayBtn.text"],iconCls:"icon-sys-calendar-today",handler:this.onTodayFn,scope:this});this.refreshBtn=new Ext.Button({iconCls:"x-tbar-loading",handler:this.onRefreshFn,scope:this});this.dayBtn=new Ext.Button({iconCls:"icon-sys-calendar-dayview",text:b["dayBtn.text"],handler:this.onDayFn,scope:this});this.weekMenu=new Ext.menu.Menu({items:[{text:b["weekMenu.showAll.text"],
checked:!0,group:"week",handler:this.onWeekAllFn,scope:this},{text:b["weekMenu.onlyWeek.text"],checked:!1,group:"week",handler:this.onWeekOnlyFn,scope:this}]});this.weekBtn=new Ext.SplitButton({iconCls:"icon-sys-calendar-weekview",text:b["weekBtn.text"],pressed:!0,arrowAlign:"right",menu:this.weekMenu,handler:this.onWeekFn,scope:this});this.monthMenu=new Ext.menu.Menu({items:[{text:b["monthMenu.showAll.text"],checked:!0,group:"month",handler:this.onMonthAllFn,scope:this},{text:b["monthMenu.onlyWeek.text"],
checked:!1,group:"month",handler:this.onMonthOnlyFn,scope:this}]});this.monthBtn=new Ext.SplitButton({iconCls:"icon-sys-calendar-monthview",text:b["monthBtn.text"],arrowAlign:"right",menu:this.monthMenu,handler:this.onMonthFn,scope:this});this.searchField=new Ext.form.TextField({width:250,listeners:{specialkey:{fn:function(a,b){if(b.getKey()==b.ENTER)this.onSearchFn()},scope:this}}});this.searchBtn=new Ext.Button({iconCls:"icon-sys-calendar-search",handler:this.onSearchFn,scope:this});Ext.ux.calendar.CalendarContainer.superclass.constructor.call(this,
{border:!1,region:"center",cls:"x-calendar-container",layout:"card",layoutConfig:{deferredRender:!0},activeItem:1,items:[this.dayView,this.weekView,this.monthView,this.resultView,this.weekOnlyView,this.detailEditor],tbar:[this.backBtn,this.nextBtn,this.todayBtn,"-",b["searchCriteria.text"],this.searchField,this.searchBtn,"->",this.refreshBtn,"-",this.dayBtn,"-",this.weekBtn,"-",this.monthBtn,"-"]});this.addEvents("refresh","editcalendar");this.currentView=this.weekView;this.currentIdx=1;this.currentView.on("afterresize",
this.onAfterResizeFn,this,{single:!0});this.weekView.on("viewDay",this.onDayChangeFn,this);this.weekOnlyView.on("viewDay",this.onDayChangeFn,this);this.monthView.on("viewDay",this.onDayChangeFn,this);this.monthView.on("viewWeek",this.onWeekChangeFn,this);this.dayView.on("viewWeek",this.onWeekChangeFn,this);this.relayEvents(this.dayView,["beforeremoteload","remoteload","hideeditor"]);this.relayEvents(this.weekView,["beforeremoteload","remoteload","hideeditor"]);this.relayEvents(this.weekOnlyView,["beforeremoteload",
"remoteload","hideeditor"]);this.relayEvents(this.monthView,["beforeremoteload","remoteload","hideeditor"]);this.dayView.relayEvents(this,["canceldetail"]);this.weekView.relayEvents(this,["canceldetail"]);this.weekOnlyView.relayEvents(this,["canceldetail"]);this.monthView.relayEvents(this,["canceldetail"]);this.on("mousedown",this.onMMouseDownFn,this);this.on("showdetailsetting",this.onShowDetailSettingFn,this);this.on("refresh",this.refresh,this)};
Ext.extend(Ext.ux.calendar.CalendarContainer,Ext.Panel,{onAfterResizeFn:function(){try{this.ehandler.fireEvent("calendarloaded")}catch(a){}},onShowDetailSettingFn:function(a){this.getLayout().setActiveItem(5);this.detailEditor.setup(a)},onBackFn:function(){var a=this.currentView;this.getLayout().setActiveItem(this.currentIdx);a.goBack();this.changeLabel(a)},onNextFn:function(){var a=this.currentView;this.getLayout().setActiveItem(this.currentIdx);a.goNext();this.changeLabel(a)},onTodayFn:function(){this.showDay(new Date)},
onDayFn:function(a){if(this.currentView!=this.dayView)this.showPressed(a),a=this.dayView,this.getLayout().setActiveItem(0),a.showRange(this.startDate,this.endDate),this.changeLabel(a)},onWeekFn:function(a){if(!0===a.weekdayFlag)this.onWeekOnlyFn();else if(this.currentView!=this.weekView)this.onWeekAllFn()},onWeekAllFn:function(){if(this.currentView!=this.weekView){var a=this.weekView;this.weekBtn.weekdayFlag=!1;this.showPressed(this.weekBtn);this.getLayout().setActiveItem(1);a.showRange(this.startDate,
this.endDate,!0);this.changeLabel(a)}},onWeekOnlyFn:function(){if(this.currentView!=this.weekOnlyView){this.weekBtn.weekdayFlag=!0;this.showPressed(this.weekBtn);var a=this.weekOnlyView;this.getLayout().setActiveItem(4);a.showRange(this.startDate,this.endDate,!0);this.changeLabel(a)}},onMonthFn:function(a){if(!0==a.weekdayFlag)this.onMonthOnlyFn();else this.onMonthAllFn()},onMonthAllFn:function(){var a=this.monthView;this.monthBtn.weekdayFlag=!1;this.currentView!=this.monthView?(this.showPressed(this.monthBtn),
this.getLayout().setActiveItem(2),a.startColIndex=0,a.endColIndex=7,a.colNum=7,a.showRange(this.startDate,this.endDate),this.changeLabel(a)):(a.startColIndex=0,a.endColIndex=7,a.colNum=7,a.cleanup(),a.recalculateSize(a.body.getWidth(),a.body.getHeight()),a.showCache())},onMonthOnlyFn:function(){var a=this.monthView;this.monthBtn.weekdayFlag=!0;var b=1==a.startDay?1:0;this.currentView!=this.monthView?(this.showPressed(this.monthBtn),this.getLayout().setActiveItem(2),a.colNum=5,a.startColIndex=1-b,
a.endColIndex=6-b,a.showRange(this.startDate,this.endDate),this.changeLabel(a)):(a.colNum=5,a.startColIndex=1-b,a.endColIndex=6-b,a.cleanup(),a.recalculateSize(a.body.getWidth(),a.body.getHeight()),a.showCache())},showPressed:function(a){this.dayBtn.el.removeClass("x-btn-pressed");this.weekBtn.el.removeClass("x-btn-pressed");this.monthBtn.el.removeClass("x-btn-pressed");a.el.addClass("x-btn-pressed");if(a==this.dayBtn)this.currentIdx=0,this.currentView=this.dayView;else if(a==this.weekBtn)!0!==this.weekBtn.weekdayFlag?
(this.currentIdx=1,this.currentView=this.weekView):(this.currentIdx=4,this.currentView=this.weekOnlyView);else if(a==this.monthBtn||a==this.monthOnlyBtn)this.currentIdx=2,this.currentView=this.monthView},showDay:function(a){var b=this.currentView;this.getLayout().setActiveItem(this.currentIdx);b.showDay(a);this.changeLabel(b)},showSingleDay:function(a){var b=this.dayView;b.daySet[0]=a;this.currentView!=this.dayView&&(this.showPressed(this.dayBtn),this.getLayout().setActiveItem(0),b.resetView(),b.fireEvent("checklayout",
!0),this.changeLabel(b))},onDayChangeFn:function(a,b){this.showSingleDay(b)},onWeekChangeFn:function(a){this.showPressed(this.weekBtn);var b=this.currentView;this.getLayout().setActiveItem(this.currentIdx);b.showDay(a);this.changeLabel(b)},changeLabel:function(a){this.startDate=a.daySet[0];this.endDate=a.daySet[a.daySet.length-1];this.fireEvent("changedate",this.startDate,this.endDate)},onSearchFn:function(){var a=this.resultView;this.getLayout().setActiveItem(3);a.list.getStore().removeAll();a.loadEvents.defer(1,
a,[this.searchField.getValue()])},onCalendarLoadedFn:function(){this.currentView.checkLayout(!0)},onRefreshFn:function(){this.refresh()},refresh:function(a){var b=this.ehandler,c=this.ownerCt.westPanel,d,e;if(c.myCalendarPanel)d=c.myCalendarPanel.body;if(c.otherCalendarPanel)e=c.otherCalendarPanel.body;b.fireEvent("reloadCalendar",d,e,a)},onMMouseDownFn:function(){this.fireEvent("canceldetail");this.fireEvent("hideeditor")}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CalendarEditor=function(a){Ext.apply(this,a);a=this.ehandler.lang.CalendarEditor;this.nameField=new Ext.form.TextField({name:"name",fieldLabel:a["nameField.label"],allowBlank:!1,anchor:"99%"});this.descriptionField=new Ext.form.TextArea({name:"description",fieldLabel:a["descriptionField.label"],anchor:"99%"});this.colorField=new Ext.ColorPalette({});this.colorField.on("select",this.onColorSelectFn,this);this.colorField.colors=Ext.ux.calendar.Mask.colors;this.clearBtn=new Ext.Button({iconCls:"icon-sys-calendar-delete",
minWidth:80,text:a["clearBtn.text"],handler:this.onClearFn,scope:this});this.saveBtn=new Ext.Button({iconCls:"icon-sys-calendar-accept",minWidth:80,text:a["saveBtn.text"],handler:this.onSaveFn,scope:this});this.cancelBtn=new Ext.Button({iconCls:"icon-sys-calendar-cancel",minWidth:80,text:a["cancelBtn.text"],handler:this.onCancelFn,scope:this});this.formpanel=new Ext.form.FormPanel({cls:"x-calendar-menu",border:!1,style:"padding:10px;",labelWidth:70,items:[this.nameField,this.descriptionField,{border:!1,
style:"padding-left:60px;",items:[this.colorField]}],buttonAlign:"right",buttons:[this.clearBtn,this.saveBtn,this.cancelBtn]});Ext.ux.calendar.CalendarEditor.superclass.constructor.call(this,{width:500,height:200,closable:!1,closeAction:"hide",layout:"fit",modal:!0,resizable:!1,items:[{border:!1,layout:"fit",items:[this.formpanel]}]})};
Ext.extend(Ext.ux.calendar.CalendarEditor,Ext.Window,{onColorSelectFn:function(a,b){this.color=Ext.ux.calendar.Mask.getIndexByColor(b)},popup:function(a){var c;this.action=a.action;this.show();var b=this.ehandler.lang.CalendarEditor;"add"==a.action?(this.setTitle(b["new.title"]),this.setIconClass("icon-sys-calendar-calendar")):(this.setTitle(b["edit.title"]),this.setIconClass("icon-sys-calendar-calendar_edit"));this.calendarEl=a.cEl?a.cEl:null;b=Ext.ux.calendar.Mask;a.data?(c=this.calendar=a.data,
a=c,this.nameField.setValue(a.name),this.descriptionField.setValue(a.description),(a=Ext.ux.calendar.Mask.getColorByIndex(a.color))?this.colorField.select(a):this.colorField.select(b.colors[0])):(this.nameField.reset(),this.descriptionField.reset(),this.colorField.select(b.colors[0]))},onClearFn:function(){this.formpanel.form.reset()},onSaveFn:function(){if(this.formpanel.form.isValid()){var a={};this.calendar?(a.id=this.calendar.id,a.hide=this.calendar.hide):a.hide=!1;a.name=this.nameField.getValue();
a.description=this.descriptionField.getValue();a.color=this.color;var b=this.ehandler;b.ds.createUpdateCalendar(a,function(c){var d=this.calendarEl;if(d){c=d.calendar.color;Ext.apply(d.calendar,a);var e=d.calendar.color;b.calendarSet[d.calendar.id]=d.calendar;var g=d.child(".x-calendar-title-b");if(g)g.dom.innerHTML="<b>"+a.name+"</b>";if(c!=e)d.calendar.color=c,b.changeColor(d.calendar,e)}else if(c.id)d=Ext.apply({},a),d.id=c.id,b.calendarSet[d.id]=d,b.createCalendar(b.mainPanel.westPanel.myCalendarPanel.body,
null,null,d),b.ss[b.ss.length]=Ext.util.CSS.createStyleSheet("."+b.id+"-x-calendar-"+d.id+"{}",Ext.id())},this);this.hide()}},onCancelFn:function(){this.hide()}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.CalendarWin=Ext.extend(Ext.Window,{initComponent:function(){this.mainPanel=new Ext.ux.calendar.MainPanel({datasource:this.datasource,calendarSetting:this.calendarSetting});Ext.ux.calendar.CalendarWin.superclass.initComponent.call(Ext.apply(this,{layout:"fit",items:[this.mainPanel]}))}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CommentTip=Ext.extend(Ext.Tip,{closable:!0,closeAction:"hide",showTip:function(a,b,c,d,e){this.setTitle(a);this.rendered?this.body.update(b):this.html=b;this.showBy(c,d);(function(){this.hide()}).defer(e||5E3,this)}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.DayView=Ext.extend(Ext.ux.calendar.BasicView,{createByDblclick:!1,hideInactiveRow:!1,activeStartRow:0,activeEndRow:48,startRow:0,endRow:48,cls:"x-dayview-ct",lineNum:3,border:!1,weekNum:1,dayNum:1,dayFormat:"m/d(D)",thin:4,leftWidth:70,scrollOffset:17,offsetPercent:0.1,headerHeight:30,rowHeight:26,poolMaxDepth:4,poolDepth:0,generateCSS:function(){var a="."+this.id+"-x-dayview-viewer-row-height{}."+this.id+"-x-dayview-pool{overflow:hidden;}."+this.id+"-x-dayview-pool-height{}."+this.id+
"-x-dayview-pool-width{}."+this.id+"-x-dayview-pool-viewer-width{}."+this.id+"-x-dayview-lefter-width{width:"+this.leftWidth+"px;}",b=Ext.id();this.ss=Ext.util.CSS.createStyleSheet(a,b)},updateTimeline:function(){for(var a=new Date,b=a.format("Y-m-d"),c=0,d=this.daySet.length;c<d;c++)if(b==this.daySet[c].format("Y-m-d"))break;this.timelinePn&&this.timeindexPn&&(this.timeindexPn.removeClass("x-dayview-timeindex"),this.timelinePn.removeClass("x-dayview-timeline"));if(c!=d&&(b=c%this.dayNum,c=parseInt(a.format("G")),
a=a.format("i"),"0"==a[0]&&(a=a.slice(1)),d=parseInt(a),a=this.intervalSlot,c=c*this.numInHour+Math.floor(d/a),d%=a,b=Ext.get(this.id+"-x-dayview-viewer-"+c+"-"+b),c=Ext.get(this.id+"-x-dayview-lefter-"+c+"-0"),b&&c))a=Math.floor(d/a*100),b.addClass("x-dayview-timeline"),b.setStyle("background-position","0% "+a+"%"),c.addClass("x-dayview-timeindex"),c.setStyle("background-position","0% "+a+"%"),this.timelinePn=b,this.timeindexPn=c},generateHTML:function(){this.generateCSS();for(var a="",b=this.numInHour,
c=this.startRow;c<this.endRow;c++){a+='<tr id="'+this.id+"-x-dayview-lefter-row-"+c+'">';for(var d=0;d<1;d++){var e=Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,c,this.hourFormat),e=0!=c%b&&c!=this.activeStartRow?'<div class="x-dayview-viewer-row-height" style="text-align:right;"><i><b class="x-dayview-lefter-inner x-dayview-lefter-fine-inner">'+e+"</b></i></div>":'<div class="x-dayview-viewer-row-height"><b class="x-dayview-lefter-inner">'+e+"</b></div>";a+='<td id="'+this.id+"-x-dayview-lefter-"+
c+"-"+d+'" class="'+this.id+"-x-dayview-lefter-td x-dayview-lefter-row-height x-dayview-lefter-cell "+(0!=(c+1)%b?"x-dayview-lefter-odd-row":"x-dayview-lefter-even-row")+'">'+e+"</td>"}a+="</tr>"}e="";for(c=this.startRow;c<this.endRow;c++){e+='<tr id="'+this.id+"-x-dayview-viewer-row-"+c+'">';for(d=0;d<this.dayNum;d++)e+='<td class="'+this.id+"-x-dayview-viewer-td "+this.id+"-x-dayview-viewer-col-"+d+" "+(0!=(c+1)%b?"x-dayview-odd-row":"x-dayview-even-row")+'"><div id="'+this.id+"-x-dayview-viewer-"+
c+"-"+d+'" class="x-dayview-viewer-row-height x-dayview-viewer-cell"></div></td>';e+="</tr>"}a='<div id="'+this.id+'-x-dayview-port" class="x-dayview-port x-dayview-inactive" unselectable="on" onselectstart="return false;"><div id="'+this.id+'-x-dayview-body" class="x-dayview-body x-dayview-inactive" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-dayview-lefter '+this.id+'-x-dayview-lefter-width"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody>'+
a+'</tbody></table></td><td class="x-dayview-viewer"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody>'+e+"</tbody></table></td></tr></tbody></table></div></div>";c="";this.dayTpl=new Ext.XTemplate('<tpl for="."><td class="x-dayview-header-days"><div class="'+this.id+'-x-dayview-pool-height"><b><u id="'+this.id+'-x-dayview-day-link-0-{idx}" class="x-dayview-header-day-link">{day}</u></b></div></td></tpl>');c=[];for(d=0;d<this.dayNum;d++)c[c.length]={idx:d,day:this.daySet[d].format(this.dayFormat)};
c=this.dayTpl.apply(c);d=this.daySet[0].getWeekOfYear();d=1==this.dayNum?'<u><b id="'+this.id+'-x-dayview-wn" class="x-dayview-wn-link">'+d+"</b></u>":'<b id="'+this.id+'-x-dayview-wn">'+d+"</b>";d='<div id="'+this.id+'-x-dayview-header" class="x-dayview-header" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-dayview-header-lefter '+this.id+'-x-dayview-lefter-width"><div class="x-dayview-wn">'+d+'</div></td><td class="x-dayview-header-viewer"><table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr>'+
c+'</tr></tbody></table></td><td width="'+this.scrollOffset+'px;"></td></tr></tbody></table></div>';b="";for(c=0;c<this.dayNum;c++)b+='<td id="'+this.id+"-x-dayview-bg-0-"+c+'" class="x-dayview-bg-cell">&nbsp;</td>';return d+('<div id="'+this.id+'-x-dayview-pool" class="x-dayview-pool" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-dayview-header-lefter '+this.id+'-x-dayview-lefter-width" style="vertical-align:top;"><div id="'+
this.id+'-x-dayview-pool-switch" class="x-dayview-pool-collapse"></div></td><td><div id="'+this.id+'-x-dayview-pool-viewer" class="'+this.id+'-x-dayview-pool-width x-dayview-pool-viewer">'+('<table class="x-dayview-bg" width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr>'+b+"</tr></tbody></table>")+'<table id="'+this.id+'-x-dayview-pool-ct" width="100%" class="x-dayview-ct" cellspacing="0" cellpadding="0" border="0"><tbody><tr></tr></tbody></table><div class="x-dayview-pool-rest"></div></div></td><td width="'+
this.scrollOffset+'px;"></tr></tbody></table></div>')+a},setToday:function(){for(var a=(new Date).format("Y-m-d"),b=this.daySet.length,c,d=0;d<b;d++)if(this.daySet[d].format("Y-m-d")===a){c=d;break}for(d=0;d<this.dayNum;d++)(b=Ext.get(this.id+"-x-dayview-bg-0-"+d))&&b.setStyle("background-color","white");if(a=!1!=Ext.type(c))(b=Ext.get(this.id+"-x-dayview-bg-0-"+c))&&b.setStyle("background-color","rgb(255,255,214)");for(d=this.activeStartRow;d<this.activeEndRow;d++)for(b=0;b<this.dayNum;b++){var e=
Ext.get(this.id+"-x-dayview-viewer-"+d+"-"+b);e&&(e=Ext.get(e.dom.parentNode),a&&b==c?e.setStyle("background-color","rgb(255,255,214)"):e.setStyle("background-color","white"))}},getStartDate:function(a){if(1!=this.dayNum)if(5==this.dayNum){var b=a.format("N");7==b&&(b=0);a=a.add(Date.DAY,1-b)}else 1==this.startDay?(b=a.format("N"),a=a.add(Date.DAY,1-b)):(b=a.format("w"),a=a.add(Date.DAY,-b));return a},initComponent:function(){this.id=Ext.id();this.daySet=[];this.ehandler.applyCalendarSetting(this);
for(var a=this.getStartDate(new Date),b=0,c=this.dayNum;b<c;b++)this.daySet[this.daySet.length]=a.add(Date.DAY,b);this.html=this.generateHTML();Ext.ux.calendar.DayView.superclass.initComponent.call(this);this.addEvents("checklayout","sizechanged","afterresize","beforeremoteload","remoteload","canceldetail","viewDay","viewWeek");this.on("afterrender",this._onAfterRenderFn,this);this.on("checklayout",this.checkLayout,this);this.on("canceldetail",this.onCancelDetailFn,this);this.on("afterlayout",this._onReSizingFn,
this);this.on("bodyresize",this._onReSizingFn,this);this.on("sizechanged",this.onSizeChangedFn,this,{buffer:50});Ext.EventManager.on(document,"mouseup",this._onMouseUpFn,this)},_onReSizingFn:function(){this.fireEvent("sizechanged")},onSizeChangedFn:function(){this.handleResize(this.body.getWidth(),this.body.getHeight())},onCancelDetailFn:function(){if(this.detailing)this.detailing=!1,this.detailCt.setStyle("display","none")},resetDragEventEl:function(){if(this.dragEventEl){var a=this.ehandler;delete this.dragEventEl.row;
delete this.dragEventEl;delete this.moving;a.floating=!1}},resetPrepareEl:function(){this.preEl&&(this.ehandler.showEditor(this.preEl,this,"add"),delete this.preEl)},resetSCover:function(){delete this.startPos;delete this.endPos;this.hideSCovers()},endDragEventEl:function(a){var b=a.cview,c=this.ehandler;c.floating=!1;var d=a.bindEvent,e=a.col,g=a.nol;if(!1==Ext.type(g))g=e,a.nol=g;var a=a.row||d.startRow,f=d.endRow-d.startRow;if(g==e)if(d.startRow=a,d.endRow=a+f,"string"==Ext.type(d.repeatType))c.updateEvent(d,
b,e);else{var h=Ext.apply({},d);d.repeatType="exception";h.startRow=h.oldStartRow;h.endRow=h.oldEndRow;c.updateRepeatEvent(d,this,h)}else{h=Ext.apply({},d);d.startRow=a;d.endRow=a+f;var i=b.daySet[g],a=Ext.ux.calendar.Mask.getDayOffset(d.day,d.eday);d.day=i.format("Y-m-d");i=i.add(Date.DAY,a);d.eday=i.format("Y-m-d");"string"==Ext.type(h.repeatType)?c.ds.updateEvent(d,function(){var a=c.calendarLayout.getLayout(b.daySet[e],b),a=a.updateLayout(h,"delete");c.renderEvent(b,a.elist,e);a=c.calendarLayout.getLayout(i,
b);a=a.updateLayout(d,"add");c.renderEvent(b,a.elist,g);c.fireEvent("changeEventCache",c)},this):(d.repeatType="exception",h.startRow=h.oldStartRow,h.endRow=h.oldEndRow,c.updateRepeatEvent(d,this,h))}},endResizeEventEl:function(a){var b=this.ehandler;b.floating=!1;var c=a.bindEvent;"string"==Ext.type(c.repeatType)?b.updateEvent(c,this,a.col):(a=Ext.apply({},c),c.repeatType="exception",a.startRow=a.oldStartRow,a.endRow=a.oldEndRow,b.updateRepeatEvent(c,this,a))},_onMouseUpFn:function(a){var b=this.ehandler;
this.resetPrepareEl();this.dragEventEl&&this.moving&&this.endDragEventEl(this.dragEventEl,a);this.resetDragEventEl();if(!this.dragging&&this.startPos){var a=Ext.apply({},this.startPos),c=Ext.apply({},this.endPos);this.startPos=null;b.prepareLegend(Ext.get(this.id+"-x-dayview-bg-0-"+c.y),a,c,this)}this.resizeEventEl&&this.endResizeEventEl(this.resizeEventEl);this.resetResizeEventEl()},getCellIndex:function(a){var a=a.toString().split("-"),b=a.length,c=a[b-1];return{x:parseInt(a[b-2]),y:parseInt(c)}},
_onAfterRenderFn:function(){this.initEls();this.setToday()},_onPortClickFn:function(a){var b=this.ehandler,a=a.getTarget(),a=Ext.get(a);a.hasClass("x-event-pin")?a.hasClass("x-calendar-event-pin-off")?(a.removeClass("x-calendar-event-pin-off"),a.addClass("x-calendar-event-pin-on"),b.editDisabled=!0):(a.removeClass("x-calendar-event-pin-on"),a.addClass("x-calendar-event-pin-off"),b.editDisabled=!1):a.hasClass("x-event-content-link")?(a=a.parent(".x-event-cover"),a.bindEvent.locked||b.showEditor(a,
this,"update")):(a=a.hasClass("x-event-cover")?a:a.parent(".x-event-cover"))&&b.setEditingStatus(a,!0,!1)},_onPortMouseOverFn:function(a){var a=a.getTarget(),a=Ext.get(a),b=!1;if(a.hasClass("x-event-cover"))b=!0;else if(a=a.parent(".x-event-cover"))b=!0;if(b)b=this.ehandler,b.editDisabled||b.setEditingStatus(a,!0)},_onBodyClickFn:function(a){var a=a.getTarget(),b=Ext.get(a),a=this.ehandler;b.hasClass("x-dayview-pool-collapse")?(b.removeClass("x-dayview-pool-collapse"),b.addClass("x-dayview-pool-expand"),
this.lineNum=Math.floor(this.body.getHeight()/17)-5,this.checkLayout(Ext.isIE)):b.hasClass("x-dayview-pool-expand")?(b.addClass("x-dayview-pool-collapse"),b.removeClass("x-dayview-pool-expand"),this.lineNum=3,this.checkLayout(Ext.isIE)):b.hasClass("x-event-detail-tool-close")?this.fireEvent("canceldetail"):!a.readOnly&&(b.hasClass("x-whole-title-b")||b.hasClass("x-legend-title-b"))?(b=b.parent(".x-whole-cover"))&&!b.bindEvent.locked&&a.showEditor(b,this,"update"):b.hasClass("x-dayview-header-day-link")?
this.fireEvent("viewDay",this,this.daySet[this.getCellIndex(b.dom.id).y]):b.hasClass("x-dayview-wn-link")&&(a=this.daySet[0],this.fireEvent("viewWeek",a,a))},_onBodyContextMenuFn:function(a){a.stopEvent();var b=this.ehandler,c=a.getTarget(),d=Ext.get(c);d.hasClass("x-calendar-event")||(d=d.parent(".x-calendar-event"));if(d)b.showContextMenu(a,d),this.menu.hide();else if(this.createByDblclick&&(c=Ext.get(c),c.hasClass("x-dayview-pool-viewer")||(c=c.parent(".x-dayview-pool-viewer")),c))this.menu.pn=
this.calculatePos(a),this.menu.showAt(a.getXY()),b.cmenu.hide()},_onBodyDblclickFn:function(a){var b=this.ehandler,c=a.getTarget(),d=Ext.get(c);d.hasClass("x-calendar-event")||(d=d.parent(".x-calendar-event"));if(d&&!d.bindEvent.locked)b.showEditor(d,this,"update");else if(this.createByDblclick&&(c=Ext.get(c),c.hasClass("x-dayview-pool-viewer")||(c=c.parent(".x-dayview-pool-viewer")),c))a=this.calculatePos(a),c=Ext.apply({},a),this.selectRange(a,c),this.startPos=null,b.prepareLegend(Ext.get(this.id+
"-x-dayview-bg-0-"+a.y),a,c,this)},resetResizeEventEl:function(){this.resizeEventEl&&delete this.resizeEventEl},_onPortMouseDownFn:function(a){a.stopEvent();this.fireEvent("hideeditor");this.fireEvent("canceldetail");if(0==a.button){var a=a.getTarget(),a=Ext.get(a),b=this.ehandler;if(a.hasClass("x-dayview-viewer-cell")){if(!this.createByDblclick)this.preEl=b.prepareEvent(a,this),this.preEl.base=this.preEl.bindEvent.startRow,b.setEditingStatus(this.preEl,!0),b.floating=!0}else if(a.hasClass("x-event-bottom-default"))b=
a.parent(".x-event-cover"),a=b.bindEvent,a.locked?this.resetResizeEventEl():(a.oldStartRow=a.startRow,a.oldEndRow=a.endRow,this.resizeEventEl=b);else if(!a.hasClass("x-event-pin")&&!a.hasClass("x-event-content-link")&&(delete this.preEl,b=a,b.hasClass("x-event-cover")||(b=a.parent(".x-event-cover")),b))a=b.bindEvent,a.locked?this.resetDragEventEl():(a.oldStartRow=a.startRow,a.oldEndRow=a.endRow,b.span=a.endRow-a.startRow,this.dragEventEl=b)}},movePrepareEl:function(a,b){var c=a.bindEvent,d=a.base,
e=Ext.get(this.id+"-x-dayview-viewer-"+d+"-0"),g=e.getTop(),e=e.getBottom(),f=b.getXY()[1];if(f>=g){var h=Math.round((f-g)/26),f=h*26;c.startRow=d;c.endRow=d+h+1;if(this.endRow<c.endRow)c.endRow=this.endRow,f=26*(this.endRow-d-1);a.contentEl.setHeight(f);a.titleEl.dom.innerHTML="<b>"+this.ehandler.generateTitle(c)+"</b>";a.setY(g)}else{h=Math.round((e-f)/26);f=h*26;c.startRow=d-h;c.endRow=d+1;if(this.startRow>c.startRow)c.startRow=this.startRow,f=26*(c.endRow-c.startRow-1);a.contentEl.setHeight(f);
a.titleEl.dom.innerHTML="<b>"+this.ehandler.generateTitle(c)+"</b>";c=e-a.getHeight();a.setY(c)}},resizingEventEl:function(a,b){a.setStyle("cursor","s-resize");var c=a.bindEvent,d=this.ehandler;d.floating=!0;var e=b.getXY(),g=this.cbody.getLeft(),f=Ext.get(this.id+"-x-dayview-viewer-"+this.startRow+"-0"),h=f.getXY(),i=f.getWidth(),f=f.getHeight()+1,e=this.startRow+Math.ceil((e[1]-h[1])/f);if(this.endRow<e)e=this.endRow;g=Ext.get(this.id+"-x-dayview-viewer-"+(this.endRow==e?this.endRow-1:e)+"-"+a.col).getLeft()-
g;c.endRow=e;if(this.endRow<c.endRow)c.endRow=this.endRow;if(c.endRow<=c.startRow)c.endRow=c.startRow+1;f=f*(c.endRow-c.startRow)-24;a.setStyle("left",g+"px");a.setStyle("width",i+"px");a.contentEl.setHeight(f);a.titleEl.dom.innerHTML="<b>"+d.generateTitle(c)+"</b>";d.setEditingStatus(a,!0)},moveEventEl:function(a,b){var c=this.ehandler,d=b.getXY(),e=this.cbody.getLeft(),g=this.cbody.getTop(),f=Ext.get(this.id+"-x-dayview-viewer-"+this.startRow+"-0"),h=f.getXY(),i=f.getWidth(),f=f.getHeight()+1,f=
this.startRow+Math.ceil((d[1]-h[1])/f),d=Math.floor((d[0]-h[0])/i);f-=1;this.startRow>f?f=this.startRow:this.endRow<=f&&(f=this.endRow-1);0>d?d=0:this.dayNum<=d&&(d=this.dayNum-1);h=Ext.get(this.id+"-x-dayview-viewer-"+f+"-"+d);e=h.getLeft()-e;g=h.getTop()-g;a.setStyle("left",e+"px");a.setStyle("top",g+"px");a.setStyle("width",i+"px");c.floating=!0;c.setEditingStatus(a,!0);i=a.bindEvent;g=a.span||i.endRow-i.startRow;i.startRow=f;i.endRow=i.startRow+g;if(this.endRow-1<i.startRow)i.startRow=this.endRow-
1;if(this.endRow<i.endRow)i.endRow=this.endRow;a.contentEl.setHeight(26*(i.endRow-i.startRow-1));a.titleEl.dom.innerHTML="<b>"+c.generateTitle(i)+"</b>";a.nol=d;a.row=f},_onPortMouseMoveFn:function(a){0==a.button?this.preEl?this.movePrepareEl(this.preEl,a):this.dragEventEl?(this.moving=!0,this.moveEventEl(this.dragEventEl,a)):this.resizeEventEl&&this.resizingEventEl(this.resizeEventEl,a):(this.resetResizeEventEl(),this.resetDragEventEl(),this.resetPrepareEl())},initEls:function(){this.port=Ext.get(this.id+
"-x-dayview-port");this.cbody=Ext.get(this.id+"-x-dayview-body");this.lefter=Ext.get(this.id+"-x-dayview-lefter");this.cheader=Ext.get(this.id+"-x-dayview-header");this.cpool=Ext.get(this.id+"-x-dayview-pool");this.cptable=Ext.get(this.id+"-x-dayview-pool-ct");this.pviewer=Ext.get(this.id+"-x-dayview-pool-viewer");this.pswitch=Ext.get(this.id+"-x-dayview-pool-switch");this.port.un("mouseover",this._onPortMouseOverFn,this);this.port.on("mouseover",this._onPortMouseOverFn,this);this.body.un("mousedown",
this._onBodyMouseDownFn,this);this.body.on("mousedown",this._onBodyMouseDownFn,this);this.body.un("click",this._onBodyClickFn,this);this.body.on("click",this._onBodyClickFn,this);this.ehandler.readOnly||(this.body.un("contextmenu",this._onBodyContextMenuFn,this),this.body.un("dblclick",this._onBodyDblclickFn,this),this.body.un("mousemove",this._onBodyMouseMoveFn,this),this.port.un("mousedown",this._onPortMouseDownFn,this),this.port.un("mousemove",this._onPortMouseMoveFn,this),this.body.on("mousemove",
this._onBodyMouseMoveFn,this),this.body.on("contextmenu",this._onBodyContextMenuFn,this),this.body.on("dblclick",this._onBodyDblclickFn,this),this.port.on("mousedown",this._onPortMouseDownFn,this),this.port.on("mousemove",this._onPortMouseMoveFn,this),this.createByDblclick&&(this.port.un("dblclick",this._onPortDblclickFn,this),this.port.on("dblclick",this._onPortDblclickFn,this)),this.port.un("click",this._onPortClickFn,this),this.port.un("contextmenu",this._PortContextMenuFn,this),this.port.on("click",
this._onPortClickFn,this),this.port.on("contextmenu",this._PortContextMenuFn,this),this.initMenu(),1<this.dayNum&&this.initDragZone(this.body));this.initSelectCover();this.initDetailCt()},_PortContextMenuFn:function(a){a.preventDefault();var b=a.getTarget(),b=Ext.get(b);if(b.hasClass("x-dayview-viewer-cell"))this.menu.pn=b,this.menu.showAt(a.getXY()),this.ehandler.cmenu.hide()},initMenu:function(){this.addItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_add",text:this.ehandler.lang.DayView["addItem.text"],
handler:this.onAddFn,scope:this});this.menu=new Ext.menu.Menu({items:[this.addItem]});this.menu=Ext.menu.MenuMgr.get(this.menu)},onAddFn:function(a){if(a=a.parentMenu.pn)a instanceof Ext.Element?this.addEvent2Row(a):(this.endPos=this.startPos=a,this.ehandler.prepareLegend(null,this))},addEvent2Row:function(a){var b=this.ehandler;b.floating=!0;this.preEl=b.prepareEvent(a,this);this.preEl.base=this.preEl.bindEvent.startRow;b.showEditor(this.preEl,this,"add");b.floating=!1;delete this.preEl},_onPortDblclickFn:function(a){a=
a.getTarget();a=Ext.get(a);a.hasClass("x-dayview-viewer-cell")&&this.addEvent2Row(a)},initDetailCt:function(){var a=this.ehandler.detailTpl.apply({});this.detailCt=Ext.DomHelper.append(this.body,a,!0);this.detailCt.setStyle("display","none");this.detailTitle=this.detailCt.child(".x-event-detail-title-td");this.detailViewer=this.detailCt.child(".x-event-detail-viewer");this.detailFoot=this.detailCt.child(".x-event-detail-foot-text")},initDragZone:function(a){var b=new Ext.dd.StatusProxy({dropNotAllowed:"x-dd-drop-ok"});
a.dragzone=new Ext.dd.DragZone(a,{cview:this,ddGroup:"x-mycalendar",proxy:b,onStartDrag:function(){this.cview.dragging=!0;(function(){for(var a=this.dragData.bindEvent,a=Ext.DomQuery.select("div[name=x-event-"+a.day+"-"+a.eday+"-"+a.eventId+"]",this.cview.body.dom),b=0,e=a.length;b<e;b++)Ext.get(a[b]).setOpacity(0.3)}).defer(1,this)},getDragData:function(a){var a=a.getTarget(),b=Ext.get(a);b.hasClass("x-calendar-event")||(b=b.parent(".x-calendar-event"));if(b&&(a=b.bindEvent,!a.locked)){var e=b.dom.cloneNode(!0),
b=b.getWidth();e.style.width=200<b?"200px":b+"px";return{ddel:e,bindEvent:a}}return!1},getRepairXY:function(){return null},onDrag:function(a){var b=this.dragData.bindEvent,e=this.cview,b=Ext.ux.calendar.Mask.getDayOffset(b.day,b.eday),a=e.calculatePos(a),b=e.addSpan2Pos(a,b);e.selectRange(a,b)},endDrag:function(){var a=this.dragData.bindEvent,b=Ext.apply({},a),e=this.cview,g=e.startPos,f=e.ehandler,h=Ext.ux.calendar.Mask.getDayOffset(a.day,a.eday),i=e.daySet[g.y],j=i.format("Y-m-d");if(a.day!=j)a.eday=
i.add(Date.DAY,h).format("Y-m-d"),a.day=j,delete e.startPos,"string"==Ext.type(a.repeatType)?f.updateEvent(a,e,g.y):(a.repeatType="exception",f.updateRepeatEvent(a,e,b));else{a=Ext.DomQuery.select("div[name=x-event-"+a.day+"-"+a.eday+"-"+a.eventId+"]",this.cview.body.dom);b=0;for(g=a.length;b<g;b++)Ext.get(a[b]).setOpacity(1)}e.dragging=!1;e.resetSCover();e.fireEvent("canceldetail")}})},addSpan2Pos:function(a,b){var c=Ext.apply({},a);c.y+=b;if(c.y>=this.dayNum)c.y=this.dayNum-1;return c},alignDetailCt:function(){if(this.detailing){var a=
this.detailing.x,b=this.detailing.y,c=this.detailing.events;this.detailCt.setStyle("display","");var a=Ext.get(this.id+"-x-dayview-bg-"+a+"-"+b),b=c.length*17,d=this.port.getBottom()-a.getTop()-30,e=this.port.getRight()-a.getRight(),c=[0,0];b>d?this.detailViewer.setHeight(d):this.detailViewer.setStyle("height","");1<this.dayNum&&e<this.detailCt.getWidth()?(b="r",c[0]=-1):b="l";d=a.getWidth();200<d?this.detailCt.setWidth(d):this.detailCt.setWidth(200);b="t"+b;this.detailCt.alignTo(a,b+"-"+b,c)}},showDetails:function(a){var b=
this.ehandler.lang.DayView,c=this.ehandler,d=c.calendarLayout.getWholeList(this,a,!1,!0),e=this.getIndexFromDay(a)%this.shiftDay;this.detailing={x:0,y:e,events:d};this.detailTitle.dom.innerHTML='<b><u id="'+Ext.id()+"x-dayview-day-link-0-"+e+'" class="x-dayview-header-day-link">'+a+"</u></b>";this.detailFoot.dom.innerHTML=d.length+" "+b.events;c.bindEvent2Detail(this,d,this.detailViewer);this.alignDetailCt()},_onBodyMouseDownFn:function(a){a.stopEvent();this.fireEvent("hideeditor");var b=a.getTarget(),
b=Ext.get(b),c;if(b.hasClass("x-event-more"))this.showDetails(b.dom.getAttribute("name"));else{if(this.detailing)if(!b.hasClass("x-event-detail-ct")&&!b.parent(".x-event-detail-ct"))this.fireEvent("canceldetail");else return;if(!this.createByDblclick&&!this.ehandler.readOnly&&(c=b.hasClass("x-calendar-event")?b:b.parent(".x-calendar-event"),!c&&(c=b.parent(".x-dayview-pool-viewer"))))a=this.calculatePos(a),this.selectRange(a,a)}},calculatePos:function(a){var a=a.getXY(),b=this.pviewer.getXY(),a=Math.floor((a[0]-
b[0])/this.cw);0>a?a=0:a>=this.dayNum&&(a=this.dayNum-1);return{x:0,y:a}},_onBodyMouseMoveFn:function(a){0==a.button?this.startPos&&this.selectRange(null,this.calculatePos(a)):this.resetSCover()},hideSCovers:function(){this.scover.dom.style.display="none"},selectRange:function(a,b){this.hideSCovers();a&&(this.startPos=a);this.endPos=b;var c,d;this.startPos.y>this.endPos.y?(c=this.endPos.y,d=this.startPos.y):(d=this.endPos.y,c=this.startPos.y);var e=this.cw,g=this.pviewer.getHeight(),f=e*c,h=this.scover;
h.dom.style.display="";h.setWidth(e*(d-c+1));h.setHeight(g);h.setLeft(f+"px");h.setTop("0px")},initSelectCover:function(){var a=document.createElement("div");a.className="x-event-select-cover";a=Ext.get(a);this.pviewer.appendChild(a);this.scover=a},resizePort:function(a){var b=this.body.getHeight(),c=this.cpool.getHeight(),b=b-this.cheader.getHeight()-c-1;b!=this.port.getHeight()&&this.port.setHeight(b);if(!0==a){for(var a=this.ehandler,b=a.calendarLayout,c=0,d=this.dayNum;c<d;c++){var e=b.getLayout(this.daySet[c],
this);e&&(e=e.reLayout(),a.renderEvent(this,e.elist,c))}this.adjustScroller()}},handleResize:function(a,b){if(typeof a=="number"){this.cheader.setWidth(a);Ext.isIE||(a-=2);var c=a-this.scrollOffset;this.leftWidth=70+c%7;Ext.util.CSS.updateRule("."+this.id+"-x-dayview-lefter-width","width",this.leftWidth+"px");this.port.setWidth(a);a=c-this.leftWidth;this.cw=Math.round(a/this.dayNum)}typeof b=="number"&&this.resizePort(!0);this.alignDetailCt();this.updateTimeline();this.fireEvent("afterresize",this,
a,b)},adjustScroller:function(){if(!this.hideInactiveRow){var a=Ext.get(this.id+"-x-dayview-viewer-"+this.activeStartRow+"-0"),a=Ext.get(a.dom.parentNode);this.port.dom.scrollTop=a.getHeight()*this.activeStartRow}},checkLayout:function(a,b){var c=this.ehandler,d=this.daySet[0],e=this.daySet[this.daySet.length-1];if(c.isInDayCache(d,e)&&!b){for(var g=c.calendarLayout,f={},h={},i=0,j=this.dayNum;i<j;i++){var n=this.daySet[i].format("Y-m-d"),k=g.getLayout(n,this);h[n]=g.getWholeList(this,n);if(!0!==
k.visited[this.id]||a)f[i]=k,this.cleanup(i)}g.showWeek(this,this.cptable.dom.firstChild,0,h,!0);this.resizePort();for(var m in f)k=f[m],g=k.reLayout(!1,!0),c.renderEvent(this,g.elist,m);this.adjustScroller()}else this.fireEvent("beforeremoteload"),this.cleanup(),c.ds.loadEvent(d,e,function(a){c.calendarLayout.updateWholeList(a.whole,"add");this.showEvents(a,b);c.pushDayCache(d,e);this.adjustScroller();this.resizePort(Ext.isIE);this.fireEvent("remoteload")},this);this.setToday();this.updateTimeline()},
showEvents:function(a,b){for(var c={},d=this.ehandler,e=d.calendarLayout,g=0,f=this.dayNum;g<f;g++){var h=this.daySet[g].format("Y-m-d"),i=e.getLayout(h,this,a[h]||[],!0,b);if(i)i=i.reLayout(),d.renderEvent(this,i.elist,g),c[h]=i.wlist}e.showWeek(this,this.cptable.dom.firstChild,0,c,!0)},refreshLefter:function(){for(var a=this.numInHour,b=0;b<this.rowCount;b++)for(var c=0;c<1;c++){var d=Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,b,this.hourFormat),d=0!=b%a&&b!=this.activeStartRow?'<div class="x-dayview-viewer-row-height" style="text-align:right;"><i><b class="x-dayview-lefter-inner x-dayview-lefter-fine-inner">'+
d+"</b></i></div>":'<div class="x-dayview-viewer-row-height"><b class="x-dayview-lefter-inner">'+d+"</b></div>",e=Ext.get(this.id+"-x-dayview-lefter-"+b+"-"+c);if(e)e.dom.firstChild.innerHTML=d}},refreshDate:function(){for(var a=0;a<this.dayNum;a++){var b=Ext.get(this.id+"-x-dayview-day-link-0-"+a);if(b){var c=this.daySet[a].format(this.dayFormat);b.dom.innerHTML=c}}Ext.get(this.id+"-x-dayview-wn").dom.innerHTML=this.daySet[0].getWeekOfYear()},resetView:function(){this.refreshDate();this.setToday()},
cleanup:function(a,b){if(!b)if(!1==Ext.type(a))for(var c=0;c<this.rowCount;c++)for(var d=0;d<this.dayNum;d++){var e=Ext.get(this.id+"-x-dayview-viewer-"+c+"-"+d);if(e)e.dom.innerHTML=""}else for(c=0;c<this.rowCount;c++)if(e=Ext.get(this.id+"-x-dayview-viewer-"+c+"-"+a))e.dom.innerHTML="";if(this.cptable)for(c=this.cptable.dom.firstChild;0<c.childNodes.length;)Ext.get(c.lastChild).remove()},getIndexFromDay:function(a){for(var b=0,c=this.daySet.length;b<c;b++)if(a==this.daySet[b].format("Y-m-d"))return b},
locateDay:function(a){a=this.getStartDate(a);this.daySet[0]=a;for(var b=1;b<this.dayNum;b++)this.daySet[b]=a.add(Date.DAY,b)},showDay:function(a){this.locateDay(a);this.resetView();this.checkLayout(!0)},goBack:function(){var a=this.shiftDay||this.dayNum,b=this.dayNum,c=this.daySet[0].add(Date.DAY,-1*a),d=this.weekNum||1;this.daySet=[];for(var e=0;e<d;e++)for(var g=0;g<b;g++)this.daySet[this.daySet.length]=c.add(Date.DAY,e*a+g);this.resetView();this.checkLayout(!0)},goNext:function(){var a=this.shiftDay||
this.dayNum,b=this.dayNum,c=this.daySet[0].add(Date.DAY,a),d=this.weekNum||1;this.daySet=[];for(var e=0;e<d;e++)for(var g=0;g<b;g++)this.daySet[this.daySet.length]=c.add(Date.DAY,e*a+g);this.resetView();this.checkLayout(!0)},isShift:function(a,b){var c,d=a.format("Y-m-d"),e=this.daySet[0].format("Y-m-d");c=d<e?e:d;d=b.format("Y-m-d");e=this.daySet[this.daySet.length-1].format("Y-m-d");if(c>(d>e?e:d)){c=this.getStartDate(a);this.daySet=[];for(d=0;d<this.weekNum;d++)for(e=0;e<this.dayNum;e++)this.daySet[this.daySet.length]=
c.add(Date.DAY,d*this.shiftDay+e);return!0}else return!1},showRange:function(a,b,c){this.isShift(a,b)&&(c=!0,this.resetView());this.checkLayout(c)}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.DetailEditor=function(a){Ext.apply(this,a);this.ehandler.applyCalendarSetting(this);a=this.ehandler.lang.Editor;this.startDayField=new Ext.form.DateField({fieldLabel:a["startDayField.label"],value:new Date,format:"Y-m-d",allowBlank:!1,anchor:"95%",editable:!1,disabled:this.singleDay});this.startDayField.on("select",this.onStartEndDayCheckFn,this);this.startTimeField=new Ext.form.ComboBox({hideLabel:!0,labelSeparator:"",store:Ext.ux.calendar.Mask.getTimeStore(),displayField:"hour",
valueField:"row",typeAhead:!0,mode:"local",triggerAction:"all",selectOnFocus:!0,allowBlank:!1,editable:!1,anchor:"95%"});this.startTimeField.on("select",this.onStartTimeSelectFn,this);this.endDayField=new Ext.form.DateField({fieldLabel:a["endDayField.label"],labelSeparator:"",format:"Y-m-d",value:new Date,allowBlank:!1,anchor:"95%",editable:!1,disabled:this.singleDay});this.endDayField.on("select",this.onStartEndDayCheckFn,this);this.endTimeField=new Ext.form.ComboBox({hideLabel:!0,labelSeparator:"",
store:Ext.ux.calendar.Mask.getTimeStore(),displayField:"hour",valueField:"row",typeAhead:!0,mode:"local",triggerAction:"all",selectOnFocus:!0,allowBlank:!1,editable:!1,anchor:"95%"});this.wholeField=new Ext.form.Checkbox({hideLabel:!0,labelSeparator:"",boxLabel:a["wholeField.label"]});this.wholeField.on("check",this.onWholeCheck,this);this.repeatTypeField=new Ext.form.ComboBox({fieldLabel:a["repeatTypeField.label"],store:Ext.ux.calendar.Mask.getRepeatTypeStore(),displayField:"display",valueField:"value",
typeAhead:!0,mode:"local",triggerAction:"all",selectOnFocus:!0,allowBlank:!1,editable:!1,anchor:"99%"});this.subjectField=new Ext.form.TextField({fieldLabel:a["subjectField.label"],anchor:"99%"});this.contentField=new Ext.form.TextArea({fieldLabel:a["contentField.label"],height:70,anchor:"99%"});var b='<tpl for="."><div class="x-combo-list-item">'+this.ehandler.cTplStr+"</div></tpl>";this.calendarField=new Ext.form.ComboBox({fieldLabel:a["calendarField.label"],store:Ext.ux.calendar.Mask.getCalendarStore(),
displayField:"title",valueField:"id",typeAhead:!0,mode:"local",triggerAction:"all",selectOnFocus:!0,allowBlank:!1,anchor:"99%",editable:!1,tpl:b});this.alertCB=new Ext.form.Checkbox({labelSeparator:"",anchor:"99%",disabled:!0,boxLabel:a["alertCB.label"],hidden:!0});this.lockCB=new Ext.form.Checkbox({labelSeparator:"",anchor:"99%",boxLabel:a["lockCB.label"]});this.returnBtn=new Ext.Button({iconCls:"icon-sys-calendar-door_out",text:a["returnBtn.text"],handler:this.onReturnFn,scope:this,hidden:!0});
this.saveBtn=new Ext.Button({iconCls:"icon-sys-calendar-accept",minWidth:80,text:a["saveBtn.text"],hidden:this.ehandler.readOnly,handler:this.onSaveFn,scope:this});this.cancelBtn=new Ext.Button({iconCls:"icon-sys-calendar-cancel",minWidth:80,text:a["cancelBtn.text"],handler:this.onCancelFn,scope:this});this.timepanel=new Ext.Panel({border:!1,layout:"column",items:[{columnWidth:0.33,border:!1,layout:"form",items:[this.startDayField]},{columnWidth:0.15,border:!1,layout:"form",items:[this.startTimeField]},
{columnWidth:0.22,border:!1,layout:"form",labelWidth:15,items:[this.endDayField]},{columnWidth:0.15,border:!1,layout:"form",items:[this.endTimeField]},{columnWidth:0.15,border:!1,items:[this.wholeField]}]});this.repeatIntervalField=new Ext.form.NumberField({fieldLabel:a["repeatIntervalField.label"],labelSeparator:"",value:1,allowBlank:!1,anchor:"99%"});this.repeatIntervalField.on("valid",this.onRepeatIntervalValidFn,this);this.intervalUnitLabel=new Ext.util.LabelField({hideLabel:!0,labelSeparator:""});
this.repeatStartField=new Ext.form.DateField({fieldLabel:a["repeatStartField.label"],format:"Y-m-d",allowBlank:!1,anchor:"90%"});this.repeatStartField.on("select",this.onRepeatStartSelectFn,this);this.repeatNoEndRG=new Ext.form.Radio({boxLabel:a["repeatNoEndRG.label"],name:"repeat-end-type"});this.repeatEndTimeRG=new Ext.form.Radio({boxLabel:a["repeatEndTimeRG.label"],name:"repeat-end-type"});this.repeatEndTimeField=new Ext.form.NumberField({width:50,value:10,allowBlank:!1,disabled:!0});this.repeatEndDateRG=
new Ext.form.Radio({boxLabel:a["repeatEndDateRG.label"],name:"repeat-end-type"});this.repeatEndDateField=new Ext.form.DateField({hideLabel:!0,labelSeparator:"",format:"Y-m-d",allowBlank:!1,anchor:"99%",disabled:!0,value:(new Date).add(Date.DAY,365)});for(var b={check:{fn:this.refreshRepeatInfo,scope:this}},c=[],d=new Date,e=d.format("N"),d=d.add(Date.DAY,1-e),e=0;e<7;e++)c.push({boxLabel:d.add(Date.DAY,e).format("D"),listeners:b});this.weekCheckGroup=new Ext.form.CheckboxGroup({fieldLabel:a["weekCheckGroup.label"],
items:c,anchor:"100%"});this.monthRadioGroup=new Ext.form.RadioGroup({fieldLabel:a["monthRadioGroup.label"],items:[{boxLabel:a.repeatByDate,name:"repeat-month-group",checked:!0},{boxLabel:a.repeatByDay,name:"repeat-month-group",listeners:b}],anchor:"60%"});this.generalForm=new Ext.form.FormPanel({border:!1,style:"padding:10px;",frame:!0,autoHeight:!0,labelWidth:80,items:[this.timepanel,{border:!1,layout:"column",items:[{border:!1,columnWidth:0.7,layout:"form",items:[this.calendarField]},{border:!1,
columnWidth:0.15,items:[this.alertCB]},{border:!1,columnWidth:0.15,items:[this.lockCB]}]},this.subjectField,this.contentField]});this.repeatInfoPanel=new Ext.Panel({border:!1,html:'<div class="x-repeat-event-info-ct"><div class="x-repeat-event-info"></div></div>'});b=Ext.isIE?"3.0.3"==Ext.version?[0.4,0.2,0.38,0.4,0.6]:[0.2,0.1,0.3,0.2,0.3]:[0.4,0.2,0.38,0.4,0.6];this.repeatForm=new Ext.form.FormPanel({border:!1,style:"padding:10px;",frame:!0,autoHeight:!0,labelWidth:80,items:[this.repeatTypeField,
{border:!1,style:"padding-left:85px;",layout:"column",items:[{border:!1,columnWidth:0.25,layout:"form",items:[this.repeatIntervalField]},{border:!1,columnWidth:0.2,items:[this.intervalUnitLabel]}]},this.repeatInfoPanel,{border:!1,style:"padding-left:85px;",layout:"form",items:[this.weekCheckGroup]},{border:!1,style:"padding-left:85px;",layout:"form",items:[this.monthRadioGroup]},{border:!1,style:"padding-left:85px;",layout:"column",items:[{border:!1,columnWidth:0.5,layout:"form",labelWidth:75,items:[this.repeatStartField]},
{border:!1,columnWidth:0.5,items:[this.repeatNoEndRG,{border:!1,layout:"column",items:[{border:!1,columnWidth:b[0],items:[this.repeatEndTimeRG]},{border:!1,columnWidth:b[1],items:[this.repeatEndTimeField]},{border:!1,columnWidth:b[2],layout:"form",labelWidth:95,items:[{xtype:"textfield",fieldLabel:a.repeatEndTimeUnit,labelSeparator:"",hidden:!0}]}]},{border:!1,layout:"column",items:[{border:!1,columnWidth:b[3],items:[this.repeatEndDateRG]},{border:!1,columnWidth:b[4],layout:"form",items:[this.repeatEndDateField]}]}]}]}]});
Ext.ux.calendar.DetailEditor.superclass.constructor.call(this,{border:!1,autoScroll:!0,items:[{border:!1,width:650,layout:"form",items:[this.generalForm,this.repeatForm]}],buttonAlign:"center",buttons:[this.returnBtn,this.saveBtn,this.cancelBtn]});this.addEvents("showdetailsetting");this.repeatTypeField.on("select",this.onRepeatTypeSelectFn,this);this.calendarField.on("select",this.onCalendarSelectFn,this);this.repeatNoEndRG.on("check",this.onRepeatNoEndCheckFn,this);this.repeatEndTimeRG.on("check",
this.onRepeatEndTimeCheckFn,this);this.repeatEndDateRG.on("check",this.onRepeatEndDateCheckFn,this)};
Ext.extend(Ext.ux.calendar.DetailEditor,Ext.ux.calendar.BasicView,{onRepeatIntervalValidFn:function(){this.refreshRepeatInfo()},onRepeatStartSelectFn:function(){this.refreshRepeatInfo()},refreshRepeatInfo:function(){var a=this.repeatStartField.getValue(),b=this.repeatIntervalField.getValue(),c=Ext.ux.calendar.Mask.getIntervalText,d=this.ehandler.lang.Editor,e=this.repeatTypeField.getValue(),g="";if("day"==e)this.updateRepeatInfo(c(e,b));else if("week"==e){for(var f=a.add(Date.DAY,1-a.format("N")),
h=this.weekCheckGroup.items,i=0,j=0,n=h.getCount();j<n;j++)h.get(j).checked&&(i++,g+=f.add(Date.DAY,j).format("l")+" ");7==i?g=d.repeatDayInfo:0==i&&(g=a.format("l"));this.updateRepeatInfo(c(e,b)+g)}else"month"==e?(g=this.monthRadioGroup.items.get(1).checked?Ext.ux.calendar.Mask.getWeekDayInMonth(a):a.format("d"),this.updateRepeatInfo(c(e,b)+g)):"year"==e&&this.updateRepeatInfo(c(e,b)+a.format("m-d"))},updateRepeatInfo:function(a){this.repeatInfoPanel.body.dom.firstChild.firstChild.innerHTML=a},onRepeatTypeSelectFn:function(a){this.resetRepeatSetting(a.getValue(),
this.bindEl.bindEvent)},resetRepeatSetting:function(a,b){var c=b.repeatType||"no",d=this.ehandler.lang.Editor,e=this.repeatForm.items;if("no"==a||"exception"==a)e.get(1).hide(),e.get(2).hide(),e.get(3).hide(),e.get(4).hide(),e.get(5).hide();else{e.get(1).show();e.get(2).show();if("day"==a||"year"==a)"day"==a?this.intervalUnitLabel.setText(d["intervalUnitLabel.day.text"]):this.intervalUnitLabel.setText(d["intervalUnitLabel.year.text"]),e.get(3).hide(),e.get(4).hide();else if("week"==a){this.intervalUnitLabel.setText(d["intervalUnitLabel.week.text"]);
e.get(3).show();this.weekCheckGroup.reset();d=this.weekCheckGroup.items;d.each(function(a){a.checked=!1});if("string"!=Ext.type(c)){var g=c.rday,f;for(f in g)d.get(f-1).setValue(!0)}e.get(4).hide()}else if("month"==a)this.intervalUnitLabel.setText(d["intervalUnitLabel.month.text"]),e.get(3).hide(),e.get(4).show(),this.monthRadioGroup.reset(),f=this.monthRadioGroup.items,f.each(function(a){a.checked=!1}),"string"!=Ext.type(c)&&("day"==c.rby?f.get(1).setValue(!0):f.get(0).setValue(!0));e.get(5).show();
this.repeatForm.doLayout();this.repeatNoEndRG.checked=!1;this.repeatEndTimeRG.checked=!1;this.repeatEndDateRG.checked=!1;"string"!=Ext.type(c)?(this.repeatIntervalField.setValue(c.intervalSlot),this.repeatStartField.setValue(c.beginDay),"no"==c.endDay?!1!=Ext.type(c.rtime)?this.repeatEndTimeRG.setValue(!0):this.repeatNoEndRG.setValue(!0):(this.repeatEndDateRG.setValue(!0),this.repeatEndDateField.setValue(c.endDay))):("day"==a?this.repeatIntervalField.setValue(Ext.ux.calendar.Mask.getDayOffset(b.day,
b.eday)+1):this.repeatIntervalField.setValue(1),this.repeatStartField.setValue(b.day),this.repeatNoEndRG.setValue(!0));this.refreshRepeatInfo()}},onRepeatNoEndCheckFn:function(a,b){b&&(this.repeatEndTimeField.disable(),this.repeatEndDateField.disable())},onRepeatEndTimeCheckFn:function(a,b){b&&(this.repeatEndTimeField.enable(),this.repeatEndDateField.disable())},onRepeatEndDateCheckFn:function(a,b){b&&(this.repeatEndTimeField.disable(),this.repeatEndDateField.enable())},onReturnFn:function(){var a=
this.bview;this.ownerCt.getLayout().setActiveItem(a);a.checkLayout(!0)},onStartEndDayCheckFn:function(a){var b=this.startDayField.getValue(),c=b.format("Y-m-d"),d=this.endDayField.getValue(),e=d.format("Y-m-d");c>=e&&(a==this.startDayField?this.endDayField.setValue(b):a==this.endDayField&&this.startDayField.setValue(d),a=this.startTimeField.getValue(),b=this.endTimeField.getValue(),this.reloadEndTimeStore(a),a>b&&(b=a+this.numInHour,b>=this.activeEndRow&&(b=this.activeEndRow-1),this.endTimeField.setValue(b)))},
reloadStartTimeStore:function(a){var b=this.startTimeField.store;b.removeAll();a=a?Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,0,this.rowCount-1,this.ehandler.hourFormat):Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,this.activeStartRow,this.activeEndRow-1,this.ehandler.hourFormat);b.loadData(a)},reloadEndTimeStore:function(a,b){var c=this.endTimeField.store;c.removeAll();var d;b?d=Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,0,this.rowCount,this.ehandler.hourFormat):
(!1==Ext.type(a)?a=this.activeStartRow:a++,d=Ext.ux.calendar.Mask.generateIntervalData(this.intervalSlot,a,this.activeEndRow,this.ehandler.hourFormat));c.loadData(d)},onStartTimeSelectFn:function(a){var a=a.getValue(),b,c=this.startDayField.getValue().format("Y-m-d"),d=this.endDayField.getValue().format("Y-m-d");if(this.bindEl){var e=this.bindEl.bindEvent;c!=d?this.reloadEndTimeStore():(b=a+(e.endRow-e.startRow),this.reloadEndTimeStore(a))}!1!=Ext.type(b)&&(this.activeEndRow>=b?this.endTimeField.setValue(b):
this.endTimeField.setValue(this.activeEndRow))},onCalendarSelectFn:function(a,b){var c=this.bindEl;if(c&&!c.hold)for(var d=c.bindEvent,e=c.cview,g=e.ehandler,f=g.calendarSet[b.data.id].color,h=Ext.DomQuery.select("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",e.body.dom),i=0,j=h.length;i<j;i++)c=Ext.get(h[i]),c instanceof Ext.Element&&(0==d.startRow&&this.rowCount==d.endRow?this.oldColor!=f&&g.changeWholeColor(c,this.oldColor,f):this.oldColor!=f&&(e instanceof Ext.ux.calendar.DayView?g.changeEventColor(c,
this.oldColor,f):g.changeLegendColor(c,this.oldColor,f)));this.oldColor=f},onWholeCheck:function(){var a=this.startDayField.getValue().format("Y-m-d"),b=this.endDayField.getValue().format("Y-m-d");if(this.bindEl){var c=this.bindEl.bindEvent;if(this.wholeField.checked)a=Ext.ux.calendar.Mask.getHMFromRow,this.reloadStartTimeStore(!0),this.reloadEndTimeStore(null,!0),this.startTimeField.setRawValue(a(this.intervalSlot,0,this.hourFormat)),this.endTimeField.setRawValue(a(this.intervalSlot,this.rowCount,
this.hourFormat)),this.startTimeField.disable(),this.endTimeField.disable();else{var d,e;d=this.activeStartRow<=c.startRow?c.startRow:this.activeStartRow;e=this.activeEndRow>=c.endRow?c.endRow:this.activeEndRow-1;this.reloadStartTimeStore();this.startTimeField.setValue(d);a==b&&this.rowCount!=c.endRow?this.reloadEndTimeStore(d):this.reloadEndTimeStore();this.endTimeField.setValue(e);this.startTimeField.enable();this.endTimeField.enable()}this.startDayField.setValue(c.day);this.endDayField.setValue(c.eday)}},
onSaveFn:function(){if(this.generalForm.form.isValid()){if(this.bindEl){var a=this.bindEl,b=a.bindEvent,c=Ext.apply({},b),d=a.cview,e=d.ehandler;"add"==this.action&&!a.hold&&a.remove();this.wholeField.checked?(b.allDay=!0,b.startRow=0,b.endRow=this.rowCount):(b.startRow=parseInt(this.startTimeField.getValue()),b.endRow=parseInt(this.endTimeField.getValue()));b.day=this.startDayField.getValue().format("Y-m-d");a=this.endDayField.getValue();if(0==b.endRow)a=a.add(Date.DAY,-1),b.endRow=this.rowCount;
b.eday=a.format("Y-m-d");b.subject=this.subjectField.getValue();b.content=this.contentField.getValue();b.calendarId=this.calendarField.getValue();b.color=e.calendarSet[b.calendarId].color;b.alertFlag=this.alertCB.checked;b.locked=this.lockCB.checked;b=this.handleRepeatType(b);if("add"==this.action)"string"==Ext.type(b.repeatType)?e.createEvent(b,d):e.createRepeatEvent(b,d);else if("update"==this.action)"string"==Ext.type(c.repeatType)&&"string"==Ext.type(b.repeatType)?(b.repeatType=c.repeatType,e.updateEvent(b,
d,null,c,this.noLayout)):"string"==Ext.type(b.repeatType)?(a=e.lang.EventHandler,Ext.Msg.show({title:a["updateRepeatPopup.title"],msg:a["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(a){if("yes"==a)e.updateRepeatEvent(b,d,c);else if("no"==a)b.repeatType="exception",e.updateRepeatEvent(b,d,c)},icon:Ext.MessageBox.QUESTION})):e.updateRepeatEvent(b,d,c)}d.fireEvent("canceldetail");this.onReturnFn()}},handleRepeatType:function(a){var b=Ext.apply({},a),c=this.repeatTypeField.getValue();
if("no"==c)b.repeatType="no";else{a={rtype:c,intervalSlot:this.repeatIntervalField.getValue(),dspan:Ext.ux.calendar.Mask.getDayOffset(a.day,a.eday),beginDay:this.repeatStartField.getValue().format("Y-m-d")};if(this.repeatNoEndRG.checked)a.endDay="no";else if(this.repeatEndTimeRG.checked)a.endDay="no",a.rtime=this.repeatEndTimeField.getValue();else if(this.repeatEndDateRG.checked)a.endDay=this.repeatEndDateField.getValue().format("Y-m-d");if("week"==c){for(var c={},d=this.weekCheckGroup.items,e=!1,
g=0,f=d.getCount();g<f;g++)d.get(g).checked&&(e=!0,c[g+1]=!0);e||(d=Date.parseDate(b.day,"Y-m-d").format("N"),c[d]=!0);a.rday=c}else if("month"==c)d=this.monthRadioGroup.items,a.rby=!0==d.get(0).checked?"date":"day";b.repeatType=a}return b},onCancelFn:function(){var a=this.bindEl;if(a=this.bindEl){var b=a.cview,c=a.bindEvent,d=b.ehandler;if(!a.hold)if("add"==this.action)this.bindEl.remove();else{var e=d.calendarSet[c.calendarId].color;0==c.startRow&&this.rowCount==c.endRow?this.oldColor!=e&&d.changeWholeColor(a,
this.oldColor,e):this.oldColor!=e&&(b instanceof Ext.ux.calendar.DayView?d.changeEventColor(a,this.oldColor,e):d.changeLegendColor(a,this.oldColor,e))}this.onReturnFn()}},setup:function(a){this.noLayout=a.noLayout;this.bindEl=a.bindEl;this.action=a.action;this.bview=a.cview;if(this.bindEl){var b=this.bindEl,a=b.cview.ehandler;b instanceof Ext.Element&&a.setEditingStatus(b,!0);b=b.bindEvent;b.endRow==this.rowCount&&b.startRow==0?this.wholeField.setValue(!0):this.wholeField.getValue()?this.wholeField.setValue(!1):
(this.reloadStartTimeStore(),b.day!=b.eday?this.reloadEndTimeStore():this.reloadEndTimeStore(b.startRow));this.repeatStartField.setValue(b.day);this.startTimeField.setValue(b.startRow);this.endTimeField.setValue(b.endRow);this.subjectField.setValue(b.subject);this.contentField.setValue(b.content);this.startDayField.setValue(b.day);this.endDayField.setValue(b.eday);var c="no",d=b.repeatType;if(d&&"string"!=Ext.type(d))c=d.rtype;"exception"==c&&(c="no");this.repeatTypeField.setValue(c);this.resetRepeatSetting(c,
b);b.alertFlag?this.alertCB.setValue(!0):this.alertCB.setValue(!1);b.locked?this.lockCB.setValue(!0):this.lockCB.setValue(!1);this.reloadCalendar(a);this.calendarField.setValue(b.calendarId);this.oldColor=a.calendarSet[b.calendarId].color}else this.wholeField.setValue(!0);this.generalForm.doLayout();this.repeatForm.doLayout()},reloadCalendar:function(a){var b=this.calendarField.store;b.removeAll();for(var c in a.calendarSet){var d=a.calendarSet[c];!0!==d.hide&&(d=new b.recordType({id:d.id,title:d.name,
description:d.description,color:d.color}),b.add(d))}}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.Editor=function(a){Ext.apply(this,a);this.ehandler.applyCalendarSetting(this);a=this.ehandler.lang.Editor;this.timeField=new Ext.util.LabelField({fieldLabel:a["startDayField.label"],anchor:"99%"});this.subjectField=new Ext.form.TextField({fieldLabel:a["subjectField.label"],anchor:"99%"});this.contentField=new Ext.form.TextArea({fieldLabel:a["contentField.label"],height:80,anchor:"99%"});var b='<tpl for="."><div class="x-combo-list-item">'+this.ehandler.cTplStr+"</div></tpl>";this.calendarField=
new Ext.form.ComboBox({fieldLabel:a["calendarField.label"],store:Ext.ux.calendar.Mask.getCalendarStore(),displayField:"title",valueField:"id",typeAhead:!0,mode:"local",triggerAction:"all",selectOnFocus:!0,allowBlank:!1,anchor:"99%",editable:!1,tpl:b,initList:function(){Ext.form.ComboBox.prototype.initList.call(this);this.list.setZIndex(999999)}});this.alertCB=new Ext.form.Checkbox({anchor:"99%",disabled:!0,boxLabel:a["alertCB.label"],hidden:!0});this.deleteBtn=new Ext.Button({iconCls:"icon-sys-calendar-delete",
text:a["deleteBtn.text"],disabled:!0,handler:this.onRemoveFn,scope:this});this.saveBtn=new Ext.Button({iconCls:"icon-sys-calendar-accept",text:a["saveBtn.text"],handler:this.onSaveFn,scope:this});this.detailBtn=new Ext.Button({iconCls:"icon-sys-calendar-detail",text:a.detailSetting,handler:this.onDetailFn,scope:this});this.cancelBtn=new Ext.Button({iconCls:"icon-sys-calendar-cancel",minWidth:80,text:a["cancelBtn.text"],handler:this.onCancelFn,scope:this});this.formpanel=new Ext.form.FormPanel({border:!1,
style:"padding:10px;",labelWidth:75,frame:!0,items:[this.timeField,this.subjectField,this.contentField,{border:!1,layout:"column",items:[{columnWidth:0.7,border:!1,layout:"form",items:[this.calendarField]},{columnWidth:0.3,border:!1,items:[this.alertCB]}]}],buttonAlign:"center",buttons:[this.detailBtn,this.deleteBtn,this.saveBtn,this.cancelBtn]});Ext.ux.calendar.Editor.superclass.constructor.call(this,{style:"left:-1000px;top:-1000px;",title:" ",width:460,height:250,baseCls:"x-tip",closable:!0,closeAction:"onCancelFn",
resizable:!1,frame:!0,layout:"fit",floating:{shadow:!0,shim:!0,useDisplay:!0,constrain:!1},items:[this.formpanel]});this.addEvents("showdetailsetting","hided","hideeditor","showed");this.on("render",this.onRenderFn,this);this.on("showed",this.onShowFn,this);this.on("hided",this.onHideFn,this);this.on("hideeditor",this.onHideEditorFn,this);this.calendarField.on("select",this.onCalendarSelectFn,this)};
Ext.extend(Ext.ux.calendar.Editor,Ext.Panel,{initComponent:function(){Ext.ux.calendar.Editor.superclass.initComponent.call(this);this.closable&&!this.title&&(this.elements+=",header")},afterRender:function(){Ext.ux.calendar.Editor.superclass.afterRender.call(this);this.closable&&this.addTool({id:"close",handler:this[this.closeAction],scope:this})},onRenderFn:function(a){a.getEl().on("mousedown",function(){this.mdFlag=!0},this);a.getEl().on("mouseup",function(a){delete this.mdFlag;a.stopPropagation()},
this)},onDetailFn:function(){this.hideEditor();this.fireEvent("showdetailsetting",this.obj)},onCalendarSelectFn:function(a,b){var c=this.bindEl;if(c&&!c.hold)for(var d=c.bindEvent,e=c.cview,g=e.ehandler,f=g.calendarSet[b.data.id].color,h=Ext.DomQuery.select("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",e.body.dom),i=0,j=h.length;i<j;i++)c=Ext.get(h[i]),0==d.startRow&&this.rowCount==d.endRow?this.oldColor!=f&&g.changeWholeColor(c,this.oldColor,f):this.oldColor!=f&&(e instanceof Ext.ux.calendar.DayView?
g.changeEventColor(c,this.oldColor,f):g.changeLegendColor(c,this.oldColor,f));this.oldColor=f},onRemoveFn:function(){var a=this.bindEl,b=a.bindEvent,c=a.cview,d=c.ehandler,e=a.col,g=d.lang.EventHandler;a&&("string"==Ext.type(b.repeatType)?(d.freeEventEl(a),d.deleteEvent(b,c,e)):Ext.Msg.show({title:g["deleteRepeatPopup.title"],msg:g["deleteRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(e){"yes"==e?(d.freeEventEl(a),d.deleteRepeatEvent(b,c)):"no"==e&&(d.freeEventEl(a),d.deleteRepeatEvent(b,
c,!0))},icon:Ext.MessageBox.QUESTION}));c.fireEvent("canceldetail");this.hideEditor()},onSaveFn:function(){if(this.formpanel.form.isValid()){var a=this.ehandler,b=this.cview;if(this.bindEl){var c=this.bindEl,d=c.bindEvent,e=Ext.apply({},d);"add"==this.action&&!c.hold&&c.remove();d.repeatType=d.repeatType||"no";d.allDay=!1;d.alertFlag=this.alertCB.checked;if(!d.locked)d.locked=!1;d.subject=this.subjectField.getValue();d.content=this.contentField.getValue();d.calendarId=this.calendarField.getValue();
d.color=a.calendarSet[d.calendarId].color;if("add"==this.action)"string"==Ext.type(d.repeatType)?a.createEvent(d,b):a.createRepeatEvent(d,b);else if("update"==this.action)"string"==Ext.type(e.repeatType)&&"string"==Ext.type(d.repeatType)?a.updateEvent(d,b,null,e,this.noLayout):"string"==Ext.type(d.repeatType)?(c=a.lang.EventHandler,Ext.Msg.show({title:c["updateRepeatPopup.title"],msg:c["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(c){if("yes"==c)a.updateRepeatEvent(d,b,e);else if("no"==
c)d.repeatType="exception",a.updateRepeatEvent(d,b,e)},icon:Ext.MessageBox.QUESTION})):a.updateRepeatEvent(d,b,e)}b.fireEvent("canceldetail");this.hideEditor()}},onCancelFn:function(){var a=this.bindEl;if(a){var b=this.cview,c=a.bindEvent,d=this.ehandler;if(!a.hold)if("add"==this.action)a.remove();else{var e=d.calendarSet[c.calendarId].color;0==c.startRow&&this.rowCount==c.endRow?this.oldColor!=e&&d.changeWholeColor(a,this.oldColor,e):this.oldColor!=e&&(b instanceof Ext.ux.calendar.DayView?d.changeEventColor(a,
this.oldColor,e):d.changeLegendColor(a,this.oldColor,e))}this.hideEditor()}},popup:function(a){var b=this.ehandler;b.floating=!0;this.obj=a;this.noLayout=a.noLayout;this.bindEl=a.bindEl;this.cview=a.cview;this.action=a.action;a=b.lang.Editor;"add"==this.action?(this.deleteBtn.disable(),this.setIconClass("x-event-editor-title-add"),this.setTitle(a["new.title"])):(this.deleteBtn.enable(),this.setTitle(a["edit.title"]),this.setIconClass("x-event-editor-title-edit"));this.showAt(this.adjustXY(this.bindEl))},
adjustXY:function(a){var b=a.getXY(),c=a.cview,a=[0,0],d=this.width,e=this.height,g=b[0]+d;a[0]=b[0];var f=c.body.getRight();g>f&&(a[0]=f-d);a[1]=b[1]-e;c=c.body.getTop();a[1]<c&&(a[1]=b[1]>c?b[1]+20:c+20);return a},reloadCalendar:function(a){var b=this.calendarField.store;b.removeAll();for(var c in a.calendarSet){var d=a.calendarSet[c];!0!==d.hide&&(d=new b.recordType({id:d.id,title:d.name,description:d.description,color:d.color}),b.add(d))}},onShowFn:function(){var a=this.ehandler;if(this.bindEl){var b=
this.bindEl;b.hold||a.setEditingStatus(b,!0);b=b.bindEvent;this.timeField.setText("<b>"+a.generateInfo(b)+"</b>");this.subjectField.setValue(b.subject);this.contentField.setValue(b.content);b.alertFlag?this.alertCB.setValue(!0):this.alertCB.setValue(!1);this.reloadCalendar(a);this.calendarField.setValue(b.calendarId);this.oldColor=a.calendarSet[b.calendarId].color}},onHideFn:function(){this.ehandler.floating=!1;var a=this.cview;this.bindEl&&a.resetSCover();delete this.bindEl;delete this.cview;delete this.noLayout;
delete this.action},hideEditor:function(){if(!this.hided)this.hided=!0,this.showAt([-1E3,-1E3],!0),this.fireEvent("hided")},showAt:function(a,b){b||(this.fireEvent("showed"),delete this.hided);this.setPagePosition(a[0],a[1])},onHideEditorFn:function(){if(!this.mdFlag)this.onCancelFn()}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.EventHandler=function(a){Ext.apply(this,a);this.applyCalendarSetting(this);this.calendarSet={};this.dayCache={};this.id=Ext.id();Ext.ux.calendar.EventHandler.superclass.constructor.call(this);this.calendarLayout=new Ext.ux.calendar.CalendarLayout({ehandler:this});if(a=this.ds.initialObj){for(var b=0,c=a.owned.length;b<c;b++){var d=a.owned[b];this.calendarSet[d.id]=d}b=0;for(c=a.shared.length;b<c;b++)d=a.shared[b],this.calendarSet[d.id]=d;this.calendarLayout.repeatSet=a.re}this.detailTpl=
new Ext.XTemplate('<div class="x-event-detail-ct"><div class="x-event-detail-title"><table width="100%" border="0"><tbody><tr><td class="x-event-detail-title-td">{title}</td><td class="x-event-detail-tool"><img class="x-event-detail-tool-close" src="'+Ext.BLANK_IMAGE_URL+'"></img></td></tr></tbody></table></div><div class="x-event-detail-viewer"></div><div class="x-event-detail-foot"><table width="100%" border="0"><tbody><tr><td class="x-event-detail-foot-tool"><img class="x-event-detail-foot-info" src="'+
Ext.BLANK_IMAGE_URL+'"></img></td><td><b class="x-event-detail-foot-text"></b></td></tr></tbody></table></div></div>');this.eventTpl=new Ext.XTemplate('<div eid="{id}" name="x-event-{day}-{eday}-{id}" class="'+this.id+"-x-calendar-{calendarId}-event x-event-cover "+this.id+'-x-calendar-{calendarId} x-calendar-event" style="{cover-style}" unselectable="on" onselectstart="return false;"><div style="height:18px;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td style="{left-style}"><div class="x-calendar-{color}-event-ltcorner-clear  x-event-lt-default">&nbsp;</div></td><td><div class="x-calendar-{color}-event-top-clear x-event-inner x-event-title-default" style="{title-style}"><b qtip="{time}<br><b><u>{subject}</u></b><br>{content}">{title}</b></div></td><td style="{right-style}"><div class="x-calendar-{color}-event-rtcorner-clear  x-event-rt-default">&nbsp;</div></td></tr></tbody></table></div><div class="x-calendar-{color}-event-lr x-event-content-default" style="{content-style}"><img class="x-calendar-event-pin-off x-event-pin" src="'+
Ext.BLANK_IMAGE_URL+'"></img><tpl if="this.isRepeat(repeatType)"><img class="x-repeat-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isException(repeatType)"><img class="x-exception-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isAlert(alertFlag)"><img class="x-alert-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isLocked(locked)"><img class="x-locked-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><u class="x-event-content-link" qtip="{time}<br><b><u>{subject}</u></b><br>{content}">{subject}</u><br>{content}</div><div><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td style="{left-style}"><div class="x-calendar-{color}-event-lbcorner">&nbsp;</div></td><td><div style="{bottom-style}" class="x-calendar-{color}-event-bottom x-event-bottom-default">&nbsp;</div></td><td style="{right-style}"><div class="x-calendar-{color}-event-rbcorner">&nbsp;</div></td></tr></tbody></table></div></div>',
{isRepeat:function(a){return"string"!=Ext.type(a)},isException:function(a){return"exception"==a},isAlert:function(a){return a},isLocked:function(a){return a}});this.eventTpl.compile();this.legendTpl=new Ext.XTemplate('<div eid="{id}" name="x-event-{day}-{eday}-{id}" class="'+this.id+"-x-calendar-{calendarId}-legend x-legend-cover "+this.id+'-x-calendar-{calendarId} x-calendar-event" unselectable="on" onselectstart="return false;"><b class="x-legend-title-b x-legend-title-{color}" qtip="{time}<br><b><u>{subject}</u></b><br>{content}"><tpl if="this.isRepeat(repeatType)"><img class="x-repeat-event" src="'+
Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isException(repeatType)"><img class="x-exception-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isAlert(alertFlag)"><img class="x-alert-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isLocked(locked)"><img class="x-locked-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl>{title} {subject}</b></div>',{isRepeat:function(a){return"string"!=Ext.type(a)},isException:function(a){return"exception"==a},isAlert:function(a){return a},
isLocked:function(a){return a}});this.legendTpl.compile();this.wholeTpl=new Ext.XTemplate('<div eid="{id}" name="x-event-{day}-{eday}-{id}" class="'+this.id+"-x-calendar-{calendarId}-whole x-whole-cover "+this.id+'-x-calendar-{calendarId} x-calendar-event" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-whole-td"><div class="x-calendar-{color}-whole-left x-whole-left">&nbsp;</div><tpl if="this.isLeftJoin(lflag)"><div class="x-whole-left-join"></div></tpl></td><td class="x-whole-title-{color} x-whole-title">&nbsp;<b class="x-whole-title-b" qtip="{time}<br><b><u>{subject}</u></b><br>{content}"><tpl if="this.isRepeat(repeatType)"><img class="x-repeat-white-event" src="'+
Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isException(repeatType)"><img class="x-exception-white-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isAlert(alertFlag)"><img class="x-alert-white-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl><tpl if="this.isLocked(locked)"><img class="x-locked-white-event" src="'+Ext.BLANK_IMAGE_URL+'"></img> </tpl>{subject}</b></td><td class="x-whole-td"><div class="x-calendar-{color}-whole-right x-whole-right">&nbsp;</div><tpl if="this.isRightJoin(rflag)"><div class="x-whole-right-join"></div></tpl></td></tr></tbody></table></div>',
{isLeftJoin:function(a){return a},isRightJoin:function(a){return a},isRepeat:function(a){return"string"!=Ext.type(a)},isException:function(a){return"exception"==a},isAlert:function(a){return a},isLocked:function(a){return a}});this.wholeTpl.compile();this.cTplStr='<div id="'+this.id+'-x-calendar-{calendarId}" class="'+this.id+'-x-calendar-{calendarId}-whole x-calendar-cover" unselectable="on" onselectstart="return false;"><div class="x-calendar-title-b" style="width:135px;"><b>{title}</b></div><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="x-calendar-td"><div class="x-calendar-{color}-whole-left x-whole-left">&nbsp;</div></td><td class="x-whole-title-{color} x-calendar-title">&nbsp;</td><td class="x-calendar-td"><div class="x-calendar-{color}-whole-right x-whole-right">&nbsp;</div></td></tr></tbody></table></div>';
this.calendarDropTpl=new Ext.XTemplate('<div class="x-calendardrop-cover" hidefocus="true" unselectable="on" onselectstart="return false;"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td>'+this.cTplStr+'</td><td class="x-legend-tool-td"><div class="x-legend-tool"></div></td></tr></tbody></table><div>');this.calendarDropTpl.compile();this.calendarTpl=new Ext.XTemplate(this.cTplStr);this.calendarTpl.compile();this.initMenu();this.initContextMenu();this.addEvents("calendarloaded",
"reloadCalendar","createEvent","updateEvent","deleteEvent","changeDay","deleteCalendar","clearCalendar","changeEventCache","changeCalendarColor");this.on("reloadCalendar",this.reloadCalendar,this);this.on("changeCalendarColor",this.onChangeCalendarColorFn,this);this.on("changeEventCache",this.onChangeEventCacheFn,this)};
Ext.extend(Ext.ux.calendar.EventHandler,Ext.util.Observable,{ss:[],hourFormat:"",baseIndex:100,widthRatio:0.95,posRatio:1.05,applyCalendarSetting:function(a){var b=Ext.apply({},this.calendarSetting);delete b.dayFormat;delete b.weekFormat;delete b.monthFormat;Ext.apply(a,b)},onChangeCalendarColorFn:function(){},onChangeEventCacheFn:function(){},showMenu:function(a,b){if(this.menu){this.menu.calendarEl=a;var c=this.lang.EventHandler;!0===this.calendarSet[a.calendar.id].hide?(this.viewItem.setText(c["viewItem.show.text"]),
this.viewItem.setIconClass("icon-sys-calendar-calendar_show")):(this.viewItem.setText(c["viewItem.hide.text"]),this.viewItem.setIconClass("icon-sys-calendar-calendar_hide"));var c=0,d;for(d in this.calendarSet)c++;1>=c?this.deleteItem.hide():this.deleteItem.show();if(this.readOnly){d=2;for(c=this.menu.items.getCount();d<c;d++)this.menu.items.get(d).hide()}this.menu.bindEl=b;this.menu.show(b,this.menuAlign)}return this},onMenuShowFn:function(a){var b=a.calendarEl.calendar;b.id==0?(a.items.get(2).disable(),
a.items.get(3).disable()):(a.items.get(2).enable(),a.items.get(3).enable());if(b=Ext.ux.calendar.Mask.getColorByIndex(b.color))a.palette.still=!0,a.palette.select("#"+b),delete a.palette.still},hideMenu:function(){this.menu&&this.menu.hide();return this},showContextMenu:function(a,b){a.stopEvent();if(this.cmenu)this.cmenu.eventEl=b,b.bindEvent.locked?(this.editItem.hide(),this.lockItem.hide(),this.unlockItem.show()):(this.editItem.show(),this.lockItem.show(),this.unlockItem.hide()),this.cmenu.showAt(a.getXY())},
hideContextMenu:function(){this.cmenu&&this.cmenu.hide();return this},initMenu:function(){var a=this.lang.EventHandler;this.showOnlyItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-calendar_show",text:a["showOnlyItem.text"],handler:this.onShowOnlyFn,scope:this});this.viewItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-calendar_hide",text:a["viewItem.hide.text"],handler:this.onViewFn,scope:this});this.editItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-calendar_edit",text:a["editItem.text"],
handler:this.onEditFn,scope:this});this.deleteItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-delete",text:a["deleteItem.text"],handler:this.onDeleteFn,scope:this});this.clearItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-clear_event",text:a["clearItem.text"],handler:this.onClearFn,scope:this});a=new Ext.ColorPalette({});this.menu=new Ext.menu.Menu({cls:"x-calendar-menu",items:[this.showOnlyItem,this.viewItem,this.editItem,this.deleteItem,this.clearItem,"-",a]});this.menu.palette=a;this.menu=
Ext.menu.MenuMgr.get(this.menu);this.menu.palette.colors=Ext.ux.calendar.Mask.colors;this.menu.palette.on("select",this.onCalendarColorChangedFn,this);this.menu.on("show",this.onMenuShowFn,this)},initContextMenu:function(){var a=this.lang.EventHandler;this.lockItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_lock",text:a["lockItem.text"],handler:this.onLockEventFn,scope:this});this.unlockItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_unlock",text:a["unlockItem.text"],handler:this.onUnlockEventFn,
scope:this});this.editItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-event_edit",text:a["editEvent.title"],handler:this.onEditEventFn,scope:this});this.deleteItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-delete",text:a["deleteEvent.title"],handler:this.onDeleteEventFn,scope:this});this.cmenu=new Ext.menu.Menu({items:[this.lockItem,this.unlockItem,this.editItem,this.deleteItem]});this.cmenu=Ext.menu.MenuMgr.get(this.cmenu)},onLockEventFn:function(a){var a=a.parentMenu.eventEl,b=a.cview,c=
b.ehandler,d=a.bindEvent,e=Ext.apply({},d);d.locked=!0;"string"==Ext.type(d.repeatType)?c.updateEvent(d,b):(a=c.lang.EventHandler,Ext.Msg.show({title:a["updateRepeatPopup.title"],msg:a["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(a){"yes"==a?c.updateRepeatEvent(d,b,e):"no"==a?(d.repeatType="exception",c.updateRepeatEvent(d,b,e)):d.locked=!1},icon:Ext.MessageBox.QUESTION}))},onUnlockEventFn:function(a){var a=a.parentMenu.eventEl,b=a.cview,c=b.ehandler,d=a.bindEvent,e=Ext.apply({},
d);d.locked=!1;"string"==Ext.type(d.repeatType)?c.updateEvent(d,b):(a=c.lang.EventHandler,Ext.Msg.show({title:a["updateRepeatPopup.title"],msg:a["updateRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(a){"yes"==a?c.updateRepeatEvent(d,b,e):"no"==a?(d.repeatType="exception",c.updateRepeatEvent(d,b,e)):d.locked=!0},icon:Ext.MessageBox.QUESTION}))},onEditEventFn:function(a){var a=a.parentMenu.eventEl,b=a.cview;b.ehandler.showEditor(a,b,"update")},onDeleteEventFn:function(a){var b=a.parentMenu.eventEl,
c=b.cview,d=c.ehandler,e=b.bindEvent,a=d.lang.EventHandler;"string"==Ext.type(e.repeatType)?(d.freeEventEl(b),d.deleteEvent(e,c,b.col)):Ext.Msg.show({title:a["deleteRepeatPopup.title"],msg:a["deleteRepeatPopup.msg"],buttons:Ext.Msg.YESNOCANCEL,fn:function(a){"yes"==a?(d.freeEventEl(b),d.deleteRepeatEvent(e,c)):"no"==a&&(d.freeEventEl(b),d.deleteRepeatEvent(e,c,!0))},icon:Ext.MessageBox.QUESTION})},onClearFn:function(a){var b=this.lang.EventHandler;Ext.Msg.confirm(b["clearCalendar.title"],b["clearCalendar.msg"],
function(b){if(b=="yes"){var d=a.parentMenu.calendarEl.calendar,e=d.id;this.ds.deleteEventsByCalendar(e,function(){delete this.calendarSet[e];var a=this.mainPanel.calendarContainer.currentView;this.calendarLayout.resetLayout({hideCalendar:!1,deleteCalendar:!0},!0);a.checkLayout();this.fireEvent("changeEventCache",this);this.calendarSet[e]=d},this)}},this)},onDeleteFn:function(a){var b=this.lang.EventHandler;Ext.Msg.confirm(b["deleteCalendar.title"],b["deleteCalendar.msg"],function(b){if(b=="yes"){var d=
a.parentMenu.calendarEl,e=d.calendar.id;this.ds.deleteCalendar(e,function(){delete this.calendarSet[e];var a=this.mainPanel.calendarContainer.currentView;this.calendarLayout.resetLayout({hideCalendar:!1,deleteCalendar:!0},!0);a.checkLayout();this.fireEvent("changeEventCache",this);d.remove()},this)}},this)},copyCalendarSet:function(){var a={},b=this.calendarSet,c;for(c in b)a[c]=Ext.apply({},b[c]);return a},onShowAllFn:function(){var a=this.mainPanel.calendarContainer.getLayout().activeItem;this.ds.showAllCalendar(function(){var b=
this.calendarSet,c;for(c in b){var d=b[c];d.hide=!1;this.showCalendarColor(Ext.get(this.id+"-x-calendar-"+c),d.color)}this.calendarLayout.resetLayout({hideCalendar:!0,deleteCalendar:!1},!0);a.checkLayout()},this)},onShowOnlyFn:function(a){var b=this.mainPanel.calendarContainer.getLayout().activeItem,c=a.parentMenu.calendarEl,d=c.calendar,e=d.id;d.hide=!1;this.ds.showOnlyCalendar(e,function(){this.showCalendarColor(c,d.color);var a=this.calendarSet,f;for(f in a)if(f!=e){var h=a[f];h.hide=!0;this.hideCalendarColor(Ext.get(this.id+
"-x-calendar-"+f),h.color)}this.calendarLayout.resetLayout({hideCalendar:!0,deleteCalendar:!1},!0);b.checkLayout()},this)},onViewFn:function(a){var b=a.parentMenu.calendarEl,c=b.calendar,d=this.lang.EventHandler;c.hide=!c.hide;this.ds.createUpdateCalendar(c,function(){d["viewItem.hide.text"]==a.text?(a.setText(d["viewItem.show.text"]),this.hideCalendar(c,!0),this.hideCalendarColor(b,c.color)):(a.setText(d["viewItem.hide.text"]),this.hideCalendar(c,!1),this.showCalendarColor(b,c.color))},this)},hideCalendar:function(a,
b){var c=a.id,d=this.mainPanel.calendarContainer.currentView;a.hide=b;this.calendarSet[c].hide=b;this.calendarLayout.resetLayout({hideCalendar:!0,deleteCalendar:!1},!0);d.checkLayout()},onEditFn:function(a){a=a.parentMenu.calendarEl;this.ceditor.popup({data:a.calendar,cEl:a})},prepareLegend:function(a,b,c,d){var e=d.ehandler,b=b.x*d.shiftDay+b.y,c=c.x*d.shiftDay+c.y,g=b;b>c&&(b=c,c=g);var f,h;for(h in e.calendarSet)if(f=e.calendarSet[h],!0!==f.hide)break;e={eventId:"prepare",calendarId:f.id,color:f.color,
startRow:0,endRow:this.rowCount,day:d.daySet[b].format("Y-m-d"),eday:d.daySet[c].format("Y-m-d"),repeatType:"no"};a.hold=!0;a.cview=d;a.bindEvent=e;this.showEditor(a,d,"add")},prepareEvent:function(a,b){var c=b.getCellIndex(a.dom.id),d=b.ehandler,e=c.x,c=c.y,g,f;for(f in d.calendarSet)if(g=d.calendarSet[f],!0!==g.hide)break;d={eventId:"prepare",calendarId:g.id,color:g.color,startRow:e,endRow:e+this.numInHour,day:b.daySet[c].format("Y-m-d"),eday:b.daySet[c].format("Y-m-d"),span:1,colIndex:0,repeatType:"no"};
return this.renderEvent(b,[d],c,!0)},generateInfo:function(a){var b=a.startRow,c=a.endRow;0==b&&this.rowCount==c?(b=a.day,a.day!=a.eday&&(b+=" to "+a.eday),b+=" "+this.lang.EventHandler.wholeDay):(b=a.day+" "+Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,b,this.hourFormat)+" to ",a.day!=a.eday&&(b+=a.eday+" "),b+=Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,c,this.hourFormat));return b},generateTitle:function(a){var b=a.startRow,a=a.endRow;return 0==b&&this.rowCount==a?this.lang.EventHandler.wholeDay:
Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,b,this.hourFormat)+"-"+Ext.ux.calendar.Mask.getIntervalFromRow(this.intervalSlot,a,this.hourFormat)},getContentEl:function(a){return a.child(".x-event-content-default")},getTitleEl:function(a){return a.child(".x-event-title-default")},getBottomEl:function(a){return a.child(".x-event-bottom-default")},getLeftTopEl:function(a){return a.child(".x-event-lt-default")},getRightTopEl:function(a){return a.child(".x-event-rt-default")},renderEvent:function(a,
b,c,d){for(var e=a.cbody.getLeft(),g=a.cbody.getTop(),f,h=0,i=b.length;h<i;h++)for(var j=b[h],j=Ext.DomQuery.select("div[eid="+j.eventId+"]",a.body.dom),n=0,k=j.length;n<k;n++){var m=Ext.get(j[n]);if(m.col==c||m.nol==c){if(this.editingId==m.dom.id)delete this.editingId,this.editDisabled=!1;this.freeEventEl(m)}}h=0;for(i=b.length;h<i;h++){j=b[h];n=Ext.get(a.id+"-x-dayview-viewer-"+j.startRow+"-"+c);k=n.getLeft();f=n.getWidth();var o=Math.round(f*a.offsetPercent),l=f-o;d&&(l=f);var p=n.getTop();f=(n.getHeight()+
1)*(j.endRow-j.startRow)-24;m=l/Math.pow(j.span,this.posRatio)*j.colIndex;l-=m;o=Math.round(k-e+o+m);d&&(o=Math.round(k-e+m));k=Math.round(p-g);m=!0==j.last&&0!=j.colIndex?1:Math.pow(this.widthRatio,j.span-1-j.colIndex);p=Math.floor(l*m);m=p-5-5;k="top:"+k+"px;left:"+o+"px;width:"+p+"px;z-index:"+(this.baseIndex+j.colIndex)+";";f="height:"+f+"px;";Ext.isIE&&(f+="width:"+p+"px;");o="width:"+m+"px;";m="width:"+m+"px;";p=j.subject||"";if(""===p.trim())p=this.lang.EventHandler.untitled;l=j.color;if(this.calendarSet)l=
this.calendarSet[j.calendarId].color;f=this.eventTpl.apply({id:j.eventId,calendarId:j.calendarId,color:l,"cover-style":k,"content-style":f,"title-style":o,"bottom-style":m,"left-style":"width:5px;","right-style":"width:5px;",title:this.generateTitle(j),time:this.generateInfo(j),subject:p,content:j.content||"",day:j.day,eday:j.eday,repeatType:j.repeatType,alertFlag:j.alertFlag,locked:j.locked});f=Ext.DomHelper.insertHtml("beforeEnd",n.dom,f);if(f=Ext.get(f))k=this.getContentEl(f),m=this.getTitleEl(f),
o=this.getBottomEl(f),p=this.getLeftTopEl(f),l=this.getRightTopEl(f),j.eId=f.id,f.bindEvent=Ext.apply({},j),f.cview=a,f.col=c,f.cEl=n,f.titleEl=m,f.contentEl=k,f.bottomEl=o,f.ltEl=p,f.rtEl=l,f.leftStyle=5,f.rightStyle=5,k.coverEl=f,k.bindEvent=Ext.apply({},j),k.cview=a,k.cEl=n,k.col=c}a.resizePort();this.floating=!1;return f},getIndexFromDay:function(a,b){return a.getIndexFromDay(b)},createEvent:function(a,b,c){this.ds.createEvent(a,function(d){a.eventId=d.id;this.createEventToLayout(a,b,c);this.fireEvent("changeEventCache",
this)},this)},createEventToLayout:function(a,b,c){!1===Ext.type(c)&&(c=this.getIndexFromDay(b,a.day));var d=this.calendarLayout;if(0==a.startRow&&this.rowCount==a.endRow||a.day!=a.eday)d.updateWholeList([a],"add"),b.checkLayout(Ext.isIE);else if(d=d.getLayout(a.day,b))a=d.updateLayout(a,"add"),b instanceof Ext.ux.calendar.DayView?this.renderEvent(b,a.elist,c):b.checkLayout()},createRepeatEvent:function(a,b){this.ds.createUpdateRepeatEvent(a,null,function(c){a.eventId=c.id;this.calendarLayout.updateRepeatEventList(b,
[a],"add");this.fireEvent("changeEventCache",this)},this)},updateEvent:function(a,b,c,d,e){this.ds.updateEvent(a,function(){"function"===Ext.type(e)&&e(a);var g=0==a.startRow&&this.rowCount==a.endRow||a.day!=a.eday,f=!1,h,i=this.calendarLayout;if(d){!1===Ext.type(c)&&(c=this.getIndexFromDay(b,d.day));var f=0==d.startRow&&this.rowCount==d.endRow||d.day!=d.eday,j=this.calendarLayout.getLayout(d.day,b);if(d.day!=a.day){if(h=this.getIndexFromDay(b,a.day),j=j.updateLayout(d,"delete"),j.elist&&b instanceof
Ext.ux.calendar.DayView){for(var n=Ext.DomQueryselect("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",b.body.dom),k=0,m=n.length;k<m;k++)this.freeEventEl(Ext.get(n[k]));this.renderEvent(b,j.elist,c)}}else if(h=c,f!=g&&(j=j.updateLayout(d,"delete"),j.elist&&b instanceof Ext.ux.calendar.DayView)){n=Ext.DomQuery.select("div[name=x-event-"+d.day+"-"+d.eday+"-"+d.eventId+"]",b.body.dom);k=0;for(m=n.length;k<m;k++)this.freeEventEl(Ext.get(n[k]));this.renderEvent(b,j.elist,c)}}else h=!1==Ext.type(c)?
this.getIndexFromDay(b,a.day):c;if(g)i.updateWholeList([a],"update");else if(i=i.getLayout(a.day,b))j=i.updateLayout(a,"update"),!1!=Ext.type(h)&&j.elist&&b instanceof Ext.ux.calendar.DayView&&this.renderEvent(b,j.elist,h);(f||g)&&b instanceof Ext.ux.calendar.DayView&&b.checkLayout(Ext.isIE);b instanceof Ext.ux.calendar.MonthView&&b.checkLayout(!0);this.fireEvent("changeEventCache",this)},this)},deleteEvent:function(a,b,c){this.ds.deleteEvent(a,function(){this.deleteEventFromLayout(a,b,c);Ext.isIE&&
(a.day!=a.eday||0==a.startRow&&this.rowCount==a.endRow)&&b.checkLayout(!0);this.fireEvent("changeEventCache",this)},this)},deleteEventFromLayout:function(a,b,c){var d=this.calendarLayout;if(0==a.startRow&&this.rowCount==a.endRow||a.day!=a.eday)d.updateWholeList([a],"delete"),b.checkLayout();else if(d=d.getLayout(a.day,b))a=d.updateLayout(a,"delete"),!1!=Ext.type(c)&&b instanceof Ext.ux.calendar.DayView&&this.renderEvent(b,a.elist,c)},deleteRepeatEvent:function(a,b,c){if(c){var d=a.repeatType.exceptions||
{};d[a.day]=!0;a.repeatType.exceptions=d}this.ds.deleteRepeatEvent(a,c,function(){var d=this.calendarLayout;c?d.updateRepeatEventList(b,[a],"update"):d.updateRepeatEventList(b,[a],"delete");this.fireEvent("changeEventCache",this)},this)},showEditor:function(a,b,c,d){this.editor.popup({bindEl:a,cview:b,action:c,noLayout:d})},setPinOn:function(a){a=a.child("img");a.removeClass("x-calendar-event-pin-off");a.addClass("x-calendar-event-pin-on")},setPinOff:function(a){a=a.child("img");a.removeClass("x-calendar-event-pin-on");
a.addClass("x-calendar-event-pin-off")},onPinElClickFn:function(a){a.stopEvent();a=a.getTarget();a=Ext.get(a);a.hasClass("x-calendar-event-pin-off")?(a.removeClass("x-calendar-event-pin-off"),a.addClass("x-calendar-event-pin-on"),this.editDisabled=!0):(a.removeClass("x-calendar-event-pin-on"),a.addClass("x-calendar-event-pin-off"),this.editDisabled=!1)},setEditingStatus:function(a,b,c){var d=null;a.hasClass("x-event-cover")&&(d="event");var e=Ext.get(this.editingId),g=a.bindEvent,f=a.titleEl,h=a.contentEl,
i=a.bottomEl,j=!1;if(!0!=this.floating)if(!0!==this.editDisabled)j=!0;else if(!0===b){j=!0;if(this.editingId!=a.dom.id)this.editDisabled=!1;e&&this.setPinOff(e)}if(j&&(e&&this.removeEditingStatus(e),this.editingId=a.dom.id,a.setStyle("z-index",3009),d&&a.addClass("x-event-editing"),b=this.calendarSet[g.calendarId].color,a.hasClass("x-event-cover"))){f&&(f.addClass("x-calendar-"+b+"-event-top"),f.removeClass("x-calendar-"+b+"-event-top-clear"));if(e=a.ltEl)e.addClass("x-calendar-"+b+"-event-ltcorner"),
e.removeClass("x-calendar-"+b+"-event-ltcorner-clear");if(e=a.rtEl)e.addClass("x-calendar-"+b+"-event-rtcorner"),e.removeClass("x-calendar-"+b+"-event-rtcorner-clear")}e=b=a.getWidth();a.leftStyle&&a.rightStyle&&(e=b-a.leftStyle-a.rightStyle);f&&d&&f.setWidth(e);Ext.isIE&&h&&d&&h.setWidth(b);i&&i.setWidth(e);if(!1!==Ext.type(c))this.editDisabled=c;this.editDisabled&&this.setPinOn(a)},removeEditingStatus:function(a){var b=a.bindEvent,c=this.baseIndex;b.colIndex&&(c+=b.colIndex);a.setStyle("z-index",
c.toString());a.removeClass("x-event-editing");var c=this.calendarSet[b.calendarId].color,d=a.titleEl;d&&(d.removeClass("x-calendar-"+c+"-event-top"),a.cview instanceof Ext.ux.calendar.DayView&&!(0==b.startRow&&this.rowCount==b.endRow)&&d.addClass("x-calendar-"+c+"-event-top-clear"));if(b=a.ltEl)b.removeClass("x-calendar-"+c+"-event-ltcorner"),b.addClass("x-calendar-"+c+"-event-ltcorner-clear");if(a=a.rtEl)a.removeClass("x-calendar-"+c+"-event-rtcorner"),a.addClass("x-calendar-"+c+"-event-rtcorner-clear")},
generateLegend:function(a,b){var c=b.subject||"";if(""===c.trim())c=this.lang.EventHandler.untitled;var d=b.color;if(this.calendarSet)d=this.calendarSet[b.calendarId].color;return 0==b.startRow&&this.rowCount==b.endRow||b.day!=b.eday?this.wholeTpl.apply({id:b.eventId,lflag:b.lflag||!1,rflag:b.rflag||!1,calendarId:b.calendarId,color:d,title:this.generateTitle(b),time:this.generateInfo(b),subject:c,content:b.content||"",day:b.day,eday:b.eday,repeatType:b.repeatType,alertFlag:b.alertFlag,locked:b.locked}):
this.legendTpl.apply({id:b.eventId,calendarId:b.calendarId,color:d,title:this.generateTitle(b),time:this.generateInfo(b),subject:c,content:b.content||"",day:b.day,eday:b.eday,repeatType:b.repeatType,alertFlag:b.alertFlag,locked:b.locked})},deleteLegend:function(a,b,c){c=b.getCellIndex(c.dom.id);this.calendarLayout.getLayout(b.daySet[c.x*b.dayNum+c.y],b).updateLayout(a,"delete")},createCalendar:function(a,b,c,d){b=this.calendarDropTpl.apply({"legend-style":"height:9px;",title:d.name,calendarId:d.id,
color:d.color});a="beforeBegin"==c?Ext.DomHelper.insertHtml("beforeBegin",a.dom.firstChild,b):Ext.DomHelper.insertHtml("beforeEnd",a.dom,b);if(a=Ext.get(a))a.addClassOnOver("x-calendar-over"),a.calendar=d,this.initCalendar(a);return a},initCalendar:function(a){a.on("click",this.onCalendarElClickFn,{cEl:a,sp:this});a.on("dblclick",this.onCalendarElDblClickFn,{cEl:a,sp:this})},onCalendarElDblClickFn:function(){var a=this.cEl;this.sp.ceditor.popup({data:a.calendar,cEl:a})},onCalendarElClickFn:function(a){var b=
this.sp,c=this.cEl,d=c.calendar,a=Ext.get(a.getTarget());a.hasClass("x-legend-tool")?(b.menu.palette.calendar=d,b.showMenu(c,a)):(d.hide=!d.hide,b.ds.createUpdateCalendar(d,function(){d.hide?(b.hideCalendar(d,!0),b.hideCalendarColor(c,d.color)):(b.hideCalendar(d,!1),b.showCalendarColor(c,d.color))},this))},onCalendarColorChangedFn:function(a,b){!0!==a.still&&((b=Ext.ux.calendar.Mask.getIndexByColor(b))&&this.changeColor(a.calendar,b),this.menu.hide())},changeEventColor:function(a,b,c){var d=a.child(".x-calendar-"+
b+"-event-ltcorner-clear");d&&(d.removeClass("x-calendar-"+b+"-event-ltcorner-clear"),d.addClass("x-calendar-"+c+"-event-ltcorner-clear"));if(d=a.child(".x-calendar-"+b+"-event-ltcorner"))d.removeClass("x-calendar-"+b+"-event-ltcorner"),d.addClass("x-calendar-"+c+"-event-ltcorner");if(d=a.child(".x-calendar-"+b+"-event-rtcorner-clear"))d.removeClass("x-calendar-"+b+"-event-rtcorner-clear"),d.addClass("x-calendar-"+c+"-event-rtcorner-clear");if(d=a.child(".x-calendar-"+b+"-event-rtcorner"))d.removeClass("x-calendar-"+
b+"-event-rtcorner"),d.addClass("x-calendar-"+c+"-event-rtcorner");if(d=a.child(".x-calendar-"+b+"-event-top-clear"))d.removeClass("x-calendar-"+b+"-event-top-clear"),d.addClass("x-calendar-"+c+"-event-top-clear");if(d=a.child(".x-calendar-"+b+"-event-top"))d.removeClass("x-calendar-"+b+"-event-top"),d.addClass("x-calendar-"+c+"-event-top");if(d=a.child(".x-calendar-"+b+"-event-lr"))d.removeClass("x-calendar-"+b+"-event-lr"),d.addClass("x-calendar-"+c+"-event-lr");if(d=a.child(".x-calendar-"+b+"-event-lbcorner"))d.removeClass("x-calendar-"+
b+"-event-lbcorner"),d.addClass("x-calendar-"+c+"-event-lbcorner");if(d=a.child(".x-calendar-"+b+"-event-rbcorner"))d.removeClass("x-calendar-"+b+"-event-rbcorner"),d.addClass("x-calendar-"+c+"-event-rbcorner");if(a=a.child(".x-calendar-"+b+"-event-bottom"))a.removeClass("x-calendar-"+b+"-event-bottom"),a.addClass("x-calendar-"+c+"-event-bottom")},changeWholeColor:function(a,b,c){var d=a.child(".x-whole-title-"+b);d&&(d.removeClass("x-whole-title-"+b),d.addClass("x-whole-title-"+c));if(d=a.child(".x-calendar-"+
b+"-whole-left"))d.removeClass("x-calendar-"+b+"-whole-left"),d.addClass("x-calendar-"+c+"-whole-left");if(a=a.child(".x-calendar-"+b+"-whole-right"))a.removeClass("x-calendar-"+b+"-whole-right"),a.addClass("x-calendar-"+c+"-whole-right")},changeCalendarColor:function(a,b,c){var d,e=a.child(".x-whole-title-"+b);e?(d=!1,e.removeClass("x-whole-title-"+b),e.addClass("x-whole-title-"+c)):(d=!0,(e=a.child(".x-calendar-title-b"))&&e.setStyle("color","#"+Ext.ux.calendar.Mask.getColorByIndex(c)));if(!1==
d){if(d=a.child(".x-calendar-"+b+"-whole-left"))d.removeClass("x-calendar-"+b+"-whole-left"),d.addClass("x-calendar-"+c+"-whole-left");if(a=a.child(".x-calendar-"+b+"-whole-right"))a.removeClass("x-calendar-"+b+"-whole-right"),a.addClass("x-calendar-"+c+"-whole-right")}},hideCalendarColor:function(a,b){var c=a.child(".x-calendar-"+b+"-whole-left");c&&c.removeClass("x-calendar-"+b+"-whole-left");(c=a.child(".x-calendar-"+b+"-whole-right"))&&c.removeClass("x-calendar-"+b+"-whole-right");(c=a.child(".x-whole-title-"+
b))&&c.removeClass("x-whole-title-"+b);if(c=a.child(".x-calendar-title-b")){var d=Ext.ux.calendar.Mask.getColorByIndex(b);c.setStyle("color","#"+d)}},showCalendarColor:function(a,b){var c=a.child(".x-whole-left");c&&c.addClass("x-calendar-"+b+"-whole-left");(c=a.child(".x-whole-right"))&&c.addClass("x-calendar-"+b+"-whole-right");(c=a.child(".x-calendar-title"))&&c.addClass("x-whole-title-"+b);(c=a.child(".x-calendar-title-b"))&&c.setStyle("color","white")},changeLegendColor:function(a,b,c){alert("changeLegendColor");
if(a=a.child(".x-legend-title-"+b))a.removeClass("x-legend-title-"+b),a.addClass("x-legend-title-"+c)},changeColor:function(a,b){var c=a.color;a.color=b;this.ds.createUpdateCalendar(a,function(d){if(d.success||"true"==d.success){this.calendarSet[a.id].color=b;(d=Ext.get(this.id+"-x-calendar-"+a.id))&&this.changeCalendarColor(d,c,a.color);var e=this.mainPanel.body,g=Ext.DomQuery.select("."+this.id+"-x-calendar-"+a.id+"-event",e.dom);if(g)for(var d=0,f=g.length;d<f;d++)this.changeEventColor(Ext.get(g[d]),
c,a.color);if(g=Ext.DomQuery.select("."+this.id+"-x-calendar-"+a.id+"-whole",e.dom)){d=0;for(f=g.length;d<f;d++)this.changeWholeColor(Ext.get(g[d]),c,a.color)}if(e=Ext.DomQuery.select("."+this.id+"-x-calendar-"+a.id+"-legend",e.dom)){d=0;for(f=e.length;d<f;d++)this.changeLegendColor(Ext.get(e[d]),c,a.color)}d=this.mainPanel.calendarContainer.getLayout().activeItem;d instanceof Ext.ux.calendar.ResultView&&d.list.getView().refresh();this.fireEvent("changeCalendarColor",this,a,c,a.color)}},this)},freeEventEl:function(a){a.remove()},
pushDayCache:function(a,b){for(var c=a.format("Y-m-d"),d=a,e=b.format("Y-m-d");c<=e;)this.dayCache[c]=d,d=d.add(Date.DAY,1),c=d.format("Y-m-d")},isInDayCache:function(a,b){for(var c=!0,d=a.format("Y-m-d"),e=a,g=b.format("Y-m-d");d<=g;){if(!this.dayCache[d]){c=!1;break}e=e.add(Date.DAY,1);d=e.format("Y-m-d")}return c},bindEvent2Detail:function(a,b,c){for(var d="",e=0,g=b.length;e<g;e++){var f=b[e];d+=this.generateLegend(this,f)}c.dom.innerHTML=d;e=0;for(g=c.dom.childNodes.length;e<g;e++)f=Ext.apply({},
b[e]),d=Ext.get(c.dom.childNodes[e]),d.bindEvent=f,d.cview=a},updateRepeatEvent:function(a,b,c){if("string"==Ext.type(a.repeatType)){var d=c.repeatType.exceptions||{};d[c.day]=!0;c.repeatType.exceptions=d}this.ds.createUpdateRepeatEvent(a,c,function(d){var g=this.calendarLayout;if(d.id)a.eventId=d.id;"string"==Ext.type(c.repeatType)?(this.deleteEventFromLayout(c,b),g.updateRepeatEventList(b,[a],"update")):"string"==Ext.type(a.repeatType)?(this.createEventToLayout(a,b),"exception"==a.repeatType?g.updateRepeatEventList(b,
[c],"update"):g.updateRepeatEventList(b,[c],"delete")):g.updateRepeatEventList(b,[a],"update");this.fireEvent("changeEventCache",this)},this)},loadRepeatEvent:function(a,b){this.ds.loadRepeatEvent(function(c){this.calendarLayout.repeatSet=c;a.call(b)},this)},getStartDateInWeek:function(a,b){var c;1==this.startDay?(c=a.format("N"),c=a.add(Date.DAY,1-c)):(c=-a.format("w"),(5==b.dayNum&&b instanceof Ext.ux.calendar.DayView||5==b.colNum&&b instanceof Ext.ux.calendar.MonthView)&&c++,c=a.add(Date.DAY,c));
return c},loadCalendar:function(a,b){this.ds.loadCalendar(function(c){var d=c.owned,c=c.shared;this.calendarSet={};if(0<d.length||0<c.length){for(var e,g=0,f=d.length;g<f;g++)e=d[g],this.calendarSet[e.id]=e;g=0;for(f=c.length;g<f;g++)e=c[g],this.calendarSet[e.id]=e;this.loadRepeatEvent(function(){this.fireEvent("calendarloaded")},this);a&&this.renderOwnedCalendar(a);b&&this.renderSharedCalendar(b)}},this)},renderOwnedCalendar:function(a){var b=this.calendarSet;a.dom.innerHTML="";for(var c in b){var d=
b[c];if(!d.isShared){var e=this.createCalendar(a,null,null,d);d.hide&&this.hideCalendarColor(e,d.color)}}},renderSharedCalendar:function(a){var b=this.calendarSet;a.dom.innerHTML="";for(var c in b){var d=b[c];if(d.isShared){var e=this.createCalendar(a,null,null,d);d.hide&&this.hideCalendarColor(e,d.color)}}},reloadCalendar:function(a,b,c){this.dayCache={};this.calendarLayout.layoutSet={};this.calendarLayout.wholeList=[];c?this.loadCalendar(a,b):this.loadRepeatEvent(function(){this.fireEvent("calendarloaded")},
this)}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.Block=function(a){var b={id:0,colNum:0,startRow:100,endRow:-1,eventList:[]};b.addEvent=function(a){if(a.startRow<b.startRow)b.startRow=a.startRow;if(a.endRow>b.endRow)b.endRow=a.endRow;b.eventList[b.eventList.length]=a};Ext.apply(b,a);return b};Ext.ns("Ext.ux.calendar");Ext.ux.calendar.BlockMap=function(a,b){var c={};c.event=a;c.block=b;return c};Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.CalendarLayout=function(a){Ext.apply(this,a);this.layoutSet={};this.wholeList=[];this.repeatSet={};Ext.ux.calendar.CalendarLayout.superclass.constructor.call(this)};
Ext.extend(Ext.ux.calendar.CalendarLayout,Ext.util.Observable,{getWholeList:function(a,b,c,d){var e=this.ehandler,g=e.calendarSet,f=[],h=[],i;if(d)i=e=b;else if(1==a.dayNum)i=e=b;else{i=a.colNum||a.dayNum;var j=Date.parseDate(b,"Y-m-d"),j=e.getStartDateInWeek(j,a),e=j.format("Y-m-d");i=j.add(Date.DAY,i-1).format("Y-m-d")}for(var j=0,n=this.wholeList.length;j<n;j++){var k=this.wholeList[j];if(g[k.calendarId]){if(!g[k.calendarId].hide||c)if(k.day==b||e==b&&k.day<b&&k.eday>=b)k.day<e?k.lflag=!0:delete k.lflag,
k.eday>i?k.rflag=!0:delete k.rflag,f.push(k);h.push(k)}}this.wholeList=h;return f=this.combine2List(this.getRepeatEvent(a,b,!0,c,d),f)},updateWholeList:function(a,b){if(a)if("add"==b)this.wholeList=this.combine2List(this.wholeList,a);else if("update"==b){for(var c=0,d=a.length;c<d;c++)this.deleteFromList(this.wholeList,a[c]);this.wholeList=this.combine2List(this.wholeList,a)}else if("delete"==b){c=0;for(d=a.length;c<d;c++)this.deleteFromList(this.wholeList,a[c])}},deleteFromList:function(a,b){for(var c=
0,d=a.length;c<d;c++)if(a[c].eventId==b.eventId){a.splice(c,1);break}},deleteDayFromWholeList:function(a,b,c){var d=this.ehandler.calendarSet,b=b||a,e,g,f=this.wholeList.length,h=[];for(e=0;e<f;e++){var i=this.wholeList[e];if(i.day>a)return h;else if(!d[i.calendarId].hide&&i.day>=a&&i.eday<=b)break}for(g=e;g<f;g++)if(i=this.wholeList[g],!d[i.calendarId].hide&&i.day>=a&&i.eday<=b)h.push(Ext.apply({},i));else break;c||this.wholeList.splice(e,g-e);return h},changeDayInWholeList:function(a,b,c){var d=
this.ehandler.calendarSet,e,g,f=this.wholeList.length;for(e=0;e<f;e++){var h=this.wholeList[e];if(h.day>a){e=f;break}else if(!d[h.calendarId].hide&&h.day>=a&&h.eday<=a)break}var i=[];for(g=e;g<f;g++)if(h=this.wholeList[g],!d[h.calendarId].hide&&h.day>=a&&h.eday<=a)h=Ext.apply({},h),h.day=b,h.eday=b,i.push(h);else break;c||this.wholeList.splice(e,g-e);this.wholeList=this.combine2List(this.wholeList,i)},getLayout:function(a,b,c,d,e){a instanceof Date&&(a=a.format("Y-m-d"));var g=function(){var d=new Ext.ux.calendar.LayoutGrid({owner:this,
ehandler:this.ehandler,cview:b,day:a,hideCalendar:!0});d.viewChanged=!0;d.generateLayout(c||[]);this.layoutSet[a]=d};if(e)g.call(this);else if(this.layoutSet[a])this.layoutSet[a].viewChanged=this.layoutSet[a].cview!==b?!0:!1,this.layoutSet[a].cview=b;else if(!0==d)g.call(this);else return null;return this.layoutSet[a]},resetSingleLayout:function(a,b,c){a.hideCalendar=b.hideCalendar;a.deleteCalendar=b.deleteCalendar;a.updateRepeat=b.updateRepeat;delete a.layouted;b=a.visited;c&&a.reLayout();if(a.hideCalendar){for(var d in b)b[d]=
"hideCalendar";a.visited=b}else if(a.deleteCalendar){for(d in b)b[d]="deleteCalendar";a.visited=b}else if(a.updateRepeat){for(d in b)b[d]="updateRepeat";a.visited=b}else a.visited={}},resetLayout:function(a,b){for(var c in this.layoutSet)this.resetSingleLayout(this.layoutSet[c],a,b)},checkRepeat:function(a,b,c){for(var d=b.length;c<d;c++){var e=b[c];if(!(e.day==a.day&&e.eday==a.eday&&e.startRow==a.startRow&&e.endRow==a.endRow))break;if(e.eventId==a.eventId)return!0}return!1},combine2List:function(a,
b){var c=[],d=0,e=0;if(a)d=a.length;if(b)e=b.length;var g,f;for(f=g=0;g<d&&f<e;){var h=a[g],i=b[f],j=h.day+"-"+h.startRow,n=h.eday+"-"+h.endRow,k=i.day+"-"+i.startRow,m=i.eday+"-"+i.endRow;j<k||j==k&&n>m?(c.push(h),g++):(this.checkRepeat(i,a,g)||c.push(i),f++)}if(g==d)for(;f<e;f++)i=b[f],c.push(i);if(f==e)for(;g<d;g++)h=a[g],c.push(h);return c},updateRepeatEventList:function(a,b,c){if("add"==c||"update"==c)for(var c=0,d=b.length;c<d;c++){var e=b[c];this.repeatSet[e.eventId]=e}else if("delete"==c){c=
0;for(d=b.length;c<d;c++)e=b[c],delete this.repeatSet[e.eventId]}this.resetLayout({hideCalendar:!1,deleteCalendar:!1,updateRepeat:!0},!0);a.checkLayout()},getRepeatEvent:function(a,b,c,d,e){var g=this.ehandler,f,h,i;c&&(f=Date.parseDate(b,"Y-m-d"),e?i=h=b:1==a.dayNum?i=h=b:(i=a.colNum||a.dayNum,a=g.getStartDateInWeek(f,a),h=a.format("Y-m-d"),i=a.add(Date.DAY,i-1).format("Y-m-d")));var a=[],e={},j=this.repeatSet,n=g.calendarSet,k;for(k in j){var m=j[k],o=n[m.calendarId];if(o){if(!o.hide||d){var l,
o=m.repeatType.dspan;if(c){if(0<o||0==m.startRow&&g.rowCount==m.endRow)if(h==b)for(var p=0;p<=o;p++){if(l=f.add(Date.DAY,-p).format("Y-m-d"),l=Ext.ux.calendar.RepeatType.getEvent(m,l))l.day<h?l.lflag=!0:delete l.lflag,l.eday>i?l.rflag=!0:delete l.rflag,a=this.combine2List(a,[l])}else if(l=Ext.ux.calendar.RepeatType.getEvent(m,b))l.day<h?l.lflag=!0:delete l.lflag,l.eday>i?l.rflag=!0:delete l.rflag,a=this.combine2List(a,[l])}else if(0==o&&(0!=m.startRow||g.rowCount!=m.endRow))(l=Ext.ux.calendar.RepeatType.getEvent(m,
b))&&(a=this.combine2List(a,[l]))}e[m.eventId]=m}}this.repeatSet=e;return a},showWeek:function(a,b,c,d,e){var g=this.ehandler;a.cleanup(c,!0);for(var f=a.colNum||a.dayNum,h=a.shiftDay||a.dayNum,i=a.daySet,j=[],n=[],k=0;k<h;k++)n.push(0);for(var g=g.getStartDateInWeek(a.daySet[c*h],a).format("Y-m-d"),m=a.startColIndex,o=a.endColIndex,k=0;k<f;k++){var l=c*h+k+m,l=i[l],p=l.format("Y-m-d"),l=d[p];e||(l=this.getLayout(p,a,l||[],!0),l=l.reLayout(),l=l.wlist.concat(l.elist));for(var p=0,q=l.length;p<q;p++){var s=
Ext.apply({},l[p]),r=Ext.ux.calendar.Mask.getDayOffset(g<s.day?s.day:g,s.eday),r=k+r;r>=f&&(r=f-1);this.insert2Table(j,k,r,s,n,a.lineNum)}}for(k=0;k<m;k++)l=c*h+k,l=i[l],p=l.format("Y-m-d"),l=d[p],e||(l=this.getLayout(p,a,l||[],!0),l=l.reLayout(),l.wlist.concat(l.elist));for(k=o;k<a.dayNum;k++)l=c*h+k,l=i[l],p=l.format("Y-m-d"),l=d[p],e||(l=this.getLayout(p,a,l||[],!0),l=l.reLayout(),l.wlist.concat(l.elist));this.checkMore(a,n,j);if((c=this.generateTR(a,j,c))&&0<c.length){if(b.insertAdjacentHTML&&
!Ext.isIE)c=c.join(""),b.insertAdjacentHTML("beforeEnd",c);else{p=0;for(q=c.length;p<q;p++)Ext.DomHelper.append(b,c[p])}this.bindEvent2Table(a,j,b)}},insert2Table:function(a,b,c,d,e,g){for(var f=!1,h,i=0,j=a.length;i<j;i++){h=a[i];for(var f=!0,n=b;n<=c;n++)if(h[n]){f=!1;break}if(f)break}if(!f)if(!g||a.length<g)h={},a.push(h),f=!0;else for(n=b;n<=c;n++)e[n]++;if(f){a=c-b+1;for(n=b;n<=c;n++)h[n]={span:a,event:d}}return f},checkMore:function(a,b,c){if(0<c.length)for(var a=a.colNum||a.dayNum,d=c[c.length-
1],e=0;e<a;){var g=d[e];if(g){for(var g=g.span,f=!1,h=0;h<g;h++)if(0<b[e+h]){f=!0;break}if(f)for(h=0;h<g;h++){var f=e+h,i=d[f];i.span=1;i.event=0>=b[f]?1:b[f]+1}e+=g}else 0<b[e]&&(d[e]={span:1,event:b[e]}),e++}return c},generateTR:function(a,b,c){for(var d=this.ehandler,e=d.lang.EventHandler,g=a.colNum||a.dayNum,f=a.shiftDay,h=a.daySet,i=a.startColIndex,j=[],n=b.length,k=0;k<n;k++){for(var m=b[k],o="",l=0;l<g;)if(m[l]){var p=m[l].span,q=m[l].event,q="number"==Ext.type(q)?'<div class="x-event-more-ct"><u><b name="'+
h[c*f+l+i].format("Y-m-d")+'" class="x-event-more">&nbsp;&nbsp;&nbsp;&nbsp;'+q+" "+e.more+"...</b></u></div>":d.generateLegend(a,q);o+='<td colspan="'+p+'">'+q+"</td>";l+=p}else o+="<td></td>",l++;o="<tr>"+o+"</tr>";j.push(o)}if(0<j.length)return j},bindEvent2Table:function(a,b,c){for(var d=a.colNum||a.dayNum,e=b.length,g=0;g<e;g++)for(var f=b[g],h=0;h<d;)if(f[h]){for(var i=f[h].span,j=f[h].event,n=Ext.DomQuery.select("div[name=x-event-"+j.day+"-"+j.eday+"-"+j.eventId+"]",c),k=0,m=n.length;k<m;k++){var o=
Ext.get(n[k]);o.bindEvent=j;o.cview=a}h+=i}else h++}});Ext.ns("Ext.ux.calendar");Ext.ux.calendar.LayoutGrid=function(a){Ext.apply(this,a);this.CALENDAR_ROW_NUM=this.ehandler.rowCount;this.blockId=0;this.grid=[];this.wholeList=[];this.heventList=[];this.hwholeList=[];this.visited={};this.crossVisited={}};
Ext.ux.calendar.LayoutGrid.prototype={getAllEvents:function(){var a=this.getEventList();return a=this.owner.getWholeList(this.cview,this.day,!0,!0).concat(a)},getEventList:function(){for(var a=[],b=-1,c=0;c<this.CALENDAR_ROW_NUM;c++){var d=this.grid[c];if(-1==b){if(null!=d.block)b=d.block.id,a=a.concat(d.block.eventList)}else if(null!=d.block&&b!=d.block.id)b=d.block.id,a=a.concat(d.block.eventList)}return a},removeOutDeletedCalendar:function(a){var b=this.ehandler,c,d,e=[];c=0;for(d=this.heventList.length;c<
d;c++){var g=this.heventList[c];b.calendarSet[g.calendarId]&&e.push(g)}this.heventList=e;e=[];c=0;for(d=a.length;c<d;c++)g=a[c],b.calendarSet[g.calendarId]&&e.push(g);return e},refreshRepeatEvent:function(a){var b,c,d=[];b=0;for(c=this.heventList.length;b<c;b++){var e=this.heventList[b];"string"==Ext.type(e.repeatType)&&d.push(e)}this.heventList=d;d=[];b=0;for(c=a.length;b<c;b++)e=a[b],"string"==Ext.type(e.repeatType)&&d.push(e);return d=this.owner.combine2List(this.owner.getRepeatEvent(this.cview,
this.day),d)},filterEvent:function(a){var b=this.ehandler,c=[],d=[],e,g;if(this.deleteCalendar)this.deleteCalendar=!1,a=this.removeOutDeletedCalendar(a);if(this.hideCalendar){this.hideCalendar=!1;e=0;for(g=this.heventList.length;e<g;e++){var f=this.heventList[e];b.calendarSet[f.calendarId].hide?d.push(f):c.push(f)}this.heventList=d;d=[];e=0;for(g=a.length;e<g;e++)f=a[e],b.calendarSet[f.calendarId].hide?this.heventList.push(f):d.push(f);a=this.owner.combine2List(d,c);a=this.refreshRepeatEvent(a)}if(this.updateRepeat)this.updateRepeat=
!1,a=this.refreshRepeatEvent(a);return a},reLayout:function(a,b){return this.generateLayout(this.getEventList(),!0,a,b)},increaseLine:function(a,b,c){for(;c>a.areaList.length;)a.areaList[a.areaList.length]=null;a.areaList[a.areaList.length]=b},addArea:function(a,b,c){a.areaList.length<c+1?this.increaseLine(a,b,c):a.areaList[c]=b},generateArea:function(a,b,c){for(var d=a.startRow;d<a.endRow;d++){var e=this.grid[d];e.block=b;this.addArea(e,a,c)}},getColIndex:function(a){var b,c;b=0;for(c=a.areaList.length;b<
c;b++)if(null==a.areaList[b])break;return b},generateLayout:function(a,b,c,d){var e=[],g=[];if(!b)this.heventList=[];e=a;d||(g=this.owner.getWholeList(this.cview,this.day,null,c));e=this.filterEvent(e);if(this.layouted)this.visited[this.cview.id]=!0;else{this.visited={};this.cview&&(this.visited[this.cview.id]=!0);this.layouted=!0;for(a=0;a<this.CALENDAR_ROW_NUM;a++)this.grid[a]=new Ext.ux.calendar.Line;this.blockId=0;e=this.Layouting(e)}this.inited=!0;return{elist:e,wlist:g}},Layouting:function(a){for(var b=
this.ehandler,c=[],d=null,e=0,g=a.length;e<g;e++){var f=a[e],h=this.grid[f.startRow],i=this.getColIndex(h);if(f.colIndex!=i)f.colIndex=i,f.changed=!0;if(0==h.areaList.length)d=new Ext.ux.calendar.Block,d.id=this.blockId++;else if(null!=d&&d.colNum<i)d.colNum=i;h.block=d;c[c.length]=new Ext.ux.calendar.BlockMap(f,d);d.addEvent(f);this.generateArea(f,d,i)}e=0;for(g=c.length;e<g;e++)if(f=c[e],d=f.block.colNum+1,d!=f.event.span)f.event.span=d,f.event.changed=!0;g=[];e=0;for(c=a.length;e<c;e++)f=a[e],
b.calendarSet[f.calendarId].hide||(g[g.length]=f);a=g;b={};e=0;for(c=a.length;e<c;e++){f=a[e];h=f.startRow;for(g=f.endRow;h<g;h++)b[h]?b[h].colIndex<f.colIndex&&(b[h]=f):b[h]=f}e=0;for(c=a.length;e<c;e++){f=a[e];h=f.startRow;g=f.endRow;for(d=!0;h<g;h++)if(b[h]&&f.colIndex<b[h].colIndex&&b[h].startRow>=f.startRow){d=!1;break}if(!0===d){if(!0!==f.last)f.last=!0,f.changed=!0}else{if(!0===f.last)f.changed=!0;delete f.last}}return a},updateLayout:function(a,b,c){this.visited={};this.visited[this.cview.id]=
!0;if(0==a.startRow&&this.CALENDAR_ROW_NUM==a.endRow||a.day!=a.eday)return this.owner.updateWholeList([a],b),this.owner.getWholeList(this.cview,this.day);else{var d=[],e=a.startRow,g=a.endRow,f,h,i=-1;f=0;for(h=this.grid.length;f<h;f++){var j=this.grid[f];if(i==-1)for(var n=0,k=j.areaList.length;n<k;n++){var m=j.areaList[n];null!=m&&m.eventId==a.eventId&&(i=n,e>f&&(e=f),g<f+1&&(g=f+1))}else if(j.areaList.length>i)if(null!=j.areaList[i])j.areaList[i].eventId==a.eventId&&g<f+1&&(g=f+1);else break;else break}h=
-1;for(f=e;f<g;f++)if(j=this.grid[f],-1==h){if(null!=j.block)h=j.block.id,d=d.concat(j.block.eventList)}else if(null!=j.block&&h!=j.block.id)h=j.block.id,d=d.concat(j.block.eventList);if(b=="update"||b=="delete"){f=0;for(h=d.length;f<h;f++)if(j=d[f],a.eventId==j.eventId){if("update"==b&&!0!==c&&a.startRow==j.startRow&&a.endRow==j.endRow)return Ext.apply(j,a),{elist:[a]};d.splice(f,1);break}}if(b=="update"||b=="add"){f=0;for(h=d.length;f<h;f++)if(b=d[f].startRow,c=d[f].endRow,b>a.startRow){d.splice(f,
0,a);break}else if(b==a.startRow&&c<=a.endRow){d.splice(f,0,a);break}f==h&&(d[d.length]=a)}if(d[0]&&e>d[0].startRow)e=d[0].startRow;if(null!=this.grid[g-1].block&&g<this.grid[g-1].block.endRow)g=this.grid[g-1].block.endRow;for(f=e;f<g;f++){if(this.grid[f].areaList.length>0)this.grid[f].areaList.length=0;this.grid[f].block=null}f=0;for(h=d.length;f<h;f++)d[f].changed=!1;a.changed=!0;d=this.Layouting(d);e=[];f=0;for(h=d.length;f<h;f++)a=d[f],a.changed==!0&&e.push(a);return{elist:e}}}};Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.Line=function(a){var b={areaList:[],block:null};Ext.apply(b,a);return b};Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.MainPanel=function(a){Ext.apply(this,a);this.datasource=this.datasource||new Ext.ux.calendar.DataSource;this.datasource.mainPanel=this;this.commentTip=new Ext.ux.calendar.CommentTip;this.ehandler=new Ext.ux.calendar.EventHandler({ds:this.datasource,mainPanel:this,commentTip:this.commentTip,calendarSetting:this.calendarSetting,lang:this.lang});this.editor=new Ext.ux.calendar.Editor({ehandler:this.ehandler});this.ceditor=new Ext.ux.calendar.CalendarEditor({ehandler:this.ehandler});this.ehandler.editor=
this.editor;this.ehandler.ceditor=this.ceditor;this.westPanel=new Ext.ux.calendar.WestPanel({ehandler:this.ehandler});this.calendarContainer=new Ext.ux.calendar.CalendarContainer({ehandler:this.ehandler});this.backthread=new Ext.ux.calendar.BackThread({ehandler:this.ehandler});Ext.ux.calendar.MainPanel.superclass.constructor.call(this,{border:!1,layout:"border",items:[this.westPanel,this.calendarContainer]});this.ehandler.on("calendarloaded",this.calendarContainer.onCalendarLoadedFn,this.calendarContainer);
this.on("afterrender",this.onAfterRenderFn,this);this.on("destroy",this.onDestroyFn,this);this.westPanel.relayEvents(this.calendarContainer,["changedate"]);this.relayEvents(this.calendarContainer,["beforeremoteload","remoteload"]);this.calendarContainer.relayEvents(this.editor,["showdetailsetting"]);this.editor.relayEvents(this.calendarContainer,["hideeditor"]);this.on("beforeremoteload",this._onBeforeRemoteLoadFn,this);this.on("remoteload",this._onRemoteLoadFn,this,{delay:500})};
Ext.extend(Ext.ux.calendar.MainPanel,Ext.Panel,{_onBeforeRemoteLoadFn:function(){this.loadMask.show()},_onRemoteLoadFn:function(){this.loadMask.hide()},onAfterRenderFn:function(a){this.calendarContainer.relayEvents(a.body,["mousedown"]);this.editor.render(a.body);this.loadMask=new Ext.LoadMask(a.body,{msg:this.lang.MainPanel["loadMask.msg"]})},onDestroyFn:function(){this.backthread.destroy()}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.MonthView=Ext.extend(Ext.ux.calendar.BasicView,{legendHeight:17,border:!1,dayFormat:"m/d",templateRowNum:6,weekNum:5,dayNum:7,rowNum:6,colNum:7,menuAlign:"tr-br?",poolDepth:0,leftWidth:25,showMenu:function(a){if(this.menu)this.menu.bindEl=a,this.menu.show(Ext.get(a.dom.parentNode),this.menuAlign);return this},hideMenu:function(){this.menu&&this.menu.hide();return this},initMenu:function(){var a=this.ehandler.lang.MonthView;this.addItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-new",
text:a["addItem.text"],handler:this.onAddFn,scope:this});this.clearItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-clear_event",text:a["clearItem.text"],handler:this.onClearFn,scope:this});this.cutItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-cut",text:a["cutItem.text"],handler:this.onCutFn,scope:this});this.copyItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-copy",text:a["copyItem.text"],handler:this.onCopyFn,scope:this});this.pasteItem=new Ext.menu.Item({iconCls:"icon-sys-calendar-paste",
text:a["pasteItem.text"],handler:this.onPasteFn,scope:this});this.menu=new Ext.menu.Menu({items:[this.addItem,this.clearItem,"-",this.cutItem,this.copyItem,this.pasteItem]});this.menu=Ext.menu.MenuMgr.get(this.menu)},getCellIndex:function(a){var a=a.toString().split("-"),b=a.length,c=a[b-1];return{x:parseInt(a[b-2]),y:parseInt(c)}},generateHTML:function(){this.generateCSS();this.viewerTpl=new Ext.XTemplate('<div id="'+this.id+'-x-monthview-viewer"><table width="100%" cellspacing="0" cellpadding="0" border="0" unselectable="on" onselectstart="return false;"><tbody><tr><td class="x-monthview-lefter"><div id="'+
this.id+'-x-monthview-lefter"><tpl for="."><div class="x-monthview-lefter-inner '+this.id+'-x-monthview-row"><u><b id="'+this.id+'-x-monthview-week-{idx}-0" class="x-monthview-lefter-inner-b">{week}</b></u></div></tpl></div></td><td class="x-monthview-port-td"><div id="'+this.id+'-x-monthview-port" class="x-monthview-port"><tpl for="."><div class="'+this.id+'-x-monthview-row x-monthview-row" unselectable="on"><table class="x-monthview-bg" width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><tpl for="arr"><td id="'+
this.id+'-x-monthview-viewer-{parent.idx}-{idx}" class="'+this.id+'-x-monthview-viewer-col-{idx} x-monthview-viewer-cell">&nbsp;</td></tpl></tr></tbody></table><table id="'+this.id+'-x-monthview-ct-{idx}" class="x-monthview-ct" width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><tpl for="arr"><td id="'+this.id+'-x-monthview-viewer-title-{parent.idx}-{idx}" class="'+this.id+'-x-monthview-viewer-col-{idx} x-monthview-viewer-title"><div><table width="100%" height="100%" border="0"><tbody><tr><td><u id="'+
this.id+'-x-monthview-viewer-link-{parent.idx}-{idx}" class="x-monthview-viewer-link"><b class="x-monthview-viewer-link-b">{day}</b></u></td>'+(this.ehandler.readOnly?"":'<td class="x-monthview-viewer-tool"><img id="'+this.id+'-x-monthview-tool-add-{parent.idx}-{idx}" class="x-monthview-tool-add" src="'+Ext.BLANK_IMAGE_URL+'"></img><img id="'+this.id+'-x-monthview-tool-drop-{parent.idx}-{idx}" class="x-monthview-tool-drop" src="'+Ext.BLANK_IMAGE_URL+'"></img></td>')+"</tr></tbody></table></div></td></tpl></tr></tbody></table></div></tpl></div></div></td></tr></tbody></table>");
this.viewerTpl.compile();for(var a=[],b=this.daySet[0],c=b.getWeekOfYear(),d=0;d<this.templateRowNum;d++){for(var e=[],g=0;g<this.dayNum;g++)e[e.length]={idx:g,day:b.add(Date.DAY,d*this.dayNum+g).format(this.dayFormat)};g=(c+d)%53;0==g&&(g=53);a[a.length]={idx:d,week:g,arr:e}}a=this.viewerTpl.apply(a);b="";for(g=0;g<this.dayNum;g++)b+='<td class="'+this.id+"-x-monthview-viewer-col-"+g+' x-dayview-header-days"><div><b style="line-height:15px;">'+this.ehandler.lang.MonthView.dayPre+this.daySet[g].format("l")+
"</b></div></td>";return'<div id="'+this.id+'-x-monthview-header" class="x-monthview-header" unselectable="on"><table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr>'+b+"</tr></tbody></table></div>"+a},generateCSS:function(){for(var a="."+this.id+"-x-monthview-viewer-row-height{}."+this.id+"-x-monthview-row{}."+this.id+"-x-monthview-viewer-list{}",b=0;b<this.dayNum;b++)a+="."+this.id+"-x-monthview-viewer-col-"+b+"{}";b=Ext.id();this.ss=Ext.util.CSS.createStyleSheet(a,
b)},setToday:function(){var a=this.daySet[0],b=a.format("n");1!=a.format("j")&&(b=(b+1)%12,0==b&&(b=12));for(var a=(new Date).format("Y-m-d"),c=0,d=this.daySet.length;c<d;c++){var e=this.daySet[c].format("Y-m-d"),g=this.daySet[c].format("n");e==a?(e=Math.floor(c/this.dayNum),g=c%this.dayNum,(e=Ext.get(this.id+"-x-monthview-viewer-title-"+e+"-"+g))&&e.setStyle("background-color","rgb(255,255,200)")):b!=g?(e=Math.floor(c/this.dayNum),g=c%this.dayNum,(e=Ext.get(this.id+"-x-monthview-viewer-title-"+e+
"-"+g))&&e.setStyle("background-color","rgb(235,235,235)")):(e=Math.floor(c/this.dayNum),g=c%this.dayNum,(e=Ext.get(this.id+"-x-monthview-viewer-title-"+e+"-"+g))&&e.setStyle("background-color","rgb(241,244,250)"))}},getStartDate:function(a){if(1==this.startDay)var b=a.format("N"),a=a.add(Date.DAY,1-b);else b=a.format("w"),a=a.add(Date.DAY,-b);return a},initComponent:function(){this.id=Ext.id();this.ehandler.applyCalendarSetting(this);var a=(new Date).getFirstDateOfMonth();this.recalculateWeek(a);
a=this.getStartDate(a);this.daySet=[];for(var b=0;b<this.weekNum;b++)for(var c=0;c<this.dayNum;c++)this.daySet[this.daySet.length]=a.add(Date.DAY,b*this.shiftDay+c);this.html=this.generateHTML();this.initMenu();Ext.ux.calendar.MonthView.superclass.initComponent.call(this);this.addEvents("checklayout","afterresize","beforeremoteload","remoteload","canceldetail","viewDay","viewWeek");this.on("checklayout",this.checkLayout,this);this.on("canceldetail",this.onCancelDetailFn,this);this.on("afterrender",
this._onAfterRenderFn,this);this.on("afterlayout",this._onReSizingFn,this);this.on("bodyresize",this._onReSizingFn,this);this.on("sizechanged",this.onSizeChangedFn,this,{buffer:50});Ext.EventManager.on(document,"mouseup",this._onMouseUpFn,this)},_onAfterRenderFn:function(){this.initEls()},_onReSizingFn:function(){this.fireEvent("sizechanged")},onSizeChangedFn:function(){this.handleResize(this.body.getWidth(),this.body.getHeight())},onCancelDetailFn:function(){if(this.detailing)this.detailing=!1,this.detailCt.setStyle("display",
"none")},resetSCover:function(){delete this.startPos;delete this.endPos;this.hideSCovers()},_onMouseUpFn:function(){if(!this.dragging&&this.startPos){var a=Ext.apply({},this.startPos),b=Ext.apply({},this.endPos);this.startPos=null;var c=this.ehandler;this.colNum!=this.shiftDay&&1!=c.startDay&&(a.y++,b.y++);c.prepareLegend(Ext.get(this.id+"-x-monthview-viewer-title-"+b.x+"-"+b.y),a,b,this)}},getMinMaxFromStartEnd:function(a,b){var c=a.x,d=a.y,e=b.x,g=b.y;return c<e||c==e&&d<=g?{minPos:a,maxPos:b}:
{minPos:b,maxPos:a}},hideSCovers:function(){for(var a=0,b=this.scovers.length;a<b;a++)this.scovers[a].dom.style.display="none"},selectRange:function(a,b){this.hideSCovers();a?this.startPos=a:a=this.startPos;this.endPos=b;var c=this.getMinMaxFromStartEnd(a,b),d=c.minPos.x,e=c.minPos.y,g=c.maxPos.x,c=c.maxPos.y,f=this.cw,h=this.ch,i,j=Math.floor(f*e);if(d==g)i=this.scovers[d],i.dom.style.display="",i.setWidth(f*(c-e+1)),i.setHeight(h),i.setLeft(j+"px");else{i=this.scovers[d];i.dom.style.display="";
e=f*(this.colNum-e);i.setWidth(e);i.setHeight(h);i.setLeft(j+"px");for(d+=1;d<g;d++)i=this.scovers[d],i.dom.style.display="",e=f*this.colNum,i.setWidth(e),i.setHeight(h),i.setLeft("0px");i=this.scovers[g];i.dom.style.display="";i.setWidth(f*(c+1));i.setHeight(h);i.setLeft("0px")}},calculatePos:function(a){var b=a.getXY(),c=this.port.getXY(),a=Math.floor((b[0]-c[0])/this.cw),b=Math.floor((b[1]-c[1])/this.ch);0>b?b=0:b>=this.weekNum&&(b=this.weekNum-1,a=this.colNum-1);0>a?a=0:a>=this.colNum&&(a=this.colNum-
1);return{x:b,y:a}},getIndexFromDay:function(a){for(var b=0,c=this.daySet.length;b<c;b++)if(a==this.daySet[b].format("Y-m-d"))return b},alignDetailCt:function(){if(this.detailing){var a=this.detailing.x,b=this.detailing.y,c=this.detailing.events;this.detailCt.setStyle("display","");var d=Ext.get(this.id+"-x-monthview-viewer-title-"+a+"-"+b),a=Ext.get(this.id+"-x-monthview-viewer-"+a+"-"+b),e=this.detailTitle.getHeight()+this.detailFoot.getHeight()+20,b=c.length*17,g=this.port.getBottom()-d.getTop()-
e,f=a.getBottom()-this.port.getTop()-e,h=this.port.getRight()-d.getRight(),e="t",i=g,c=[0,0],j=a.getWidth();200<j?this.detailCt.setWidth(j):this.detailCt.setWidth(200);g>b?this.detailViewer.setStyle("height",""):f>b?(e="b",d=a,c[1]=-4,this.detailViewer.setStyle("height","")):(f>g&&(e="b",i=f,d=a,c[1]=-4),this.detailViewer.setHeight(i));h<this.detailCt.getWidth()?(a="r",c[0]=-1):a="l";a=e+a;this.detailCt.alignTo(d,a+"-"+a,c)}},showDetails:function(a){var b=this.ehandler,c=b.lang.MonthView,d=b.calendarLayout.getLayout(a,
this).reLayout(!0),d=d.wlist.concat(d.elist),e=this.getIndexFromDay(a),g=Math.floor(e/this.dayNum);e%=this.dayNum;this.detailing={x:g,y:e,events:d};this.detailTitle.dom.innerHTML='<u id="'+Ext.id()+"-x-monthview-viewer-link-"+g+"-"+e+'" class="x-monthview-viewer-link"><b class="x-monthview-viewer-link-b">'+a+"</b></u>";this.detailFoot.dom.innerHTML=d.length+" "+c.events;b.bindEvent2Detail(this,d,this.detailViewer);this.alignDetailCt()},_onPortMouseDownFn:function(a){a.stopEvent();this.fireEvent("hideeditor");
var b=a.getTarget(),b=Ext.get(b);if(b.hasClass("x-event-more"))this.showDetails(b.dom.getAttribute("name"));else{if(this.detailing)if(!b.hasClass("x-event-detail-ct")&&!b.parent(".x-event-detail-ct"))this.fireEvent("canceldetail");else return;if(!this.createByDblclick&&!this.ehandler.readOnly&&!b.hasClass("x-monthview-tool-drop")&&!b.hasClass("x-monthview-viewer-link-b")&&!(b.hasClass("x-calendar-event")?b:b.parent(".x-calendar-event")))a=this.calculatePos(a),0<=a.x&&0<=a.y&&this.selectRange(a,a)}},
_onPortMouseMoveFn:function(a){0==a.button?this.startPos&&(a=this.calculatePos(a),0<=a.x&&0<=a.y&&this.selectRange(null,a)):this.resetSCover()},initEls:function(){this.lefter=Ext.get(this.id+"-x-monthview-lefter");this.viewer=Ext.get(this.id+"-x-monthview-viewer");this.port=Ext.get(this.id+"-x-monthview-port");this.cheader=Ext.get(this.id+"-x-monthview-header");this.lefter.un("click",this._onLefterClickFn,this);this.lefter.on("click",this._onLefterClickFn,this);this.port.un("click",this._onPortClickFn,
this);this.port.on("click",this._onPortClickFn,this);this.port.un("mousedown",this._onPortMouseDownFn,this);this.port.on("mousedown",this._onPortMouseDownFn,this);this.ehandler.readOnly||(this.port.un("mousemove",this._onPortMouseMoveFn,this),this.port.un("mouseover",this._onPortMouseOverFn,this),this.port.un("contextmenu",this._onPortContextMenuFn,this),this.port.un("dblclick",this._onPortDblclickFn,this),this.port.on("mousemove",this._onPortMouseMoveFn,this),this.port.on("contextmenu",this._onPortContextMenuFn,
this),this.port.on("mouseover",this._onPortMouseOverFn,this),this.port.on("dblclick",this._onPortDblclickFn,this),this.initDragZone(this.port));this.initDetailCt();this.initSelectCover();this.setToday()},_onLefterClickFn:function(a){a.stopEvent();a=a.getTarget();a=Ext.get(a);if(a.hasClass("x-monthview-lefter-inner-b"))a=this.getCellIndex(a.dom.id).x,this.fireEvent("viewWeek",this.daySet[a*this.shiftDay],this.daySet[(a+1)*this.shiftDay-1])},_onPortDblclickFn:function(a){a.stopEvent();var b=a.getTarget(),
b=Ext.get(b);b.hasClass("x-calendar-event")||(b=b.parent(".x-calendar-event"));b?b&&!b.bindEvent.locked&&this.ehandler.showEditor(b,this,"update"):this.createByDblclick&&this.addLegend(this.calculatePos(a))},_onPortContextMenuFn:function(a){a.stopEvent();var b=a.getTarget(),b=Ext.get(b);(b=b.hasClass("x-calendar-event")?b:b.parent(".x-calendar-event"))&&this.ehandler.showContextMenu(a,b)},_onPortMouseOverFn:function(a){if(!this.detailing&&(a=a.getTarget(),a=Ext.get(a),this.overEl&&(this.overEl.removeClass("x-tool-btn-over"),
delete this.overEl),a.hasClass("x-monthview-tool-drop")||a.hasClass("x-monthview-tool-add")))a.addClass("x-tool-btn-over"),this.overEl=a},addLegend:function(a){var b=this.ehandler,c=Ext.apply({},a);this.selectRange(a,c);this.startPos=null;b.prepareLegend(Ext.get(this.id+"-x-monthview-viewer-title-"+a.x+"-"+a.y),a,c,this)},_onPortClickFn:function(a){var b=this.ehandler,a=a.getTarget(),a=Ext.get(a),c;if(a.hasClass("x-event-detail-tool-close"))this.fireEvent("canceldetail");else if(a.hasClass("x-monthview-viewer-link-b"))b=
this.getCellIndex(a.dom.parentNode.id),this.fireEvent("viewDay",this,this.daySet[b.x*this.dayNum+b.y]);else if(!b.readOnly)if(a.hasClass("x-monthview-tool-add"))this.addLegend(this.getCellIndex(a.dom.id));else if(a.hasClass("x-monthview-tool-drop"))this.showMenu(a);else if(c=a.hasClass("x-whole-title-b")?a:a.parent(".x-whole-title-b"))(a=c.parent(".x-whole-cover"))&&!a.bindEvent.locked&&b.showEditor(a,this,"update");else if(c=a.hasClass("x-legend-title-b")?a:a.parent(".x-legend-title-b"))(a=c.parent(".x-legend-cover"))&&
!a.bindEvent.locked&&b.showEditor(a,this,"update")},initDetailCt:function(){var a=this.ehandler.detailTpl.apply({});this.detailCt=Ext.DomHelper.append(this.port,a,!0);this.detailCt.setStyle("display","none");this.detailTitle=this.detailCt.child(".x-event-detail-title-td");this.detailViewer=this.detailCt.child(".x-event-detail-viewer");this.detailFoot=this.detailCt.child(".x-event-detail-foot-text")},initSelectCover:function(){this.scovers=[];for(var a=0,b=this.templateRowNum;a<b;a++){var c=document.createElement("div");
c.className="x-event-select-cover";c=Ext.get(c);Ext.get(this.port.dom.childNodes[a]).appendChild(c);this.scovers[this.scovers.length]=c}},initDragZone:function(a){var b=new Ext.dd.StatusProxy({dropNotAllowed:"x-dd-drop-ok"});a.dragzone=new Ext.dd.DragZone(a,{ddGroup:"x-mycalendar",proxy:b,cview:this,onStartDrag:function(){this.cview.dragging=!0;(function(){for(var a=this.dragData.bindEvent,a=Ext.DomQuery.select("div[name=x-event-"+a.day+"-"+a.eday+"-"+a.eventId+"]",this.cview.body.dom),b=0,e=a.length;b<
e;b++)Ext.get(a[b]).setOpacity(0.3)}).defer(1,this)},getDragData:function(a){var a=a.getTarget(),b=Ext.get(a);b.hasClass("x-calendar-event")||(b=b.parent(".x-calendar-event"));if(b&&(a=b.bindEvent,!a.locked)){var e=b.dom.cloneNode(!0),b=b.getWidth();e.style.width=200<b?"200px":b+"px";return{ddel:e,bindEvent:a}}return!1},getRepairXY:function(){return null},onDrag:function(a){var b=this.dragData.bindEvent,e=this.cview,b=Ext.ux.calendar.Mask.getDayOffset(b.day,b.eday),a=e.calculatePos(a),b=e.addSpan2Pos(a,
b);e.selectRange(a,b)},endDrag:function(){var a=this.cview,b=this.dragData.bindEvent,e=Ext.apply({},b),g;if(b.day==b.eday&&(0!=b.startRow||a.rowCount!=b.endRow))g=Ext.apply({},b);var f=a.startPos,h=a.ehandler,i=Ext.ux.calendar.Mask.getDayOffset(b.day,b.eday);a.colNum!=a.shiftDay&&1!=h.startDay&&f.y++;var f=a.daySet[f.x*a.shiftDay+f.y],j=f.format("Y-m-d");if(b.day!=j)b.eday=f.add(Date.DAY,i).format("Y-m-d"),b.day=j,"string"==Ext.type(b.repeatType)?h.updateEvent(b,a,null,g):(b.repeatType="exception",
h.updateRepeatEvent(b,a,e));else{b=Ext.DomQuery.select("div[name=x-event-"+b.day+"-"+b.eday+"-"+b.eventId+"]",this.cview.body.dom);e=0;for(g=b.length;e<g;e++)Ext.get(b[e]).setOpacity(1)}a.dragging=!1;a.resetSCover();a.fireEvent("canceldetail")}})},addSpan2Pos:function(a,b){var c=Ext.apply({},a);c.y+=b;var d=Math.floor(c.y/this.dayNum);c.y%=this.shiftDay;c.x+=d;if(c.x>=this.weekNum)c.x=this.weekNum-1,c.y=this.colNum-1;if(c.y>=this.colNum)c.y=this.colNum-1;return c},viewWeekend:function(a){1==this.startDay?
(Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-6","display",a),Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-5","display",a)):(Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-0","display",a),Ext.util.CSS.updateRule("."+this.id+"-x-monthview-viewer-col-6","display",a))},recalculateSize:function(a,b){if(typeof a=="number")this.cheader.setWidth(a),a-=this.leftWidth,this.port.setWidth(a),7==this.colNum?this.viewWeekend(""):5==this.colNum&&this.viewWeekend("none"),
this.cw=a/this.colNum;if(typeof b=="number"){this.ch=(b-this.cheader.getHeight())/this.rowNum;var c=Ext.get(this.id+"-x-monthview-viewer-title-0-1").getHeight();this.lineNum=Math.floor((this.ch-c)/this.legendHeight);Ext.util.CSS.updateRule("."+this.id+"-x-monthview-row","height",Math.ceil(this.ch)+"px")}},handleResize:function(a,b){var c=this.lineNum;this.recalculateSize(a,b);c!=this.lineNum&&this.showCache();this.alignDetailCt();this.fireEvent("afterresize",this,a,b)},checkCSHide:function(a){var b=
this.ehandler.calendarSet,c=!1,d;for(d in b){var e=b[d],g=a[d];if(e&&g&&!1===e.hide&&!1!==g.hide){c=!0;break}}return c},showCache:function(a,b,c,d){c=this.ehandler;a=a||this.daySet[0];b=b||this.daySet[this.daySet.length-1];if(c.isInDayCache(a,b)&&!d){a=c.calendarLayout;b=0;for(d=this.weekNum;b<d;b++){for(var c={},e=0,g=this.dayNum;e<g;e++){var f=this.daySet[b*this.dayNum+e].format("Y-m-d"),h=a.getLayout(f,this).reLayout();c[f]=h.wlist.concat(h.elist)}e=Ext.get(this.id+"-x-monthview-ct-"+b).dom.firstChild;
a.showWeek(this,e,b,c,!0)}return!0}return!1},checkLayout:function(a,b){var c=this.ehandler,d=this.daySet[0],e=this.daySet[this.daySet.length-1];this.showCache(d,e,a,b)||(this.fireEvent("beforeremoteload"),c.ds.loadEvent(d,e,function(a){this.showEvents(a,b);c.pushDayCache(d,e);this.fireEvent("remoteload")},this));this.setToday()},showEvents:function(a){var b=this.ehandler.calendarLayout;b.updateWholeList(a.whole,"add");for(var c=0;c<this.weekNum;c++){var d=Ext.get(this.id+"-x-monthview-ct-"+c).dom.firstChild;
b.showWeek(this,d,c,a)}},onAddFn:function(a){this.addLegend(this.getCellIndex(a.parentMenu.bindEl.dom.id))},onClearFn:function(a){this.clearLegend(this.getCellIndex(a.parentMenu.bindEl.dom.id))},setCutStatus:function(a){var b=a.x,a=a.y,c=Ext.get(this.id+"-x-monthview-viewer-"+b+"-"+a);c&&c.addClass("x-monthview-cell-cut");(b=Ext.get(this.id+"-x-monthview-viewer-title-"+b+"-"+a))&&b.addClass("x-monthview-cell-cut");this.ehandler.commentTip.showTip("Notice","Cross-day event and repeat event can not be cut/copied!",
b,"bl-tl?")},resetCutStatus:function(a){var b=a.x,a=a.y,c=Ext.get(this.id+"-x-monthview-viewer-"+b+"-"+a);c&&c.removeClass("x-monthview-cell-cut");(b=Ext.get(this.id+"-x-monthview-viewer-title-"+b+"-"+a))&&b.removeClass("x-monthview-cell-cut")},onCutFn:function(a){var a=this.getCellIndex(a.parentMenu.bindEl.dom.id),b=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d");this.cpFlag&&this.resetCutStatus(this.cpFlag.pos);this.setCutStatus(a);this.cpFlag={day:b,keep:!1,pos:a}},onCopyFn:function(a){var a=
this.getCellIndex(a.parentMenu.bindEl.dom.id),b=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d");this.cpFlag&&this.resetCutStatus(this.cpFlag.pos);this.setCutStatus(a);this.cpFlag={day:b,keep:!0,pos:a}},onPasteFn:function(a){if(this.cpFlag){var b=this.cpFlag.keep,a=this.getCellIndex(a.parentMenu.bindEl.dom.id),c=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d"),d=this.ehandler,e=this.cpFlag.day;d.ds.changeDay(e,c,function(a){for(var f=d.calendarLayout,h=f.deleteDayFromWholeList(e,e,b),i=f.getLayout(e,
this),j=[],n=i.reLayout(null,!0).elist,k=[],m=0,o=n.length;m<o;m++){var l=n[m];"string"==Ext.type(l.repeatType)?j.push(Ext.apply({},l)):k.push(Ext.apply({},l))}if(a&&a.backids){n=a.backids;m=0;for(o=h.length;m<o;m++)if(l=h[m],n[l.eventId])l.eventId=n[l.eventId];m=0;for(o=j.length;m<o;m++)if(l=j[m],n[l.eventId])l.eventId=n[l.eventId]}m=0;for(o=h.length;m<o;m++)l=h[m],l.day=c,l.eday=c;f.updateWholeList(h,"add");m=0;for(o=j.length;m<o;m++)l=j[m],l.day=c,l.eday=c;h=f.getLayout(c,this);n=h.reLayout(null,
!0).elist;n=f.combine2List(n,j);h.layouted=!1;h.generateLayout(n,!0,null,!0);if(!b)i.layouted=!1,i.generateLayout(k,!0,null,!0);this.checkLayout();d.fireEvent("changeEventCache",d)},this,b);b||(this.resetCutStatus(this.cpFlag.pos),delete this.cpFlag)}},clearLegend:function(a){var b=this.ehandler,c=b.calendarLayout,d=this.daySet[a.x*this.dayNum+a.y].format("Y-m-d");b.ds.deleteDay(d,function(){c.deleteDayFromWholeList(d);var a=c.getLayout(d,this);if(a)a.layouted=!1,a.updateRepeat=!0,a.generateLayout([],
!0,null,!0);this.checkLayout(!0);b.fireEvent("changeEventCache",b)},this)},resizePort:Ext.emptyFn,refreshDate:function(){for(var a=this.daySet[0].getWeekOfYear(),b=0;b<this.weekNum;b++){for(var c=0;c<this.dayNum;c++){var d=Ext.get(this.id+"-x-monthview-viewer-link-"+b+"-"+c);if(d){var e=this.daySet[b*this.dayNum+c].format(this.dayFormat);d.dom.innerHTML='<b class="x-monthview-viewer-link-b">'+e+"</b>"}}c=Ext.get(this.id+"-x-monthview-week-"+b+"-0");d=(a+b)%53;0==d&&(d=53);c.dom.innerHTML=d}},resetView:function(){this.refreshDate();
this.setToday()},cleanup:function(a){var b=function(a){if(a=Ext.get(this.id+"-x-monthview-ct-"+a)){for(var a=a.dom.firstChild,b=[],e=1,g=a.childNodes.length;e<g;e++)b.push(a.childNodes[e]);e=0;for(g=b.length;e<g;e++)Ext.get(b[e]).remove()}}.createDelegate(this);if(!1==Ext.type(a))for(a=0;a<this.templateRowNum;a++)b(a);else b(a)},locateDay:function(a){a=a.getFirstDateOfMonth();this.recalculateWeek(a);this.recalculateSize(this.body.getWidth(),this.body.getHeight());a=this.getStartDate(a);this.daySet=
[];for(var b=0;b<this.weekNum;b++)for(var c=0;c<this.dayNum;c++)this.daySet[this.daySet.length]=a.add(Date.DAY,b*this.shiftDay+c)},showDay:function(a){this.locateDay(a);this.resetView();this.checkLayout(!0)},recalculateWeek:function(a){if(1==this.startDay){var b=a.format("N");this.rowNum=7==b&&30<=a.getDaysInMonth()?6:6==b&&31==a.getDaysInMonth()?6:1==b&&28==a.getDaysInMonth()?4:5}else{var c=a.format("w");this.rowNum=6==c&&30<=a.getDaysInMonth()?6:5==c&&31==a.getDaysInMonth()?6:0==b&&28==a.getDaysInMonth()?
4:5}this.weekNum=this.rowNum},goBack:function(){var a=this.shiftDay||this.dayNum,b=this.dayNum,c=this.daySet[0],d=c.getFirstDateOfMonth();c.format("Y-m-d")==d.format("Y-m-d")&&(d=d.add(Date.DAY,-1),d=d.getFirstDateOfMonth());this.recalculateWeek(d);d=this.getStartDate(d);c=this.weekNum;this.daySet=[];for(var e=0;e<c;e++)for(var g=0;g<b;g++)this.daySet[this.daySet.length]=d.add(Date.DAY,e*a+g);this.resetView();this.recalculateSize(this.body.getWidth(),this.body.getHeight());this.checkLayout(!0)},goNext:function(){var a=
this.shiftDay||this.dayNum,b=this.dayNum,c=this.daySet[this.daySet.length-1],d=c.getLastDateOfMonth(),d=c.format("Y-m-d")==d.format("Y-m-d")?d.add(Date.DAY,1):c.getFirstDateOfMonth();this.recalculateWeek(d);d=this.getStartDate(d);this.daySet=[];for(var c=this.weekNum,e=0;e<c;e++)for(var g=0;g<b;g++)this.daySet[this.daySet.length]=d.add(Date.DAY,e*a+g);this.resetView();this.recalculateSize(this.body.getWidth(),this.body.getHeight());this.checkLayout(!0)},isShift:function(a,b){var c,d=a.format("Y-m-d"),
e=this.daySet[0].format("Y-m-d");c=d<e?e:d;d=b.format("Y-m-d");e=this.daySet[this.daySet.length-1].format("Y-m-d");if(c>(d>e?e:d)){c=a.getFirstDateOfMonth();this.recalculateWeek(c);c=this.getStartDate(c);this.daySet=[];for(d=0;d<this.weekNum;d++)for(e=0;e<this.dayNum;e++)this.daySet[this.daySet.length]=c.add(Date.DAY,d*this.shiftDay+e);return!0}else return!1},showRange:function(a,b){var c=!1;this.isShift(a,b)&&(this.resetView(),c=!0);this.recalculateSize(this.body.getWidth(),this.body.getHeight());
this.checkLayout(c)}});Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.ResultView=function(a){Ext.apply(this,a);this.ehandler.applyCalendarSetting(this);this.pageSize=20;var a=this.ehandler.lang.ResultView,b=this.ehandler.ds.getSearchStore(),c=[{header:"",sortable:!0,menuDisabled:!0,width:20,dataIndex:"calendarId",renderer:this.hiddenRenderFn.createDelegate(this)},{header:"",sortable:!0,menuDisabled:!0,width:20,dataIndex:"locked",renderer:this.lockedRenderFn.createDelegate(this)},{header:a["cm.time"],dataIndex:"ymd",sortable:!0,width:140,renderer:this.fromtoRenderFn.createDelegate(this)},
{header:a["cm.calendar"],sortable:!0,menuDisabled:!0,width:100,dataIndex:"calendarId",renderer:this.calendarRenderFn.createDelegate(this)},{header:a["cm.subject"],sortable:!0,width:120,dataIndex:"subject",renderer:this.subjectRenderFn},{header:a["cm.content"],sortable:!0,width:120,dataIndex:"description",renderer:this.contentRenderFn.createDelegate(this)},{header:a["cm.expire"],sortable:!0,menuDisabled:!0,width:80,renderer:this.expireRenderFn.createDelegate(this)}];this.groupBtn=new Ext.Button({iconCls:"icon-sys-calendar-group",
text:a["groupBtn.group.text"],handler:this.onGroupFn,scope:this});this.returnBtn=new Ext.Button({iconCls:"icon-sys-calendar-door_out",text:a["returnBtn.text"],handler:this.onReturnFn,scope:this});var d=new Ext.PagingToolbar({pageSize:this.pageSize,store:b});d.on("render",this.onPageToolbarRenderFn,this);this.list=new Ext.grid.GridPanel({border:!1,store:b,columns:c,view:new Ext.grid.GroupingView({forceFit:!0}),loadMask:{msg:a["loadMask.msg"]},bbar:d});Ext.ux.calendar.ResultView.superclass.constructor.call(this,
{layout:"fit",items:[this.list]});this.on("render",this.onRenderFn,this);this.list.on("rowdblclick",this.onRowDblClickFn,this);this.list.on("rowclick",this.onRowClickFn,this);b.on("beforeload",this.onBeforeLoadFn,this);b.on("load",this.onLoadFn,this);b.clearGrouping()};
Ext.extend(Ext.ux.calendar.ResultView,Ext.ux.calendar.BasicView,{onBeforeLoadFn:function(a){a.removeAll()},onLoadFn:function(a,b){for(var c=0,d=b.length;c<d;c++){var e=b[c],g=e.data.repeatType;if("no"!=g&&"exception"!=g)e.data.repeatType=Ext.decode(g)}},onGroupFn:function(a){var b=this.ehandler.lang.ResultView,c=this.list.getStore();b["groupBtn.group.text"]==a.getText()?(a.setText(b["groupBtn.unGroup.text"]),a.setIconClass("icon-sys-calendar-ungroup"),c.groupBy("ymd")):(a.setText(b["groupBtn.group.text"]),
a.setIconClass("icon-sys-calendar-group"),c.clearGrouping())},onReturnFn:function(){var a=this.ownerCt;a.getLayout().setActiveItem(a.currentIdx);a.currentView.checkLayout(!0)},onRenderFn:function(a){a.port=a.body},onPageToolbarRenderFn:function(a){a.add("->",this.groupBtn,"-",this.returnBtn)},onRowClickFn:function(a,b,c){var c=c.getTarget(),d=Ext.get(c),c=this.ehandler,a=a.getStore(),b=a.getAt(b),e={eventId:b.data.id,calendarId:b.data.calendarId,startRow:parseInt(b.data.startRow),endRow:parseInt(b.data.endRow),
subject:b.data.subject,content:b.data.description,day:b.data.ymd,eday:b.data.eymd,isShared:b.data.isShared,alertFlag:b.data.alertFlag,repeatType:b.data.repeatType},g=Ext.apply({},e);if(d.hasClass("x-calendar-resultview-lock")){if(d.hasClass("icon-sys-calendar-event_lock"))d.removeClass("icon-sys-calendar-event_lock"),d.addClass("icon-sys-calendar-event_unlock"),b.set("locked",!1),e.locked=!1;else if(d.hasClass("icon-sys-calendar-event_unlock"))d.removeClass("icon-sys-calendar-event_unlock"),d.addClass("icon-sys-calendar-event_lock"),
b.set("locked",!0),e.locked=!0;a.commitChanges();d=this.ownerCt.currentView;"string"==Ext.type(b.data.repeatType)?c.updateEvent(e,d):c.updateRepeatEvent(e,d,g)}},onRowDblClickFn:function(a,b){var c=this.ownerCt.currentView,d=this.ehandler,e=a.getStore(),g=e.getAt(b);if(!g.data.locked){var f=a.getView().getRow(b);if(f)f=Ext.get(f),f.bindEvent={eventId:g.data.id,calendarId:g.data.calendarId,startRow:parseInt(g.data.startRow),endRow:parseInt(g.data.endRow),subject:g.data.subject,content:g.data.description,
day:g.data.ymd,eday:g.data.eymd,isShared:g.data.isShared,alertFlag:g.data.alertFlag,locked:g.data.locked,repeatType:g.data.repeatType},f.cview=c,d.editor.fireEvent("showdetailsetting",{bindEl:f,cview:this,onLayout:function(a){g.set("calendarId",a.calendarId);g.set("subject",a.subject);g.set("description",a.content);g.set("ymd",a.day);g.set("eymd",a.eday);g.set("isShared",a.isShared);g.set("alertFlag",a.alertFlag);g.set("locked",a.locked);g.set("repeatType",a.repeatType);e.commitChanges()},action:"update"})}},
calendarRenderFn:function(a,b,c){a=this.ehandler;c=a.calendarSet[c.data.calendarId];return a.calendarTpl.apply({calendarId:c.id,"legend-style":"height:9px;",title:c.name,color:c.color})},fromtoRenderFn:function(a,b,c){a=c.data;a.startRow=Ext.ux.calendar.Mask.getRowFromHM(c.data.startTime,this.intervalSlot);a.endRow=Ext.ux.calendar.Mask.getRowFromHM(c.data.endTime,this.intervalSlot);a.day=a.ymd;a.eday=a.eymd;return this.ehandler.generateInfo(a)},subjectRenderFn:function(a){a=a||"";if(""==a.trim())a=
this.ehandler.lang.ResultView.noSubject;return a},contentRenderFn:function(a){a=a||"";if(""==a.trim())a=this.ehandler.lang.ResultView.noContent;return a},generateExpireHTML:function(a){var b=this.ehandler.lang.ResultView,a=a.hour,c;-1==a?c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(231,231,231);text-align:center;"><b>Out of date</b></div>':0<=a&&a<=24?c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(249,66,51);text-align:center;"><b>'+
a+" "+b.hour+"</b></div>":24<a&&a<=72?c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(255,255,164);text-align:center;"><b>'+a+" "+b.hour+"</b></div>":72<a&&(c='<div style="border:1px solid silver;height:20px;line-height:20px;background:rgb(147,250,97);text-align:center;"><b>'+a+" "+b.hour+"</b></div>");return c},expireRenderFn:function(a,b,c){a=Ext.ux.calendar.Mask.getRowFromHM(c.data.endTime,this.intervalSlot);c=c.data.ymd+" "+c.data.endTime;b=Date.parseDate(c,
"Y-m-d H:i");this.rowCount==a&&(b=b.add(Date.DAY,1),c=b.format("Y-m-d H:i"));a=b.getElapsed();return(new Date).format("Y-m-d H:i")>=c?this.generateExpireHTML({hour:-1}):this.generateExpireHTML({hour:Math.round(a/36E5)})},hiddenRenderFn:function(a,b,c){return this.ehandler.calendarSet[c.data.calendarId].hide?'<div class="x-resultview-event-hide"></div>':'<div class="x-resultview-event-show"></div>'},lockedRenderFn:function(a,b,c){return c.data.locked?'<div class="x-calendar-resultview-lock icon-sys-calendar-event_lock"></div>':
'<div class="x-calendar-resultview-lock icon-sys-calendar-event_unlock"></div>'},loadEvents:function(a){var b=this.list.getStore();b.removeAll();this.matchText=a;b.baseParams=Ext.apply(b.baseParams,{text:a});b.load({params:{start:0,limit:this.pageSize}})},checkLayout:function(){this.list.getStore().reload()}});Ext.ns("Ext.util");
Ext.util.DatePicker=Ext.extend(Ext.DatePicker,{onRender:function(a,b){Ext.util.DatePicker.superclass.onRender.call(this,a,b)},updateRange:function(){if(this.startDate&&this.endDate){var a=this.startDate.clearTime().getTime(),b=this.endDate.clearTime().getTime();this.cells.each(function(c){var d=c.dom.firstChild.dateValue;a<=d&&d<=b?c.addClass("x-date-selected"):c.removeClass("x-date-selected")})}},setRange:function(a,b){this.startDate=a;this.endDate=b},update:function(a,b){Ext.util.DatePicker.superclass.update.call(this,
a,b);this.updateRange()}});Ext.ns("Ext.util");Ext.util.LabelField=Ext.extend(Ext.form.Field,{onRender:function(a,b){Ext.util.LabelField.superclass.onRender.call(this,a,b);this.wrap=this.el.wrap({cls:this.wrapClass});Ext.isIE&&this.wrap.setHeight(20);this.el.addClass("x-hidden");this.labelEl=Ext.DomHelper.append(this.wrap,'<div style="padding-top:3px;"></div>',!0);this.labelEl.dom.innerHTML=this.text},setText:function(a){this.labelEl?this.labelEl.dom.innerHTML=a:this.text=a},getText:function(){return this.labelEl.dom.innerHTML}});
Ext.ns("Ext.ux.calendar");
Ext.ux.calendar.WestPanel=function(a){Ext.apply(this,a);a=this.ehandler;a.applyCalendarSetting(this);this.ds=a.ds;a=a.lang.WestPanel;this.dateLabel=new Ext.form.Label({html:"<b>"+(new Date).format(this.fromtoFormat)+"</b>"});this.datePicker=new Ext.util.DatePicker({value:new Date,startDay:this.startDay});this.showAllBtn=new Ext.Button({iconCls:"icon-sys-calendar-calendar_show",text:a["myShowAllBtn.text"],handler:this.onShowAllFn,scope:this});this.addBtn=new Ext.Button({iconCls:"icon-sys-calendar-add_calendar",text:a["myAddBtn.text"],
handler:this.onAddFn,scope:this});var b=[this.showAllBtn,"->"];this.readOnly||b.push(this.addBtn);this.myCalendarPanel=new Ext.Panel({style:"padding-top:5px;",region:"center",iconCls:"icon-sys-calendar-calendar",title:a["myCalendarPanel.title"],bodyStyle:"padding:2px;background-color:white;overflow-x:hidden;overflow-y:auto;position:relative;",bbar:b});this.myCalendarPanel.on("render",this.onMyCalendarRenderFn,this);this.formpanel=new Ext.form.FormPanel({border:!1,cls:"x-calendar-container",style:"padding:0px 10px 10px 12px;",
layout:"border",items:[{border:!1,region:"north",height:230,style:"padding:5px 0px 0px 0px;",cls:"x-dayview-west-date-span",items:[this.dateLabel,this.datePicker]},this.myCalendarPanel]});Ext.ux.calendar.WestPanel.superclass.constructor.call(this,{border:!1,cls:"x-calendar-west",collapsible:!0,iconCls:"icon-sys-calendar-calendar",title:"\u65e5\u5386\u9762\u677f",collapseMode:"mini",region:"west",minWidth:200,width:200,layout:"fit",items:[this.formpanel]});this.addEvents("changedate");this.dateLabel.on("render",
this.onDateLabelRenderFn,this);this.datePicker.on("render",this.onDatePickerRenderFn,this);this.datePicker.on("select",this.onSelectFn,this);this.on("changedate",this.changeDateLabel,this)};
Ext.extend(Ext.ux.calendar.WestPanel,Ext.Panel,{onOtherCalendarRenderFn:function(a){this.ehandler.renderSharedCalendar(a.body)},onShowAllFn:function(){this.ehandler.onShowAllFn()},onAddFn:function(){this.ehandler.ceditor.popup({action:"add"})},onSelectFn:function(a,b){this.ownerCt.calendarContainer.showDay(b)},onMyCalendarRenderFn:function(a){this.ehandler.renderOwnedCalendar(a.body)},changeDateLabel:function(a,b){this.updateDateLabel(a,b);this.updateDatePicker(a,b)},updateDateLabel:function(a,b){var c=
b.format(this.fromtoFormat),d=a.format(this.fromtoFormat);d!==c&&(d+=" - "+c);this.dateLabel.getEl().dom.innerHTML="<b>"+d+"</b>"},updateDatePicker:function(a,b){var c=a.format(this.fromtoFormat);this.datePicker.setRange(a,b);if(7<Ext.ux.calendar.Mask.getDayOffset(a,b)){var d=a.getFirstDateOfMonth(),e=d.format("Y-m-d"),c=a.format("Y-m-d");c!=e&&(d=a.getLastDateOfMonth().add(Date.DAY,1));this.datePicker.setValue(d)}else this.datePicker.setValue(a)},onDateLabelRenderFn:function(){var a=this.ownerCt.calendarContainer.currentView;
this.updateDateLabel(a.daySet[0],a.daySet[a.daySet.length-1])},onDatePickerRenderFn:function(){var a=this.ownerCt.calendarContainer.currentView;this.updateDatePicker(a.daySet[0],a.daySet[a.daySet.length-1])}});
